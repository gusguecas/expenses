var us=Object.defineProperty;var pr=e=>{throw TypeError(e)};var xs=(e,t,r)=>t in e?us(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var y=(e,t,r)=>xs(e,typeof t!="symbol"?t+"":t,r),Mt=(e,t,r)=>t.has(e)||pr("Cannot "+r);var u=(e,t,r)=>(Mt(e,t,"read from private field"),r?r.call(e):t.get(e)),v=(e,t,r)=>t.has(e)?pr("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),g=(e,t,r,a)=>(Mt(e,t,"write to private field"),a?a.call(e,r):t.set(e,r),r),_=(e,t,r)=>(Mt(e,t,"access private method"),r);var hr=(e,t,r,a)=>({set _(s){g(e,t,s,r)},get _(){return u(e,t,a)}});import ms from"crypto";var Zr={Stringify:1},B=(e,t)=>{const r=new String(e);return r.isEscaped=!0,r.callbacks=t,r},ps=/[&<>'"]/,Qr=async(e,t)=>{let r="";t||(t=[]);const a=await Promise.all(e);for(let s=a.length-1;r+=a[s],s--,!(s<0);s--){let n=a[s];typeof n=="object"&&t.push(...n.callbacks||[]);const c=n.isEscaped;if(n=await(typeof n=="object"?n.toString():n),typeof n=="object"&&t.push(...n.callbacks||[]),n.isEscaped??c)r+=n;else{const o=[r];pe(n,o),r=o[0]}}return B(r,t)},pe=(e,t)=>{const r=e.search(ps);if(r===-1){t[0]+=e;return}let a,s,n=0;for(s=r;s<e.length;s++){switch(e.charCodeAt(s)){case 34:a="&quot;";break;case 39:a="&#39;";break;case 38:a="&amp;";break;case 60:a="&lt;";break;case 62:a="&gt;";break;default:continue}t[0]+=e.substring(n,s)+a,n=s+1}t[0]+=e.substring(n,s)},ea=e=>{const t=e.callbacks;if(!(t!=null&&t.length))return e;const r=[e],a={};return t.forEach(s=>s({phase:Zr.Stringify,buffer:r,context:a})),r[0]},ta=async(e,t,r,a,s)=>{typeof e=="object"&&!(e instanceof String)&&(e instanceof Promise||(e=e.toString()),e instanceof Promise&&(e=await e));const n=e.callbacks;return n!=null&&n.length?(s?s[0]+=e:s=[e],Promise.all(n.map(o=>o({phase:t,buffer:s,context:a}))).then(o=>Promise.all(o.filter(Boolean).map(d=>ta(d,t,!1,a,s))).then(()=>s[0]))):Promise.resolve(e)},hs=(e,...t)=>{const r=[""];for(let a=0,s=e.length-1;a<s;a++){r[0]+=e[a];const n=Array.isArray(t[a])?t[a].flat(1/0):[t[a]];for(let c=0,o=n.length;c<o;c++){const d=n[c];if(typeof d=="string")pe(d,r);else if(typeof d=="number")r[0]+=d;else{if(typeof d=="boolean"||d===null||d===void 0)continue;if(typeof d=="object"&&d.isEscaped)if(d.callbacks)r.unshift("",d);else{const l=d.toString();l instanceof Promise?r.unshift("",l):r[0]+=l}else d instanceof Promise?r.unshift("",d):pe(d.toString(),r)}}}return r[0]+=e.at(-1),r.length===1?"callbacks"in r?B(ea(B(r[0],r.callbacks))):B(r[0]):Qr(r,r.callbacks)},sr=Symbol("RENDERER"),Jt=Symbol("ERROR_HANDLER"),O=Symbol("STASH"),ra=Symbol("INTERNAL"),bs=Symbol("MEMO"),Rt=Symbol("PERMALINK"),br=e=>(e[ra]=!0,e),aa=e=>({value:t,children:r})=>{if(!r)return;const a={children:[{tag:br(()=>{e.push(t)}),props:{}}]};Array.isArray(r)?a.children.push(...r.flat()):a.children.push(r),a.children.push({tag:br(()=>{e.pop()}),props:{}});const s={tag:"",props:a,type:""};return s[Jt]=n=>{throw e.pop(),n},s},sa=e=>{const t=[e],r=aa(t);return r.values=t,r.Provider=r,Xe.push(r),r},Xe=[],nr=e=>{const t=[e],r=a=>{t.push(a.value);let s;try{s=a.children?(Array.isArray(a.children)?new oa("",{},a.children):a.children).toString():""}finally{t.pop()}return s instanceof Promise?s.then(n=>B(n,n.callbacks)):B(s)};return r.values=t,r.Provider=r,r[sr]=aa(t),Xe.push(r),r},Je=e=>e.values.at(-1),yt={title:[],script:["src"],style:["data-href"],link:["href"],meta:["name","httpEquiv","charset","itemProp"]},qt={},gt="data-precedence",ut=e=>Array.isArray(e)?e:[e],yr=new WeakMap,gr=(e,t,r,a)=>({buffer:s,context:n})=>{if(!s)return;const c=yr.get(n)||{};yr.set(n,c);const o=c[e]||(c[e]=[]);let d=!1;const l=yt[e];if(l.length>0){e:for(const[,f]of o)for(const x of l)if(((f==null?void 0:f[x])??null)===(r==null?void 0:r[x])){d=!0;break e}}if(d?s[0]=s[0].replaceAll(t,""):l.length>0?o.push([t,r,a]):o.unshift([t,r,a]),s[0].indexOf("</head>")!==-1){let f;if(a===void 0)f=o.map(([x])=>x);else{const x=[];f=o.map(([m,,h])=>{let b=x.indexOf(h);return b===-1&&(x.push(h),b=x.length-1),[m,b]}).sort((m,h)=>m[1]-h[1]).map(([m])=>m)}f.forEach(x=>{s[0]=s[0].replaceAll(x,"")}),s[0]=s[0].replace(/(?=<\/head>)/,f.join(""))}},xt=(e,t,r)=>B(new G(e,r,ut(t??[])).toString()),mt=(e,t,r,a)=>{if("itemProp"in r)return xt(e,t,r);let{precedence:s,blocking:n,...c}=r;s=a?s??"":void 0,a&&(c[gt]=s);const o=new G(e,c,ut(t||[])).toString();return o instanceof Promise?o.then(d=>B(o,[...d.callbacks||[],gr(e,d,c,s)])):B(o,[gr(e,o,c,s)])},ys=({children:e,...t})=>{const r=ir();if(r){const a=Je(r);if(a==="svg"||a==="head")return new G("title",t,ut(e??[]))}return mt("title",e,t,!1)},gs=({children:e,...t})=>{const r=ir();return["src","async"].some(a=>!t[a])||r&&Je(r)==="head"?xt("script",e,t):mt("script",e,t,!1)},Es=({children:e,...t})=>["href","precedence"].every(r=>r in t)?(t["data-href"]=t.href,delete t.href,mt("style",e,t,!0)):xt("style",e,t),vs=({children:e,...t})=>["onLoad","onError"].some(r=>r in t)||t.rel==="stylesheet"&&(!("precedence"in t)||"disabled"in t)?xt("link",e,t):mt("link",e,t,"precedence"in t),Ns=({children:e,...t})=>{const r=ir();return r&&Je(r)==="head"?xt("meta",e,t):mt("meta",e,t,!1)},na=(e,{children:t,...r})=>new G(e,r,ut(t??[])),Ts=e=>(typeof e.action=="function"&&(e.action=Rt in e.action?e.action[Rt]:void 0),na("form",e)),ia=(e,t)=>(typeof t.formAction=="function"&&(t.formAction=Rt in t.formAction?t.formAction[Rt]:void 0),na(e,t)),As=e=>ia("input",e),ws=e=>ia("button",e);const Ft=Object.freeze(Object.defineProperty({__proto__:null,button:ws,form:Ts,input:As,link:vs,meta:Ns,script:gs,style:Es,title:ys},Symbol.toStringTag,{value:"Module"}));var _s=new Map([["className","class"],["htmlFor","for"],["crossOrigin","crossorigin"],["httpEquiv","http-equiv"],["itemProp","itemprop"],["fetchPriority","fetchpriority"],["noModule","nomodule"],["formAction","formaction"]]),St=e=>_s.get(e)||e,ca=(e,t)=>{for(const[r,a]of Object.entries(e)){const s=r[0]==="-"||!/[A-Z]/.test(r)?r:r.replace(/[A-Z]/g,n=>`-${n.toLowerCase()}`);t(s,a==null?null:typeof a=="number"?s.match(/^(?:a|border-im|column(?:-c|s)|flex(?:$|-[^b])|grid-(?:ar|[^a])|font-w|li|or|sca|st|ta|wido|z)|ty$/)?`${a}`:`${a}px`:a)}},Qe=void 0,ir=()=>Qe,Rs=e=>/[A-Z]/.test(e)&&e.match(/^(?:al|basel|clip(?:Path|Rule)$|co|do|fill|fl|fo|gl|let|lig|i|marker[EMS]|o|pai|pointe|sh|st[or]|text[^L]|tr|u|ve|w)/)?e.replace(/([A-Z])/g,"-$1").toLowerCase():e,Ss=["area","base","br","col","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"],Cs=["allowfullscreen","async","autofocus","autoplay","checked","controls","default","defer","disabled","download","formnovalidate","hidden","inert","ismap","itemscope","loop","multiple","muted","nomodule","novalidate","open","playsinline","readonly","required","reversed","selected"],cr=(e,t)=>{for(let r=0,a=e.length;r<a;r++){const s=e[r];if(typeof s=="string")pe(s,t);else{if(typeof s=="boolean"||s===null||s===void 0)continue;s instanceof G?s.toStringToBuffer(t):typeof s=="number"||s.isEscaped?t[0]+=s:s instanceof Promise?t.unshift("",s):cr(s,t)}}},G=class{constructor(e,t,r){y(this,"tag");y(this,"props");y(this,"key");y(this,"children");y(this,"isEscaped",!0);y(this,"localContexts");this.tag=e,this.props=t,this.children=r}get type(){return this.tag}get ref(){return this.props.ref||null}toString(){var t,r;const e=[""];(t=this.localContexts)==null||t.forEach(([a,s])=>{a.values.push(s)});try{this.toStringToBuffer(e)}finally{(r=this.localContexts)==null||r.forEach(([a])=>{a.values.pop()})}return e.length===1?"callbacks"in e?ea(B(e[0],e.callbacks)).toString():e[0]:Qr(e,e.callbacks)}toStringToBuffer(e){const t=this.tag,r=this.props;let{children:a}=this;e[0]+=`<${t}`;const s=Qe&&Je(Qe)==="svg"?n=>Rs(St(n)):n=>St(n);for(let[n,c]of Object.entries(r))if(n=s(n),n!=="children"){if(n==="style"&&typeof c=="object"){let o="";ca(c,(d,l)=>{l!=null&&(o+=`${o?";":""}${d}:${l}`)}),e[0]+=' style="',pe(o,e),e[0]+='"'}else if(typeof c=="string")e[0]+=` ${n}="`,pe(c,e),e[0]+='"';else if(c!=null)if(typeof c=="number"||c.isEscaped)e[0]+=` ${n}="${c}"`;else if(typeof c=="boolean"&&Cs.includes(n))c&&(e[0]+=` ${n}=""`);else if(n==="dangerouslySetInnerHTML"){if(a.length>0)throw new Error("Can only set one of `children` or `props.dangerouslySetInnerHTML`.");a=[B(c.__html)]}else if(c instanceof Promise)e[0]+=` ${n}="`,e.unshift('"',c);else if(typeof c=="function"){if(!n.startsWith("on")&&n!=="ref")throw new Error(`Invalid prop '${n}' of type 'function' supplied to '${t}'.`)}else e[0]+=` ${n}="`,pe(c.toString(),e),e[0]+='"'}if(Ss.includes(t)&&a.length===0){e[0]+="/>";return}e[0]+=">",cr(a,e),e[0]+=`</${t}>`}},Pt=class extends G{toStringToBuffer(e){const{children:t}=this,r=this.tag.call(null,{...this.props,children:t.length<=1?t[0]:t});if(!(typeof r=="boolean"||r==null))if(r instanceof Promise)if(Xe.length===0)e.unshift("",r);else{const a=Xe.map(s=>[s,s.values.at(-1)]);e.unshift("",r.then(s=>(s instanceof G&&(s.localContexts=a),s)))}else r instanceof G?r.toStringToBuffer(e):typeof r=="number"||r.isEscaped?(e[0]+=r,r.callbacks&&(e.callbacks||(e.callbacks=[]),e.callbacks.push(...r.callbacks))):pe(r,e)}},oa=class extends G{toStringToBuffer(e){cr(this.children,e)}},Er=(e,t,...r)=>{t??(t={}),r.length&&(t.children=r.length===1?r[0]:r);const a=t.key;delete t.key;const s=Et(e,t,r);return s.key=a,s},vr=!1,Et=(e,t,r)=>{if(!vr){for(const a in qt)Ft[a][sr]=qt[a];vr=!0}return typeof e=="function"?new Pt(e,t,r):Ft[e]?new Pt(Ft[e],t,r):e==="svg"||e==="head"?(Qe||(Qe=nr("")),new G(e,t,[new Pt(Qe,{value:e},r)])):new G(e,t,r)},Os=({children:e})=>new oa("",{children:e},Array.isArray(e)?e:e?[e]:[]);function i(e,t,r){let a;if(!t||!("children"in t))a=Et(e,t,[]);else{const s=t.children;a=Array.isArray(s)?Et(e,t,s):Et(e,t,[s])}return a.key=r,a}var Nr=(e,t,r)=>(a,s)=>{let n=-1;return c(0);async function c(o){if(o<=n)throw new Error("next() called multiple times");n=o;let d,l=!1,f;if(e[o]?(f=e[o][0][0],a.req.routeIndex=o):f=o===e.length&&s||void 0,f)try{d=await f(a,()=>c(o+1))}catch(x){if(x instanceof Error&&t)a.error=x,d=await t(x,a),l=!0;else throw x}else a.finalized===!1&&r&&(d=await r(a));return d&&(a.finalized===!1||l)&&(a.res=d),a}},Ds=Symbol(),Is=async(e,t=Object.create(null))=>{const{all:r=!1,dot:a=!1}=t,n=(e instanceof ma?e.raw.headers:e.headers).get("Content-Type");return n!=null&&n.startsWith("multipart/form-data")||n!=null&&n.startsWith("application/x-www-form-urlencoded")?Us(e,{all:r,dot:a}):{}};async function Us(e,t){const r=await e.formData();return r?Ls(r,t):{}}function Ls(e,t){const r=Object.create(null);return e.forEach((a,s)=>{t.all||s.endsWith("[]")?Ms(r,s,a):r[s]=a}),t.dot&&Object.entries(r).forEach(([a,s])=>{a.includes(".")&&(Fs(r,a,s),delete r[a])}),r}var Ms=(e,t,r)=>{e[t]!==void 0?Array.isArray(e[t])?e[t].push(r):e[t]=[e[t],r]:t.endsWith("[]")?e[t]=[r]:e[t]=r},Fs=(e,t,r)=>{let a=e;const s=t.split(".");s.forEach((n,c)=>{c===s.length-1?a[n]=r:((!a[n]||typeof a[n]!="object"||Array.isArray(a[n])||a[n]instanceof File)&&(a[n]=Object.create(null)),a=a[n])})},da=e=>{const t=e.split("/");return t[0]===""&&t.shift(),t},Ps=e=>{const{groups:t,path:r}=js(e),a=da(r);return $s(a,t)},js=e=>{const t=[];return e=e.replace(/\{[^}]+\}/g,(r,a)=>{const s=`@${a}`;return t.push([s,r]),s}),{groups:t,path:e}},$s=(e,t)=>{for(let r=t.length-1;r>=0;r--){const[a]=t[r];for(let s=e.length-1;s>=0;s--)if(e[s].includes(a)){e[s]=e[s].replace(a,t[r][1]);break}}return e},ht={},Bs=(e,t)=>{if(e==="*")return"*";const r=e.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);if(r){const a=`${e}#${t}`;return ht[a]||(r[2]?ht[a]=t&&t[0]!==":"&&t[0]!=="*"?[a,r[1],new RegExp(`^${r[2]}(?=/${t})`)]:[e,r[1],new RegExp(`^${r[2]}$`)]:ht[a]=[e,r[1],!0]),ht[a]}return null},or=(e,t)=>{try{return t(e)}catch{return e.replace(/(?:%[0-9A-Fa-f]{2})+/g,r=>{try{return t(r)}catch{return r}})}},Hs=e=>or(e,decodeURI),la=e=>{const t=e.url,r=t.indexOf("/",t.indexOf(":")+4);let a=r;for(;a<t.length;a++){const s=t.charCodeAt(a);if(s===37){const n=t.indexOf("?",a),c=t.slice(r,n===-1?void 0:n);return Hs(c.includes("%25")?c.replace(/%25/g,"%2525"):c)}else if(s===63)break}return t.slice(r,a)},ks=e=>{const t=la(e);return t.length>1&&t.at(-1)==="/"?t.slice(0,-1):t},Ie=(e,t,...r)=>(r.length&&(t=Ie(t,...r)),`${(e==null?void 0:e[0])==="/"?"":"/"}${e}${t==="/"?"":`${(e==null?void 0:e.at(-1))==="/"?"":"/"}${(t==null?void 0:t[0])==="/"?t.slice(1):t}`}`),fa=e=>{if(e.charCodeAt(e.length-1)!==63||!e.includes(":"))return null;const t=e.split("/"),r=[];let a="";return t.forEach(s=>{if(s!==""&&!/\:/.test(s))a+="/"+s;else if(/\:/.test(s))if(/\?/.test(s)){r.length===0&&a===""?r.push("/"):r.push(a);const n=s.replace("?","");a+="/"+n,r.push(a)}else a+="/"+s}),r.filter((s,n,c)=>c.indexOf(s)===n)},jt=e=>/[%+]/.test(e)?(e.indexOf("+")!==-1&&(e=e.replace(/\+/g," ")),e.indexOf("%")!==-1?or(e,xa):e):e,ua=(e,t,r)=>{let a;if(!r&&t&&!/[%+]/.test(t)){let c=e.indexOf(`?${t}`,8);for(c===-1&&(c=e.indexOf(`&${t}`,8));c!==-1;){const o=e.charCodeAt(c+t.length+1);if(o===61){const d=c+t.length+2,l=e.indexOf("&",d);return jt(e.slice(d,l===-1?void 0:l))}else if(o==38||isNaN(o))return"";c=e.indexOf(`&${t}`,c+1)}if(a=/[%+]/.test(e),!a)return}const s={};a??(a=/[%+]/.test(e));let n=e.indexOf("?",8);for(;n!==-1;){const c=e.indexOf("&",n+1);let o=e.indexOf("=",n);o>c&&c!==-1&&(o=-1);let d=e.slice(n+1,o===-1?c===-1?void 0:c:o);if(a&&(d=jt(d)),n=c,d==="")continue;let l;o===-1?l="":(l=e.slice(o+1,c===-1?void 0:c),a&&(l=jt(l))),r?(s[d]&&Array.isArray(s[d])||(s[d]=[]),s[d].push(l)):s[d]??(s[d]=l)}return t?s[t]:s},Ks=ua,Xs=(e,t)=>ua(e,t,!0),xa=decodeURIComponent,Tr=e=>or(e,xa),je,j,ae,pa,ha,Vt,oe,Kr,ma=(Kr=class{constructor(e,t="/",r=[[]]){v(this,ae);y(this,"raw");v(this,je);v(this,j);y(this,"routeIndex",0);y(this,"path");y(this,"bodyCache",{});v(this,oe,e=>{const{bodyCache:t,raw:r}=this,a=t[e];if(a)return a;const s=Object.keys(t)[0];return s?t[s].then(n=>(s==="json"&&(n=JSON.stringify(n)),new Response(n)[e]())):t[e]=r[e]()});this.raw=e,this.path=t,g(this,j,r),g(this,je,{})}param(e){return e?_(this,ae,pa).call(this,e):_(this,ae,ha).call(this)}query(e){return Ks(this.url,e)}queries(e){return Xs(this.url,e)}header(e){if(e)return this.raw.headers.get(e)??void 0;const t={};return this.raw.headers.forEach((r,a)=>{t[a]=r}),t}async parseBody(e){var t;return(t=this.bodyCache).parsedBody??(t.parsedBody=await Is(this,e))}json(){return u(this,oe).call(this,"text").then(e=>JSON.parse(e))}text(){return u(this,oe).call(this,"text")}arrayBuffer(){return u(this,oe).call(this,"arrayBuffer")}blob(){return u(this,oe).call(this,"blob")}formData(){return u(this,oe).call(this,"formData")}addValidatedData(e,t){u(this,je)[e]=t}valid(e){return u(this,je)[e]}get url(){return this.raw.url}get method(){return this.raw.method}get[Ds](){return u(this,j)}get matchedRoutes(){return u(this,j)[0].map(([[,e]])=>e)}get routePath(){return u(this,j)[0].map(([[,e]])=>e)[this.routeIndex].path}},je=new WeakMap,j=new WeakMap,ae=new WeakSet,pa=function(e){const t=u(this,j)[0][this.routeIndex][1][e],r=_(this,ae,Vt).call(this,t);return r&&/\%/.test(r)?Tr(r):r},ha=function(){const e={},t=Object.keys(u(this,j)[0][this.routeIndex][1]);for(const r of t){const a=_(this,ae,Vt).call(this,u(this,j)[0][this.routeIndex][1][r]);a!==void 0&&(e[r]=/\%/.test(a)?Tr(a):a)}return e},Vt=function(e){return u(this,j)[1]?u(this,j)[1][e]:e},oe=new WeakMap,Kr),Ws="text/plain; charset=UTF-8",$t=(e,t)=>({"Content-Type":e,...t}),nt,it,Q,$e,ee,F,ct,Be,He,Ee,ot,dt,de,Ue,Xr,Gs=(Xr=class{constructor(e,t){v(this,de);v(this,nt);v(this,it);y(this,"env",{});v(this,Q);y(this,"finalized",!1);y(this,"error");v(this,$e);v(this,ee);v(this,F);v(this,ct);v(this,Be);v(this,He);v(this,Ee);v(this,ot);v(this,dt);y(this,"render",(...e)=>(u(this,Be)??g(this,Be,t=>this.html(t)),u(this,Be).call(this,...e)));y(this,"setLayout",e=>g(this,ct,e));y(this,"getLayout",()=>u(this,ct));y(this,"setRenderer",e=>{g(this,Be,e)});y(this,"header",(e,t,r)=>{this.finalized&&g(this,F,new Response(u(this,F).body,u(this,F)));const a=u(this,F)?u(this,F).headers:u(this,Ee)??g(this,Ee,new Headers);t===void 0?a.delete(e):r!=null&&r.append?a.append(e,t):a.set(e,t)});y(this,"status",e=>{g(this,$e,e)});y(this,"set",(e,t)=>{u(this,Q)??g(this,Q,new Map),u(this,Q).set(e,t)});y(this,"get",e=>u(this,Q)?u(this,Q).get(e):void 0);y(this,"newResponse",(...e)=>_(this,de,Ue).call(this,...e));y(this,"body",(e,t,r)=>_(this,de,Ue).call(this,e,t,r));y(this,"text",(e,t,r)=>!u(this,Ee)&&!u(this,$e)&&!t&&!r&&!this.finalized?new Response(e):_(this,de,Ue).call(this,e,t,$t(Ws,r)));y(this,"json",(e,t,r)=>_(this,de,Ue).call(this,JSON.stringify(e),t,$t("application/json",r)));y(this,"html",(e,t,r)=>{const a=s=>_(this,de,Ue).call(this,s,t,$t("text/html; charset=UTF-8",r));return typeof e=="object"?ta(e,Zr.Stringify,!1,{}).then(a):a(e)});y(this,"redirect",(e,t)=>{const r=String(e);return this.header("Location",/[^\x00-\xFF]/.test(r)?encodeURI(r):r),this.newResponse(null,t??302)});y(this,"notFound",()=>(u(this,He)??g(this,He,()=>new Response),u(this,He).call(this,this)));g(this,nt,e),t&&(g(this,ee,t.executionCtx),this.env=t.env,g(this,He,t.notFoundHandler),g(this,dt,t.path),g(this,ot,t.matchResult))}get req(){return u(this,it)??g(this,it,new ma(u(this,nt),u(this,dt),u(this,ot))),u(this,it)}get event(){if(u(this,ee)&&"respondWith"in u(this,ee))return u(this,ee);throw Error("This context has no FetchEvent")}get executionCtx(){if(u(this,ee))return u(this,ee);throw Error("This context has no ExecutionContext")}get res(){return u(this,F)||g(this,F,new Response(null,{headers:u(this,Ee)??g(this,Ee,new Headers)}))}set res(e){if(u(this,F)&&e){e=new Response(e.body,e);for(const[t,r]of u(this,F).headers.entries())if(t!=="content-type")if(t==="set-cookie"){const a=u(this,F).headers.getSetCookie();e.headers.delete("set-cookie");for(const s of a)e.headers.append("set-cookie",s)}else e.headers.set(t,r)}g(this,F,e),this.finalized=!0}get var(){return u(this,Q)?Object.fromEntries(u(this,Q)):{}}},nt=new WeakMap,it=new WeakMap,Q=new WeakMap,$e=new WeakMap,ee=new WeakMap,F=new WeakMap,ct=new WeakMap,Be=new WeakMap,He=new WeakMap,Ee=new WeakMap,ot=new WeakMap,dt=new WeakMap,de=new WeakSet,Ue=function(e,t,r){const a=u(this,F)?new Headers(u(this,F).headers):u(this,Ee)??new Headers;if(typeof t=="object"&&"headers"in t){const n=t.headers instanceof Headers?t.headers:new Headers(t.headers);for(const[c,o]of n)c.toLowerCase()==="set-cookie"?a.append(c,o):a.set(c,o)}if(r)for(const[n,c]of Object.entries(r))if(typeof c=="string")a.set(n,c);else{a.delete(n);for(const o of c)a.append(n,o)}const s=typeof t=="number"?t:(t==null?void 0:t.status)??u(this,$e);return new Response(e,{status:s,headers:a})},Xr),D="ALL",Js="all",qs=["get","post","put","delete","options","patch"],ba="Can not add a route since the matcher is already built.",ya=class extends Error{},Vs="__COMPOSED_HANDLER",zs=e=>e.text("404 Not Found",404),Ar=(e,t)=>{if("getResponse"in e){const r=e.getResponse();return t.newResponse(r.body,r)}return console.error(e),t.text("Internal Server Error",500)},k,I,Ea,K,ye,vt,Nt,Wr,ga=(Wr=class{constructor(t={}){v(this,I);y(this,"get");y(this,"post");y(this,"put");y(this,"delete");y(this,"options");y(this,"patch");y(this,"all");y(this,"on");y(this,"use");y(this,"router");y(this,"getPath");y(this,"_basePath","/");v(this,k,"/");y(this,"routes",[]);v(this,K,zs);y(this,"errorHandler",Ar);y(this,"onError",t=>(this.errorHandler=t,this));y(this,"notFound",t=>(g(this,K,t),this));y(this,"fetch",(t,...r)=>_(this,I,Nt).call(this,t,r[1],r[0],t.method));y(this,"request",(t,r,a,s)=>t instanceof Request?this.fetch(r?new Request(t,r):t,a,s):(t=t.toString(),this.fetch(new Request(/^https?:\/\//.test(t)?t:`http://localhost${Ie("/",t)}`,r),a,s)));y(this,"fire",()=>{addEventListener("fetch",t=>{t.respondWith(_(this,I,Nt).call(this,t.request,t,void 0,t.request.method))})});[...qs,Js].forEach(n=>{this[n]=(c,...o)=>(typeof c=="string"?g(this,k,c):_(this,I,ye).call(this,n,u(this,k),c),o.forEach(d=>{_(this,I,ye).call(this,n,u(this,k),d)}),this)}),this.on=(n,c,...o)=>{for(const d of[c].flat()){g(this,k,d);for(const l of[n].flat())o.map(f=>{_(this,I,ye).call(this,l.toUpperCase(),u(this,k),f)})}return this},this.use=(n,...c)=>(typeof n=="string"?g(this,k,n):(g(this,k,"*"),c.unshift(n)),c.forEach(o=>{_(this,I,ye).call(this,D,u(this,k),o)}),this);const{strict:a,...s}=t;Object.assign(this,s),this.getPath=a??!0?t.getPath??la:ks}route(t,r){const a=this.basePath(t);return r.routes.map(s=>{var c;let n;r.errorHandler===Ar?n=s.handler:(n=async(o,d)=>(await Nr([],r.errorHandler)(o,()=>s.handler(o,d))).res,n[Vs]=s.handler),_(c=a,I,ye).call(c,s.method,s.path,n)}),this}basePath(t){const r=_(this,I,Ea).call(this);return r._basePath=Ie(this._basePath,t),r}mount(t,r,a){let s,n;a&&(typeof a=="function"?n=a:(n=a.optionHandler,a.replaceRequest===!1?s=d=>d:s=a.replaceRequest));const c=n?d=>{const l=n(d);return Array.isArray(l)?l:[l]}:d=>{let l;try{l=d.executionCtx}catch{}return[d.env,l]};s||(s=(()=>{const d=Ie(this._basePath,t),l=d==="/"?0:d.length;return f=>{const x=new URL(f.url);return x.pathname=x.pathname.slice(l)||"/",new Request(x,f)}})());const o=async(d,l)=>{const f=await r(s(d.req.raw),...c(d));if(f)return f;await l()};return _(this,I,ye).call(this,D,Ie(t,"*"),o),this}},k=new WeakMap,I=new WeakSet,Ea=function(){const t=new ga({router:this.router,getPath:this.getPath});return t.errorHandler=this.errorHandler,g(t,K,u(this,K)),t.routes=this.routes,t},K=new WeakMap,ye=function(t,r,a){t=t.toUpperCase(),r=Ie(this._basePath,r);const s={basePath:this._basePath,path:r,method:t,handler:a};this.router.add(t,r,[a,s]),this.routes.push(s)},vt=function(t,r){if(t instanceof Error)return this.errorHandler(t,r);throw t},Nt=function(t,r,a,s){if(s==="HEAD")return(async()=>new Response(null,await _(this,I,Nt).call(this,t,r,a,"GET")))();const n=this.getPath(t,{env:a}),c=this.router.match(s,n),o=new Gs(t,{path:n,matchResult:c,env:a,executionCtx:r,notFoundHandler:u(this,K)});if(c[0].length===1){let l;try{l=c[0][0][0][0](o,async()=>{o.res=await u(this,K).call(this,o)})}catch(f){return _(this,I,vt).call(this,f,o)}return l instanceof Promise?l.then(f=>f||(o.finalized?o.res:u(this,K).call(this,o))).catch(f=>_(this,I,vt).call(this,f,o)):l??u(this,K).call(this,o)}const d=Nr(c[0],this.errorHandler,u(this,K));return(async()=>{try{const l=await d(o);if(!l.finalized)throw new Error("Context is not finalized. Did you forget to return a Response object or `await next()`?");return l.res}catch(l){return _(this,I,vt).call(this,l,o)}})()},Wr),Ct="[^/]+",ze=".*",Ye="(?:|/.*)",Le=Symbol(),Ys=new Set(".\\+*[^]$()");function Zs(e,t){return e.length===1?t.length===1?e<t?-1:1:-1:t.length===1||e===ze||e===Ye?1:t===ze||t===Ye?-1:e===Ct?1:t===Ct?-1:e.length===t.length?e<t?-1:1:t.length-e.length}var ve,Ne,X,Gr,zt=(Gr=class{constructor(){v(this,ve);v(this,Ne);v(this,X,Object.create(null))}insert(t,r,a,s,n){if(t.length===0){if(u(this,ve)!==void 0)throw Le;if(n)return;g(this,ve,r);return}const[c,...o]=t,d=c==="*"?o.length===0?["","",ze]:["","",Ct]:c==="/*"?["","",Ye]:c.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);let l;if(d){const f=d[1];let x=d[2]||Ct;if(f&&d[2]&&(x===".*"||(x=x.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(x))))throw Le;if(l=u(this,X)[x],!l){if(Object.keys(u(this,X)).some(m=>m!==ze&&m!==Ye))throw Le;if(n)return;l=u(this,X)[x]=new zt,f!==""&&g(l,Ne,s.varIndex++)}!n&&f!==""&&a.push([f,u(l,Ne)])}else if(l=u(this,X)[c],!l){if(Object.keys(u(this,X)).some(f=>f.length>1&&f!==ze&&f!==Ye))throw Le;if(n)return;l=u(this,X)[c]=new zt}l.insert(o,r,a,s,n)}buildRegExpStr(){const r=Object.keys(u(this,X)).sort(Zs).map(a=>{const s=u(this,X)[a];return(typeof u(s,Ne)=="number"?`(${a})@${u(s,Ne)}`:Ys.has(a)?`\\${a}`:a)+s.buildRegExpStr()});return typeof u(this,ve)=="number"&&r.unshift(`#${u(this,ve)}`),r.length===0?"":r.length===1?r[0]:"(?:"+r.join("|")+")"}},ve=new WeakMap,Ne=new WeakMap,X=new WeakMap,Gr),Dt,lt,Jr,Qs=(Jr=class{constructor(){v(this,Dt,{varIndex:0});v(this,lt,new zt)}insert(e,t,r){const a=[],s=[];for(let c=0;;){let o=!1;if(e=e.replace(/\{[^}]+\}/g,d=>{const l=`@\\${c}`;return s[c]=[l,d],c++,o=!0,l}),!o)break}const n=e.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let c=s.length-1;c>=0;c--){const[o]=s[c];for(let d=n.length-1;d>=0;d--)if(n[d].indexOf(o)!==-1){n[d]=n[d].replace(o,s[c][1]);break}}return u(this,lt).insert(n,t,a,u(this,Dt),r),a}buildRegExp(){let e=u(this,lt).buildRegExpStr();if(e==="")return[/^$/,[],[]];let t=0;const r=[],a=[];return e=e.replace(/#(\d+)|@(\d+)|\.\*\$/g,(s,n,c)=>n!==void 0?(r[++t]=Number(n),"$()"):(c!==void 0&&(a[Number(c)]=++t),"")),[new RegExp(`^${e}`),r,a]}},Dt=new WeakMap,lt=new WeakMap,Jr),va=[],en=[/^$/,[],Object.create(null)],Tt=Object.create(null);function Na(e){return Tt[e]??(Tt[e]=new RegExp(e==="*"?"":`^${e.replace(/\/\*$|([.\\+*[^\]$()])/g,(t,r)=>r?`\\${r}`:"(?:|/.*)")}$`))}function tn(){Tt=Object.create(null)}function rn(e){var l;const t=new Qs,r=[];if(e.length===0)return en;const a=e.map(f=>[!/\*|\/:/.test(f[0]),...f]).sort(([f,x],[m,h])=>f?1:m?-1:x.length-h.length),s=Object.create(null);for(let f=0,x=-1,m=a.length;f<m;f++){const[h,b,p]=a[f];h?s[b]=[p.map(([N])=>[N,Object.create(null)]),va]:x++;let E;try{E=t.insert(b,x,h)}catch(N){throw N===Le?new ya(b):N}h||(r[x]=p.map(([N,T])=>{const R=Object.create(null);for(T-=1;T>=0;T--){const[A,L]=E[T];R[A]=L}return[N,R]}))}const[n,c,o]=t.buildRegExp();for(let f=0,x=r.length;f<x;f++)for(let m=0,h=r[f].length;m<h;m++){const b=(l=r[f][m])==null?void 0:l[1];if(!b)continue;const p=Object.keys(b);for(let E=0,N=p.length;E<N;E++)b[p[E]]=o[b[p[E]]]}const d=[];for(const f in c)d[f]=r[c[f]];return[n,d,s]}function Se(e,t){if(e){for(const r of Object.keys(e).sort((a,s)=>s.length-a.length))if(Na(r).test(t))return[...e[r]]}}var le,fe,Ge,Ta,Aa,qr,an=(qr=class{constructor(){v(this,Ge);y(this,"name","RegExpRouter");v(this,le);v(this,fe);g(this,le,{[D]:Object.create(null)}),g(this,fe,{[D]:Object.create(null)})}add(e,t,r){var o;const a=u(this,le),s=u(this,fe);if(!a||!s)throw new Error(ba);a[e]||[a,s].forEach(d=>{d[e]=Object.create(null),Object.keys(d[D]).forEach(l=>{d[e][l]=[...d[D][l]]})}),t==="/*"&&(t="*");const n=(t.match(/\/:/g)||[]).length;if(/\*$/.test(t)){const d=Na(t);e===D?Object.keys(a).forEach(l=>{var f;(f=a[l])[t]||(f[t]=Se(a[l],t)||Se(a[D],t)||[])}):(o=a[e])[t]||(o[t]=Se(a[e],t)||Se(a[D],t)||[]),Object.keys(a).forEach(l=>{(e===D||e===l)&&Object.keys(a[l]).forEach(f=>{d.test(f)&&a[l][f].push([r,n])})}),Object.keys(s).forEach(l=>{(e===D||e===l)&&Object.keys(s[l]).forEach(f=>d.test(f)&&s[l][f].push([r,n]))});return}const c=fa(t)||[t];for(let d=0,l=c.length;d<l;d++){const f=c[d];Object.keys(s).forEach(x=>{var m;(e===D||e===x)&&((m=s[x])[f]||(m[f]=[...Se(a[x],f)||Se(a[D],f)||[]]),s[x][f].push([r,n-l+d+1]))})}}match(e,t){tn();const r=_(this,Ge,Ta).call(this);return this.match=(a,s)=>{const n=r[a]||r[D],c=n[2][s];if(c)return c;const o=s.match(n[0]);if(!o)return[[],va];const d=o.indexOf("",1);return[n[1][d],o]},this.match(e,t)}},le=new WeakMap,fe=new WeakMap,Ge=new WeakSet,Ta=function(){const e=Object.create(null);return Object.keys(u(this,fe)).concat(Object.keys(u(this,le))).forEach(t=>{e[t]||(e[t]=_(this,Ge,Aa).call(this,t))}),g(this,le,g(this,fe,void 0)),e},Aa=function(e){const t=[];let r=e===D;return[u(this,le),u(this,fe)].forEach(a=>{const s=a[e]?Object.keys(a[e]).map(n=>[n,a[e][n]]):[];s.length!==0?(r||(r=!0),t.push(...s)):e!==D&&t.push(...Object.keys(a[D]).map(n=>[n,a[D][n]]))}),r?rn(t):null},qr),ue,te,Vr,sn=(Vr=class{constructor(e){y(this,"name","SmartRouter");v(this,ue,[]);v(this,te,[]);g(this,ue,e.routers)}add(e,t,r){if(!u(this,te))throw new Error(ba);u(this,te).push([e,t,r])}match(e,t){if(!u(this,te))throw new Error("Fatal error");const r=u(this,ue),a=u(this,te),s=r.length;let n=0,c;for(;n<s;n++){const o=r[n];try{for(let d=0,l=a.length;d<l;d++)o.add(...a[d]);c=o.match(e,t)}catch(d){if(d instanceof ya)continue;throw d}this.match=o.match.bind(o),g(this,ue,[o]),g(this,te,void 0);break}if(n===s)throw new Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,c}get activeRouter(){if(u(this,te)||u(this,ue).length!==1)throw new Error("No active router has been determined yet.");return u(this,ue)[0]}},ue=new WeakMap,te=new WeakMap,Vr),qe=Object.create(null),xe,M,Te,ke,U,re,ge,zr,wa=(zr=class{constructor(e,t,r){v(this,re);v(this,xe);v(this,M);v(this,Te);v(this,ke,0);v(this,U,qe);if(g(this,M,r||Object.create(null)),g(this,xe,[]),e&&t){const a=Object.create(null);a[e]={handler:t,possibleKeys:[],score:0},g(this,xe,[a])}g(this,Te,[])}insert(e,t,r){g(this,ke,++hr(this,ke)._);let a=this;const s=Ps(t),n=[];for(let c=0,o=s.length;c<o;c++){const d=s[c],l=s[c+1],f=Bs(d,l),x=Array.isArray(f)?f[0]:d;if(x in u(a,M)){a=u(a,M)[x],f&&n.push(f[1]);continue}u(a,M)[x]=new wa,f&&(u(a,Te).push(f),n.push(f[1])),a=u(a,M)[x]}return u(a,xe).push({[e]:{handler:r,possibleKeys:n.filter((c,o,d)=>d.indexOf(c)===o),score:u(this,ke)}}),a}search(e,t){var o;const r=[];g(this,U,qe);let s=[this];const n=da(t),c=[];for(let d=0,l=n.length;d<l;d++){const f=n[d],x=d===l-1,m=[];for(let h=0,b=s.length;h<b;h++){const p=s[h],E=u(p,M)[f];E&&(g(E,U,u(p,U)),x?(u(E,M)["*"]&&r.push(..._(this,re,ge).call(this,u(E,M)["*"],e,u(p,U))),r.push(..._(this,re,ge).call(this,E,e,u(p,U)))):m.push(E));for(let N=0,T=u(p,Te).length;N<T;N++){const R=u(p,Te)[N],A=u(p,U)===qe?{}:{...u(p,U)};if(R==="*"){const se=u(p,M)["*"];se&&(r.push(..._(this,re,ge).call(this,se,e,u(p,U))),g(se,U,A),m.push(se));continue}const[L,Re,he]=R;if(!f&&!(he instanceof RegExp))continue;const z=u(p,M)[L],fs=n.slice(d).join("/");if(he instanceof RegExp){const se=he.exec(fs);if(se){if(A[Re]=se[0],r.push(..._(this,re,ge).call(this,z,e,u(p,U),A)),Object.keys(u(z,M)).length){g(z,U,A);const Lt=((o=se[0].match(/\//))==null?void 0:o.length)??0;(c[Lt]||(c[Lt]=[])).push(z)}continue}}(he===!0||he.test(f))&&(A[Re]=f,x?(r.push(..._(this,re,ge).call(this,z,e,A,u(p,U))),u(z,M)["*"]&&r.push(..._(this,re,ge).call(this,u(z,M)["*"],e,A,u(p,U)))):(g(z,U,A),m.push(z)))}}s=m.concat(c.shift()??[])}return r.length>1&&r.sort((d,l)=>d.score-l.score),[r.map(({handler:d,params:l})=>[d,l])]}},xe=new WeakMap,M=new WeakMap,Te=new WeakMap,ke=new WeakMap,U=new WeakMap,re=new WeakSet,ge=function(e,t,r,a){const s=[];for(let n=0,c=u(e,xe).length;n<c;n++){const o=u(e,xe)[n],d=o[t]||o[D],l={};if(d!==void 0&&(d.params=Object.create(null),s.push(d),r!==qe||a&&a!==qe))for(let f=0,x=d.possibleKeys.length;f<x;f++){const m=d.possibleKeys[f],h=l[d.score];d.params[m]=a!=null&&a[m]&&!h?a[m]:r[m]??(a==null?void 0:a[m]),l[d.score]=!0}}return s},zr),Ae,Yr,nn=(Yr=class{constructor(){y(this,"name","TrieRouter");v(this,Ae);g(this,Ae,new wa)}add(e,t,r){const a=fa(t);if(a){for(let s=0,n=a.length;s<n;s++)u(this,Ae).insert(e,a[s],r);return}u(this,Ae).insert(e,t,r)}match(e,t){return u(this,Ae).search(e,t)}},Ae=new WeakMap,Yr),_a=class extends ga{constructor(e={}){super(e),this.router=e.router??new sn({routers:[new an,new nn]})}},cn=e=>{const r={...{origin:"*",allowMethods:["GET","HEAD","PUT","POST","DELETE","PATCH"],allowHeaders:[],exposeHeaders:[]},...e},a=(n=>typeof n=="string"?n==="*"?()=>n:c=>n===c?c:null:typeof n=="function"?n:c=>n.includes(c)?c:null)(r.origin),s=(n=>typeof n=="function"?n:Array.isArray(n)?()=>n:()=>[])(r.allowMethods);return async function(c,o){var f;function d(x,m){c.res.headers.set(x,m)}const l=await a(c.req.header("origin")||"",c);if(l&&d("Access-Control-Allow-Origin",l),r.origin!=="*"){const x=c.req.header("Vary");x?d("Vary",x):d("Vary","Origin")}if(r.credentials&&d("Access-Control-Allow-Credentials","true"),(f=r.exposeHeaders)!=null&&f.length&&d("Access-Control-Expose-Headers",r.exposeHeaders.join(",")),c.req.method==="OPTIONS"){r.maxAge!=null&&d("Access-Control-Max-Age",r.maxAge.toString());const x=await s(c.req.header("origin")||"",c);x.length&&d("Access-Control-Allow-Methods",x.join(","));let m=r.allowHeaders;if(!(m!=null&&m.length)){const h=c.req.header("Access-Control-Request-Headers");h&&(m=h.split(/\s*,\s*/))}return m!=null&&m.length&&(d("Access-Control-Allow-Headers",m.join(",")),c.res.headers.append("Vary","Access-Control-Request-Headers")),c.res.headers.delete("Content-Length"),c.res.headers.delete("Content-Type"),new Response(null,{headers:c.res.headers,status:204,statusText:"No Content"})}await o()}};function on(){const{process:e,Deno:t}=globalThis;return!(typeof(t==null?void 0:t.noColor)=="boolean"?t.noColor:e!==void 0?"NO_COLOR"in(e==null?void 0:e.env):!1)}async function dn(){const{navigator:e}=globalThis,t="cloudflare:workers";return!(e!==void 0&&e.userAgent==="Cloudflare-Workers"?await(async()=>{try{return"NO_COLOR"in((await import(t)).env??{})}catch{return!1}})():!on())}var ln=e=>{const[t,r]=[",","."];return e.map(s=>s.replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1"+t)).join(r)},fn=e=>{const t=Date.now()-e;return ln([t<1e3?t+"ms":Math.round(t/1e3)+"s"])},un=async e=>{if(await dn())switch(e/100|0){case 5:return`\x1B[31m${e}\x1B[0m`;case 4:return`\x1B[33m${e}\x1B[0m`;case 3:return`\x1B[36m${e}\x1B[0m`;case 2:return`\x1B[32m${e}\x1B[0m`}return`${e}`};async function wr(e,t,r,a,s=0,n){const c=t==="<--"?`${t} ${r} ${a}`:`${t} ${r} ${a} ${await un(s)} ${n}`;e(c)}var xn=(e=console.log)=>async function(r,a){const{method:s,url:n}=r.req,c=n.slice(n.indexOf("/",8));await wr(e,"<--",s,c);const o=Date.now();await a(),await wr(e,"-->",s,c,r.res.status,fn(o))},mn=/^\s*(?:text\/(?!event-stream(?:[;\s]|$))[^;\s]+|application\/(?:javascript|json|xml|xml-dtd|ecmascript|dart|postscript|rtf|tar|toml|vnd\.dart|vnd\.ms-fontobject|vnd\.ms-opentype|wasm|x-httpd-php|x-javascript|x-ns-proxy-autoconfig|x-sh|x-tar|x-virtualbox-hdd|x-virtualbox-ova|x-virtualbox-ovf|x-virtualbox-vbox|x-virtualbox-vdi|x-virtualbox-vhd|x-virtualbox-vmdk|x-www-form-urlencoded)|font\/(?:otf|ttf)|image\/(?:bmp|vnd\.adobe\.photoshop|vnd\.microsoft\.icon|vnd\.ms-dds|x-icon|x-ms-bmp)|message\/rfc822|model\/gltf-binary|x-shader\/x-fragment|x-shader\/x-vertex|[^;\s]+?\+(?:json|text|xml|yaml))(?:[;\s]|$)/i,_r=(e,t=hn)=>{const r=/\.([a-zA-Z0-9]+?)$/,a=e.match(r);if(!a)return;let s=t[a[1]];return s&&s.startsWith("text")&&(s+="; charset=utf-8"),s},pn={aac:"audio/aac",avi:"video/x-msvideo",avif:"image/avif",av1:"video/av1",bin:"application/octet-stream",bmp:"image/bmp",css:"text/css",csv:"text/csv",eot:"application/vnd.ms-fontobject",epub:"application/epub+zip",gif:"image/gif",gz:"application/gzip",htm:"text/html",html:"text/html",ico:"image/x-icon",ics:"text/calendar",jpeg:"image/jpeg",jpg:"image/jpeg",js:"text/javascript",json:"application/json",jsonld:"application/ld+json",map:"application/json",mid:"audio/x-midi",midi:"audio/x-midi",mjs:"text/javascript",mp3:"audio/mpeg",mp4:"video/mp4",mpeg:"video/mpeg",oga:"audio/ogg",ogv:"video/ogg",ogx:"application/ogg",opus:"audio/opus",otf:"font/otf",pdf:"application/pdf",png:"image/png",rtf:"application/rtf",svg:"image/svg+xml",tif:"image/tiff",tiff:"image/tiff",ts:"video/mp2t",ttf:"font/ttf",txt:"text/plain",wasm:"application/wasm",webm:"video/webm",weba:"audio/webm",webmanifest:"application/manifest+json",webp:"image/webp",woff:"font/woff",woff2:"font/woff2",xhtml:"application/xhtml+xml",xml:"application/xml",zip:"application/zip","3gp":"video/3gpp","3g2":"video/3gpp2",gltf:"model/gltf+json",glb:"model/gltf-binary"},hn=pn,bn=(...e)=>{let t=e.filter(s=>s!=="").join("/");t=t.replace(new RegExp("(?<=\\/)\\/+","g"),"");const r=t.split("/"),a=[];for(const s of r)s===".."&&a.length>0&&a.at(-1)!==".."?a.pop():s!=="."&&a.push(s);return a.join("/")||"."},Ra={br:".br",zstd:".zst",gzip:".gz"},yn=Object.keys(Ra),gn="index.html",En=e=>{const t=e.root??"./",r=e.path,a=e.join??bn;return async(s,n)=>{var f,x,m,h;if(s.finalized)return n();let c;if(e.path)c=e.path;else try{if(c=decodeURIComponent(s.req.path),/(?:^|[\/\\])\.\.(?:$|[\/\\])/.test(c))throw new Error}catch{return await((f=e.onNotFound)==null?void 0:f.call(e,s.req.path,s)),n()}let o=a(t,!r&&e.rewriteRequestPath?e.rewriteRequestPath(c):c);e.isDir&&await e.isDir(o)&&(o=a(o,gn));const d=e.getContent;let l=await d(o,s);if(l instanceof Response)return s.newResponse(l.body,l);if(l){const b=e.mimes&&_r(o,e.mimes)||_r(o);if(s.header("Content-Type",b||"application/octet-stream"),e.precompressed&&(!b||mn.test(b))){const p=new Set((x=s.req.header("Accept-Encoding"))==null?void 0:x.split(",").map(E=>E.trim()));for(const E of yn){if(!p.has(E))continue;const N=await d(o+Ra[E],s);if(N){l=N,s.header("Content-Encoding",E),s.header("Vary","Accept-Encoding",{append:!0});break}}}return await((m=e.onFound)==null?void 0:m.call(e,o,s)),s.body(l)}await((h=e.onNotFound)==null?void 0:h.call(e,o,s)),await n()}},vn=async(e,t)=>{let r;t&&t.manifest?typeof t.manifest=="string"?r=JSON.parse(t.manifest):r=t.manifest:typeof __STATIC_CONTENT_MANIFEST=="string"?r=JSON.parse(__STATIC_CONTENT_MANIFEST):r=__STATIC_CONTENT_MANIFEST;let a;t&&t.namespace?a=t.namespace:a=__STATIC_CONTENT;const s=r[e]||e;if(!s)return null;const n=await a.get(s,{type:"stream"});return n||null},Nn=e=>async function(r,a){return En({...e,getContent:async n=>vn(n,{manifest:e.manifest,namespace:e.namespace?e.namespace:r.env?r.env.__STATIC_CONTENT:void 0})})(r,a)},Tn=e=>Nn(e),et="_hp",An={Change:"Input",DoubleClick:"DblClick"},wn={svg:"2000/svg",math:"1998/Math/MathML"},tt=[],Yt=new WeakMap,We=void 0,_n=()=>We,Z=e=>"t"in e,Bt={onClick:["click",!1]},Rr=e=>{if(!e.startsWith("on"))return;if(Bt[e])return Bt[e];const t=e.match(/^on([A-Z][a-zA-Z]+?(?:PointerCapture)?)(Capture)?$/);if(t){const[,r,a]=t;return Bt[e]=[(An[r]||r).toLowerCase(),!!a]}},Sr=(e,t)=>We&&e instanceof SVGElement&&/[A-Z]/.test(t)&&(t in e.style||t.match(/^(?:o|pai|str|u|ve)/))?t.replace(/([A-Z])/g,"-$1").toLowerCase():t,Rn=(e,t,r)=>{var a;t||(t={});for(let s in t){const n=t[s];if(s!=="children"&&(!r||r[s]!==n)){s=St(s);const c=Rr(s);if(c){if((r==null?void 0:r[s])!==n&&(r&&e.removeEventListener(c[0],r[s],c[1]),n!=null)){if(typeof n!="function")throw new Error(`Event handler for "${s}" is not a function`);e.addEventListener(c[0],n,c[1])}}else if(s==="dangerouslySetInnerHTML"&&n)e.innerHTML=n.__html;else if(s==="ref"){let o;typeof n=="function"?o=n(e)||(()=>n(null)):n&&"current"in n&&(n.current=e,o=()=>n.current=null),Yt.set(e,o)}else if(s==="style"){const o=e.style;typeof n=="string"?o.cssText=n:(o.cssText="",n!=null&&ca(n,o.setProperty.bind(o)))}else{if(s==="value"){const d=e.nodeName;if(d==="INPUT"||d==="TEXTAREA"||d==="SELECT"){if(e.value=n==null||n===!1?null:n,d==="TEXTAREA"){e.textContent=n;continue}else if(d==="SELECT"){e.selectedIndex===-1&&(e.selectedIndex=0);continue}}}else(s==="checked"&&e.nodeName==="INPUT"||s==="selected"&&e.nodeName==="OPTION")&&(e[s]=n);const o=Sr(e,s);n==null||n===!1?e.removeAttribute(o):n===!0?e.setAttribute(o,""):typeof n=="string"||typeof n=="number"?e.setAttribute(o,n):e.setAttribute(o,n.toString())}}}if(r)for(let s in r){const n=r[s];if(s!=="children"&&!(s in t)){s=St(s);const c=Rr(s);c?e.removeEventListener(c[0],n,c[1]):s==="ref"?(a=Yt.get(e))==null||a():e.removeAttribute(Sr(e,s))}}},Sn=(e,t)=>{t[O][0]=0,tt.push([e,t]);const r=t.tag[sr]||t.tag,a=r.defaultProps?{...r.defaultProps,...t.props}:t.props;try{return[r.call(null,a)]}finally{tt.pop()}},Sa=(e,t,r,a,s)=>{var n,c;(n=e.vR)!=null&&n.length&&(a.push(...e.vR),delete e.vR),typeof e.tag=="function"&&((c=e[O][1][Ia])==null||c.forEach(o=>s.push(o))),e.vC.forEach(o=>{var d;if(Z(o))r.push(o);else if(typeof o.tag=="function"||o.tag===""){o.c=t;const l=r.length;if(Sa(o,t,r,a,s),o.s){for(let f=l;f<r.length;f++)r[f].s=!0;o.s=!1}}else r.push(o),(d=o.vR)!=null&&d.length&&(a.push(...o.vR),delete o.vR)})},Cn=e=>{for(;;e=e.tag===et||!e.vC||!e.pP?e.nN:e.vC[0]){if(!e)return null;if(e.tag!==et&&e.e)return e.e}},Ca=e=>{var t,r,a,s,n,c;Z(e)||((r=(t=e[O])==null?void 0:t[1][Ia])==null||r.forEach(o=>{var d;return(d=o[2])==null?void 0:d.call(o)}),(a=Yt.get(e.e))==null||a(),e.p===2&&((s=e.vC)==null||s.forEach(o=>o.p=2)),(n=e.vC)==null||n.forEach(Ca)),e.p||((c=e.e)==null||c.remove(),delete e.e),typeof e.tag=="function"&&(Ve.delete(e),At.delete(e),delete e[O][3],e.a=!0)},Oa=(e,t,r)=>{e.c=t,Da(e,t,r)},Cr=(e,t)=>{if(t){for(let r=0,a=e.length;r<a;r++)if(e[r]===t)return r}},Or=Symbol(),Da=(e,t,r)=>{var l;const a=[],s=[],n=[];Sa(e,t,a,s,n),s.forEach(Ca);const c=r?void 0:t.childNodes;let o,d=null;if(r)o=-1;else if(!c.length)o=0;else{const f=Cr(c,Cn(e.nN));f!==void 0?(d=c[f],o=f):o=Cr(c,(l=a.find(x=>x.tag!==et&&x.e))==null?void 0:l.e)??-1,o===-1&&(r=!0)}for(let f=0,x=a.length;f<x;f++,o++){const m=a[f];let h;if(m.s&&m.e)h=m.e,m.s=!1;else{const b=r||!m.e;Z(m)?(m.e&&m.d&&(m.e.textContent=m.t),m.d=!1,h=m.e||(m.e=document.createTextNode(m.t))):(h=m.e||(m.e=m.n?document.createElementNS(m.n,m.tag):document.createElement(m.tag)),Rn(h,m.props,m.pP),Da(m,h,b))}m.tag===et?o--:r?h.parentNode||t.appendChild(h):c[o]!==h&&c[o-1]!==h&&(c[o+1]===h?t.appendChild(c[o]):t.insertBefore(h,d||c[o]||null))}if(e.pP&&delete e.pP,n.length){const f=[],x=[];n.forEach(([,m,,h,b])=>{m&&f.push(m),h&&x.push(h),b==null||b()}),f.forEach(m=>m()),x.length&&requestAnimationFrame(()=>{x.forEach(m=>m())})}},On=(e,t)=>!!(e&&e.length===t.length&&e.every((r,a)=>r[1]===t[a][1])),At=new WeakMap,Zt=(e,t,r)=>{var n,c,o,d,l,f;const a=!r&&t.pC;r&&(t.pC||(t.pC=t.vC));let s;try{r||(r=typeof t.tag=="function"?Sn(e,t):ut(t.props.children)),((n=r[0])==null?void 0:n.tag)===""&&r[0][Jt]&&(s=r[0][Jt],e[5].push([e,s,t]));const x=a?[...t.pC]:t.vC?[...t.vC]:void 0,m=[];let h;for(let b=0;b<r.length;b++){Array.isArray(r[b])&&r.splice(b,1,...r[b].flat());let p=Dn(r[b]);if(p){typeof p.tag=="function"&&!p.tag[ra]&&(Xe.length>0&&(p[O][2]=Xe.map(N=>[N,N.values.at(-1)])),(c=e[5])!=null&&c.length&&(p[O][3]=e[5].at(-1)));let E;if(x&&x.length){const N=x.findIndex(Z(p)?T=>Z(T):p.key!==void 0?T=>T.key===p.key&&T.tag===p.tag:T=>T.tag===p.tag);N!==-1&&(E=x[N],x.splice(N,1))}if(E)if(Z(p))E.t!==p.t&&(E.t=p.t,E.d=!0),p=E;else{const N=E.pP=E.props;if(E.props=p.props,E.f||(E.f=p.f||t.f),typeof p.tag=="function"){const T=E[O][2];E[O][2]=p[O][2]||[],E[O][3]=p[O][3],!E.f&&((E.o||E)===p.o||(d=(o=E.tag)[bs])!=null&&d.call(o,N,E.props))&&On(T,E[O][2])&&(E.s=!0)}p=E}else if(!Z(p)&&We){const N=Je(We);N&&(p.n=N)}if(!Z(p)&&!p.s&&(Zt(e,p),delete p.f),m.push(p),h&&!h.s&&!p.s)for(let N=h;N&&!Z(N);N=(l=N.vC)==null?void 0:l.at(-1))N.nN=p;h=p}}t.vR=a?[...t.vC,...x||[]]:x||[],t.vC=m,a&&delete t.pC}catch(x){if(t.f=!0,x===Or){if(s)return;throw x}const[m,h,b]=((f=t[O])==null?void 0:f[3])||[];if(h){const p=()=>wt([0,!1,e[2]],b),E=At.get(b)||[];E.push(p),At.set(b,E);const N=h(x,()=>{const T=At.get(b);if(T){const R=T.indexOf(p);if(R!==-1)return T.splice(R,1),p()}});if(N){if(e[0]===1)e[1]=!0;else if(Zt(e,b,[N]),(h.length===1||e!==m)&&b.c){Oa(b,b.c,!1);return}throw Or}}throw x}finally{s&&e[5].pop()}},Dn=e=>{if(!(e==null||typeof e=="boolean")){if(typeof e=="string"||typeof e=="number")return{t:e.toString(),d:!0};if("vR"in e&&(e={tag:e.tag,props:e.props,key:e.key,f:e.f,type:e.tag,ref:e.props.ref,o:e.o||e}),typeof e.tag=="function")e[O]=[0,[]];else{const t=wn[e.tag];t&&(We||(We=sa("")),e.props.children=[{tag:We,props:{value:e.n=`http://www.w3.org/${t}`,children:e.props.children}}])}return e}},Dr=(e,t)=>{var r,a;(r=t[O][2])==null||r.forEach(([s,n])=>{s.values.push(n)});try{Zt(e,t,void 0)}catch{return}if(t.a){delete t.a;return}(a=t[O][2])==null||a.forEach(([s])=>{s.values.pop()}),(e[0]!==1||!e[1])&&Oa(t,t.c,!1)},Ve=new WeakMap,Ir=[],wt=async(e,t)=>{e[5]||(e[5]=[]);const r=Ve.get(t);r&&r[0](void 0);let a;const s=new Promise(n=>a=n);if(Ve.set(t,[a,()=>{e[2]?e[2](e,t,n=>{Dr(n,t)}).then(()=>a(t)):(Dr(e,t),a(t))}]),Ir.length)Ir.at(-1).add(t);else{await Promise.resolve();const n=Ve.get(t);n&&(Ve.delete(t),n[1]())}return s},In=(e,t,r)=>({tag:et,props:{children:e},key:r,e:t,p:1}),Ht=0,Ia=1,kt=2,Kt=3,Xt=new WeakMap,Ua=(e,t)=>!e||!t||e.length!==t.length||t.some((r,a)=>r!==e[a]),Un=void 0,Ur=[],Ln=e=>{var c;const t=()=>typeof e=="function"?e():e,r=tt.at(-1);if(!r)return[t(),()=>{}];const[,a]=r,s=(c=a[O][1])[Ht]||(c[Ht]=[]),n=a[O][0]++;return s[n]||(s[n]=[t(),o=>{const d=Un,l=s[n];if(typeof o=="function"&&(o=o(l[0])),!Object.is(o,l[0]))if(l[0]=o,Ur.length){const[f,x]=Ur.at(-1);Promise.all([f===3?a:wt([f,!1,d],a),x]).then(([m])=>{if(!m||!(f===2||f===3))return;const h=m.vC;requestAnimationFrame(()=>{setTimeout(()=>{h===m.vC&&wt([f===3?1:0,!1,d],m)})})})}else wt([0,!1,d],a)}])},dr=(e,t)=>{var o;const r=tt.at(-1);if(!r)return e;const[,a]=r,s=(o=a[O][1])[kt]||(o[kt]=[]),n=a[O][0]++,c=s[n];return Ua(c==null?void 0:c[1],t)?s[n]=[e,t]:e=s[n][0],e},Mn=e=>{const t=Xt.get(e);if(t){if(t.length===2)throw t[1];return t[0]}throw e.then(r=>Xt.set(e,[r]),r=>Xt.set(e,[void 0,r])),e},Fn=(e,t)=>{var o;const r=tt.at(-1);if(!r)return e();const[,a]=r,s=(o=a[O][1])[Kt]||(o[Kt]=[]),n=a[O][0]++,c=s[n];return Ua(c==null?void 0:c[1],t)&&(s[n]=[e(),t]),s[n][0]},Pn=sa({pending:!1,data:null,method:null,action:null}),Lr=new Set,jn=e=>{Lr.add(e),e.finally(()=>Lr.delete(e))},lr=(e,t)=>Fn(()=>r=>{let a;e&&(typeof e=="function"?a=e(r)||(()=>{e(null)}):e&&"current"in e&&(e.current=r,a=()=>{e.current=null}));const s=t(r);return()=>{s==null||s(),a==null||a()}},[e]),Ce=Object.create(null),bt=Object.create(null),pt=(e,t,r,a,s)=>{if(t!=null&&t.itemProp)return{tag:e,props:t,type:e,ref:t.ref};const n=document.head;let{onLoad:c,onError:o,precedence:d,blocking:l,...f}=t,x=null,m=!1;const h=yt[e];let b;if(h.length>0){const T=n.querySelectorAll(e);e:for(const R of T)for(const A of yt[e])if(R.getAttribute(A)===t[A]){x=R;break e}if(!x){const R=h.reduce((A,L)=>t[L]===void 0?A:`${A}-${L}-${t[L]}`,e);m=!bt[R],x=bt[R]||(bt[R]=(()=>{const A=document.createElement(e);for(const L of h)t[L]!==void 0&&A.setAttribute(L,t[L]),t.rel&&A.setAttribute("rel",t.rel);return A})())}}else b=n.querySelectorAll(e);d=a?d??"":void 0,a&&(f[gt]=d);const p=dr(T=>{if(h.length>0){let R=!1;for(const A of n.querySelectorAll(e)){if(R&&A.getAttribute(gt)!==d){n.insertBefore(T,A);return}A.getAttribute(gt)===d&&(R=!0)}n.appendChild(T)}else if(b){let R=!1;for(const A of b)if(A===T){R=!0;break}R||n.insertBefore(T,n.contains(b[0])?b[0]:n.querySelector(e)),b=void 0}},[d]),E=lr(t.ref,T=>{var L;const R=h[0];if(r===2&&(T.innerHTML=""),(m||b)&&p(T),!o&&!c)return;let A=Ce[L=T.getAttribute(R)]||(Ce[L]=new Promise((Re,he)=>{T.addEventListener("load",Re),T.addEventListener("error",he)}));c&&(A=A.then(c)),o&&(A=A.catch(o)),A.catch(()=>{})});if(s&&l==="render"){const T=yt[e][0];if(t[T]){const R=t[T],A=Ce[R]||(Ce[R]=new Promise((L,Re)=>{p(x),x.addEventListener("load",L),x.addEventListener("error",Re)}));Mn(A)}}const N={tag:e,type:e,props:{...f,ref:E},ref:E};return N.p=r,x&&(N.e=x),In(N,n)},$n=e=>{const t=_n(),r=t&&Je(t);return r!=null&&r.endsWith("svg")?{tag:"title",props:e,type:"title",ref:e.ref}:pt("title",e,void 0,!1,!1)},Bn=e=>!e||["src","async"].some(t=>!e[t])?{tag:"script",props:e,type:"script",ref:e.ref}:pt("script",e,1,!1,!0),Hn=e=>!e||!["href","precedence"].every(t=>t in e)?{tag:"style",props:e,type:"style",ref:e.ref}:(e["data-href"]=e.href,delete e.href,pt("style",e,2,!0,!0)),kn=e=>!e||["onLoad","onError"].some(t=>t in e)||e.rel==="stylesheet"&&(!("precedence"in e)||"disabled"in e)?{tag:"link",props:e,type:"link",ref:e.ref}:pt("link",e,1,"precedence"in e,!0),Kn=e=>pt("meta",e,void 0,!1,!1),La=Symbol(),Xn=e=>{const{action:t,...r}=e;typeof t!="function"&&(r.action=t);const[a,s]=Ln([null,!1]),n=dr(async l=>{const f=l.isTrusted?t:l.detail[La];if(typeof f!="function")return;l.preventDefault();const x=new FormData(l.target);s([x,!0]);const m=f(x);m instanceof Promise&&(jn(m),await m),s([null,!0])},[]),c=lr(e.ref,l=>(l.addEventListener("submit",n),()=>{l.removeEventListener("submit",n)})),[o,d]=a;return a[1]=!1,{tag:Pn,props:{value:{pending:o!==null,data:o,method:o?"post":null,action:o?t:null},children:{tag:"form",props:{...r,ref:c},type:"form",ref:c}},f:d}},Ma=(e,{formAction:t,...r})=>{if(typeof t=="function"){const a=dr(s=>{s.preventDefault(),s.currentTarget.form.dispatchEvent(new CustomEvent("submit",{detail:{[La]:t}}))},[]);r.ref=lr(r.ref,s=>(s.addEventListener("click",a),()=>{s.removeEventListener("click",a)}))}return{tag:e,props:r,type:e,ref:r.ref}},Wn=e=>Ma("input",e),Gn=e=>Ma("button",e);Object.assign(qt,{title:$n,script:Bn,style:Hn,link:kn,meta:Kn,form:Xn,input:Wn,button:Gn});nr(null);new TextEncoder;var Jn=nr(null),qn=(e,t,r,a)=>(s,n)=>{const c="<!DOCTYPE html>",o=r?Er(l=>r(l,e),{Layout:t,...n},s):s,d=hs`${B(c)}${Er(Jn.Provider,{value:e},o)}`;return e.html(d)},Vn=(e,t)=>function(a,s){const n=a.getLayout()??Os;return e&&a.setLayout(c=>e({...c,Layout:n},a)),a.setRenderer(qn(a,n,e)),s()};const zn=Vn(({children:e})=>i("html",{lang:"es",children:[i("head",{children:[i("meta",{charset:"UTF-8"}),i("meta",{name:"viewport",content:"width=device-width, initial-scale=1.0"}),i("title",{children:"Lyra Expenses - Sistema de Gastos y Viáticos"}),i("script",{src:"https://cdn.tailwindcss.com"}),i("link",{href:"https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css",rel:"stylesheet"}),i("link",{href:"/static/styles.css",rel:"stylesheet"}),i("script",{src:"https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"}),i("script",{src:"https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"}),i("script",{src:"https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"}),i("meta",{name:"description",content:"Sistema ejecutivo de gestión de gastos y viáticos multiempresa con soporte multimoneda. Basado en el modelo 4-D: Dinero, Decisión, Dirección, Disciplina."}),i("meta",{name:"author",content:"Lyra - Asistente Estratégico"}),i("link",{rel:"icon",type:"image/x-icon",href:"data:image/x-icon;base64,AAABAAEAEBAAAAAAAABoBQAAFgAAACgAAAAQAAAAIAAAAAEACAAAAAAAAAEAAAAAAAAAAAAAAAEAAAAAAAAAAAAA"})]}),i("body",{className:"bg-gray-100",children:[e,i("script",{src:"/static/app.js"})]})]})),V=new TextEncoder,we=new TextDecoder;function Fa(...e){const t=e.reduce((s,{length:n})=>s+n,0),r=new Uint8Array(t);let a=0;for(const s of e)r.set(s,a),a+=s.length;return r}function Yn(e){if(Uint8Array.prototype.toBase64)return e.toBase64();const t=32768,r=[];for(let a=0;a<e.length;a+=t)r.push(String.fromCharCode.apply(null,e.subarray(a,a+t)));return btoa(r.join(""))}function Zn(e){if(Uint8Array.fromBase64)return Uint8Array.fromBase64(e);const t=atob(e),r=new Uint8Array(t.length);for(let a=0;a<t.length;a++)r[a]=t.charCodeAt(a);return r}function _t(e){if(Uint8Array.fromBase64)return Uint8Array.fromBase64(typeof e=="string"?e:we.decode(e),{alphabet:"base64url"});let t=e;t instanceof Uint8Array&&(t=we.decode(t)),t=t.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"");try{return Zn(t)}catch{throw new TypeError("The input to be decoded is not correctly encoded.")}}function Wt(e){let t=e;return typeof t=="string"&&(t=V.encode(t)),Uint8Array.prototype.toBase64?t.toBase64({alphabet:"base64url",omitPadding:!0}):Yn(t).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}class _e extends Error{constructor(r,a){var s;super(r,a);y(this,"code","ERR_JOSE_GENERIC");this.name=this.constructor.name,(s=Error.captureStackTrace)==null||s.call(Error,this,this.constructor)}}y(_e,"code","ERR_JOSE_GENERIC");class H extends _e{constructor(r,a,s="unspecified",n="unspecified"){super(r,{cause:{claim:s,reason:n,payload:a}});y(this,"code","ERR_JWT_CLAIM_VALIDATION_FAILED");y(this,"claim");y(this,"reason");y(this,"payload");this.claim=s,this.reason=n,this.payload=a}}y(H,"code","ERR_JWT_CLAIM_VALIDATION_FAILED");class Qt extends _e{constructor(r,a,s="unspecified",n="unspecified"){super(r,{cause:{claim:s,reason:n,payload:a}});y(this,"code","ERR_JWT_EXPIRED");y(this,"claim");y(this,"reason");y(this,"payload");this.claim=s,this.reason=n,this.payload=a}}y(Qt,"code","ERR_JWT_EXPIRED");class ce extends _e{constructor(){super(...arguments);y(this,"code","ERR_JOSE_NOT_SUPPORTED")}}y(ce,"code","ERR_JOSE_NOT_SUPPORTED");class S extends _e{constructor(){super(...arguments);y(this,"code","ERR_JWS_INVALID")}}y(S,"code","ERR_JWS_INVALID");class It extends _e{constructor(){super(...arguments);y(this,"code","ERR_JWT_INVALID")}}y(It,"code","ERR_JWT_INVALID");class Pa extends _e{constructor(r="signature verification failed",a){super(r,a);y(this,"code","ERR_JWS_SIGNATURE_VERIFICATION_FAILED")}}y(Pa,"code","ERR_JWS_SIGNATURE_VERIFICATION_FAILED");function J(e,t="algorithm.name"){return new TypeError(`CryptoKey does not support this operation, its ${t} must be ${e}`)}function Oe(e,t){return e.name===t}function Gt(e){return parseInt(e.name.slice(4),10)}function Qn(e){switch(e){case"ES256":return"P-256";case"ES384":return"P-384";case"ES512":return"P-521";default:throw new Error("unreachable")}}function ei(e,t){if(t&&!e.usages.includes(t))throw new TypeError(`CryptoKey does not support this operation, its usages must include ${t}.`)}function ti(e,t,r){switch(t){case"HS256":case"HS384":case"HS512":{if(!Oe(e.algorithm,"HMAC"))throw J("HMAC");const a=parseInt(t.slice(2),10);if(Gt(e.algorithm.hash)!==a)throw J(`SHA-${a}`,"algorithm.hash");break}case"RS256":case"RS384":case"RS512":{if(!Oe(e.algorithm,"RSASSA-PKCS1-v1_5"))throw J("RSASSA-PKCS1-v1_5");const a=parseInt(t.slice(2),10);if(Gt(e.algorithm.hash)!==a)throw J(`SHA-${a}`,"algorithm.hash");break}case"PS256":case"PS384":case"PS512":{if(!Oe(e.algorithm,"RSA-PSS"))throw J("RSA-PSS");const a=parseInt(t.slice(2),10);if(Gt(e.algorithm.hash)!==a)throw J(`SHA-${a}`,"algorithm.hash");break}case"Ed25519":case"EdDSA":{if(!Oe(e.algorithm,"Ed25519"))throw J("Ed25519");break}case"ML-DSA-44":case"ML-DSA-65":case"ML-DSA-87":{if(!Oe(e.algorithm,t))throw J(t);break}case"ES256":case"ES384":case"ES512":{if(!Oe(e.algorithm,"ECDSA"))throw J("ECDSA");const a=Qn(t);if(e.algorithm.namedCurve!==a)throw J(a,"algorithm.namedCurve");break}default:throw new TypeError("CryptoKey does not support this operation")}ei(e,r)}function ja(e,t,...r){var a;if(r=r.filter(Boolean),r.length>2){const s=r.pop();e+=`one of type ${r.join(", ")}, or ${s}.`}else r.length===2?e+=`one of type ${r[0]} or ${r[1]}.`:e+=`of type ${r[0]}.`;return t==null?e+=` Received ${t}`:typeof t=="function"&&t.name?e+=` Received function ${t.name}`:typeof t=="object"&&t!=null&&(a=t.constructor)!=null&&a.name&&(e+=` Received an instance of ${t.constructor.name}`),e}const ri=(e,...t)=>ja("Key must be ",e,...t);function $a(e,t,...r){return ja(`Key for the ${e} algorithm must be `,t,...r)}function Ba(e){return(e==null?void 0:e[Symbol.toStringTag])==="CryptoKey"}function Ha(e){return(e==null?void 0:e[Symbol.toStringTag])==="KeyObject"}const ka=e=>Ba(e)||Ha(e),Ka=(...e)=>{const t=e.filter(Boolean);if(t.length===0||t.length===1)return!0;let r;for(const a of t){const s=Object.keys(a);if(!r||r.size===0){r=new Set(s);continue}for(const n of s){if(r.has(n))return!1;r.add(n)}}return!0};function ai(e){return typeof e=="object"&&e!==null}const rt=e=>{if(!ai(e)||Object.prototype.toString.call(e)!=="[object Object]")return!1;if(Object.getPrototypeOf(e)===null)return!0;let t=e;for(;Object.getPrototypeOf(t)!==null;)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t},Xa=(e,t)=>{if(e.startsWith("RS")||e.startsWith("PS")){const{modulusLength:r}=t.algorithm;if(typeof r!="number"||r<2048)throw new TypeError(`${e} requires key modulusLength to be 2048 bits or larger`)}};function si(e){let t,r;switch(e.kty){case"AKP":{switch(e.alg){case"ML-DSA-44":case"ML-DSA-65":case"ML-DSA-87":t={name:e.alg},r=e.priv?["sign"]:["verify"];break;default:throw new ce('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break}case"RSA":{switch(e.alg){case"PS256":case"PS384":case"PS512":t={name:"RSA-PSS",hash:`SHA-${e.alg.slice(-3)}`},r=e.d?["sign"]:["verify"];break;case"RS256":case"RS384":case"RS512":t={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${e.alg.slice(-3)}`},r=e.d?["sign"]:["verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":t={name:"RSA-OAEP",hash:`SHA-${parseInt(e.alg.slice(-3),10)||1}`},r=e.d?["decrypt","unwrapKey"]:["encrypt","wrapKey"];break;default:throw new ce('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break}case"EC":{switch(e.alg){case"ES256":t={name:"ECDSA",namedCurve:"P-256"},r=e.d?["sign"]:["verify"];break;case"ES384":t={name:"ECDSA",namedCurve:"P-384"},r=e.d?["sign"]:["verify"];break;case"ES512":t={name:"ECDSA",namedCurve:"P-521"},r=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:"ECDH",namedCurve:e.crv},r=e.d?["deriveBits"]:[];break;default:throw new ce('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break}case"OKP":{switch(e.alg){case"Ed25519":case"EdDSA":t={name:"Ed25519"},r=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:e.crv},r=e.d?["deriveBits"]:[];break;default:throw new ce('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break}default:throw new ce('Invalid or unsupported JWK "kty" (Key Type) Parameter value')}return{algorithm:t,keyUsages:r}}const ni=async e=>{if(!e.alg)throw new TypeError('"alg" argument is required when "jwk.alg" is not present');const{algorithm:t,keyUsages:r}=si(e),a={...e};return a.kty!=="AKP"&&delete a.alg,delete a.use,crypto.subtle.importKey("jwk",a,t,e.ext??!(e.d||e.priv),e.key_ops??r)},Wa=(e,t,r,a,s)=>{if(s.crit!==void 0&&(a==null?void 0:a.crit)===void 0)throw new e('"crit" (Critical) Header Parameter MUST be integrity protected');if(!a||a.crit===void 0)return new Set;if(!Array.isArray(a.crit)||a.crit.length===0||a.crit.some(c=>typeof c!="string"||c.length===0))throw new e('"crit" (Critical) Header Parameter MUST be an array of non-empty strings when present');let n;r!==void 0?n=new Map([...Object.entries(r),...t.entries()]):n=t;for(const c of a.crit){if(!n.has(c))throw new ce(`Extension Header Parameter "${c}" is not recognized`);if(s[c]===void 0)throw new e(`Extension Header Parameter "${c}" is missing`);if(n.get(c)&&a[c]===void 0)throw new e(`Extension Header Parameter "${c}" MUST be integrity protected`)}return new Set(a.crit)};function fr(e){return rt(e)&&typeof e.kty=="string"}function ii(e){return e.kty!=="oct"&&(e.kty==="AKP"&&typeof e.priv=="string"||typeof e.d=="string")}function ci(e){return e.kty!=="oct"&&typeof e.d>"u"&&typeof e.priv>"u"}function oi(e){return e.kty==="oct"&&typeof e.k=="string"}let Pe;const Mr=async(e,t,r,a=!1)=>{Pe||(Pe=new WeakMap);let s=Pe.get(e);if(s!=null&&s[r])return s[r];const n=await ni({...t,alg:r});return a&&Object.freeze(e),s?s[r]=n:Pe.set(e,{[r]:n}),n},di=(e,t)=>{var c;Pe||(Pe=new WeakMap);let r=Pe.get(e);if(r!=null&&r[t])return r[t];const a=e.type==="public",s=!!a;let n;if(e.asymmetricKeyType==="x25519"){switch(t){case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":break;default:throw new TypeError("given KeyObject instance cannot be used for this algorithm")}n=e.toCryptoKey(e.asymmetricKeyType,s,a?[]:["deriveBits"])}if(e.asymmetricKeyType==="ed25519"){if(t!=="EdDSA"&&t!=="Ed25519")throw new TypeError("given KeyObject instance cannot be used for this algorithm");n=e.toCryptoKey(e.asymmetricKeyType,s,[a?"verify":"sign"])}switch(e.asymmetricKeyType){case"ml-dsa-44":case"ml-dsa-65":case"ml-dsa-87":{if(t!==e.asymmetricKeyType.toUpperCase())throw new TypeError("given KeyObject instance cannot be used for this algorithm");n=e.toCryptoKey(e.asymmetricKeyType,s,[a?"verify":"sign"])}}if(e.asymmetricKeyType==="rsa"){let o;switch(t){case"RSA-OAEP":o="SHA-1";break;case"RS256":case"PS256":case"RSA-OAEP-256":o="SHA-256";break;case"RS384":case"PS384":case"RSA-OAEP-384":o="SHA-384";break;case"RS512":case"PS512":case"RSA-OAEP-512":o="SHA-512";break;default:throw new TypeError("given KeyObject instance cannot be used for this algorithm")}if(t.startsWith("RSA-OAEP"))return e.toCryptoKey({name:"RSA-OAEP",hash:o},s,a?["encrypt"]:["decrypt"]);n=e.toCryptoKey({name:t.startsWith("PS")?"RSA-PSS":"RSASSA-PKCS1-v1_5",hash:o},s,[a?"verify":"sign"])}if(e.asymmetricKeyType==="ec"){const d=new Map([["prime256v1","P-256"],["secp384r1","P-384"],["secp521r1","P-521"]]).get((c=e.asymmetricKeyDetails)==null?void 0:c.namedCurve);if(!d)throw new TypeError("given KeyObject instance cannot be used for this algorithm");t==="ES256"&&d==="P-256"&&(n=e.toCryptoKey({name:"ECDSA",namedCurve:d},s,[a?"verify":"sign"])),t==="ES384"&&d==="P-384"&&(n=e.toCryptoKey({name:"ECDSA",namedCurve:d},s,[a?"verify":"sign"])),t==="ES512"&&d==="P-521"&&(n=e.toCryptoKey({name:"ECDSA",namedCurve:d},s,[a?"verify":"sign"])),t.startsWith("ECDH-ES")&&(n=e.toCryptoKey({name:"ECDH",namedCurve:d},s,a?[]:["deriveBits"]))}if(!n)throw new TypeError("given KeyObject instance cannot be used for this algorithm");return r?r[t]=n:Pe.set(e,{[t]:n}),n},Ga=async(e,t)=>{if(e instanceof Uint8Array||Ba(e))return e;if(Ha(e)){if(e.type==="secret")return e.export();if("toCryptoKey"in e&&typeof e.toCryptoKey=="function")try{return di(e,t)}catch(a){if(a instanceof TypeError)throw a}let r=e.export({format:"jwk"});return Mr(e,r,t)}if(fr(e))return e.k?_t(e.k):Mr(e,e,t,!0);throw new Error("unreachable")},Me=e=>e==null?void 0:e[Symbol.toStringTag],er=(e,t,r)=>{var a,s;if(t.use!==void 0){let n;switch(r){case"sign":case"verify":n="sig";break;case"encrypt":case"decrypt":n="enc";break}if(t.use!==n)throw new TypeError(`Invalid key for this operation, its "use" must be "${n}" when present`)}if(t.alg!==void 0&&t.alg!==e)throw new TypeError(`Invalid key for this operation, its "alg" must be "${e}" when present`);if(Array.isArray(t.key_ops)){let n;switch(!0){case(r==="sign"||r==="verify"):case e==="dir":case e.includes("CBC-HS"):n=r;break;case e.startsWith("PBES2"):n="deriveBits";break;case/^A\d{3}(?:GCM)?(?:KW)?$/.test(e):!e.includes("GCM")&&e.endsWith("KW")?n=r==="encrypt"?"wrapKey":"unwrapKey":n=r;break;case(r==="encrypt"&&e.startsWith("RSA")):n="wrapKey";break;case r==="decrypt":n=e.startsWith("RSA")?"unwrapKey":"deriveBits";break}if(n&&((s=(a=t.key_ops)==null?void 0:a.includes)==null?void 0:s.call(a,n))===!1)throw new TypeError(`Invalid key for this operation, its "key_ops" must include "${n}" when present`)}return!0},li=(e,t,r)=>{if(!(t instanceof Uint8Array)){if(fr(t)){if(oi(t)&&er(e,t,r))return;throw new TypeError('JSON Web Key for symmetric algorithms must have JWK "kty" (Key Type) equal to "oct" and the JWK "k" (Key Value) present')}if(!ka(t))throw new TypeError($a(e,t,"CryptoKey","KeyObject","JSON Web Key","Uint8Array"));if(t.type!=="secret")throw new TypeError(`${Me(t)} instances for symmetric algorithms must be of type "secret"`)}},fi=(e,t,r)=>{if(fr(t))switch(r){case"decrypt":case"sign":if(ii(t)&&er(e,t,r))return;throw new TypeError("JSON Web Key for this operation be a private JWK");case"encrypt":case"verify":if(ci(t)&&er(e,t,r))return;throw new TypeError("JSON Web Key for this operation be a public JWK")}if(!ka(t))throw new TypeError($a(e,t,"CryptoKey","KeyObject","JSON Web Key"));if(t.type==="secret")throw new TypeError(`${Me(t)} instances for asymmetric algorithms must not be of type "secret"`);if(t.type==="public")switch(r){case"sign":throw new TypeError(`${Me(t)} instances for asymmetric algorithm signing must be of type "private"`);case"decrypt":throw new TypeError(`${Me(t)} instances for asymmetric algorithm decryption must be of type "private"`)}if(t.type==="private")switch(r){case"verify":throw new TypeError(`${Me(t)} instances for asymmetric algorithm verifying must be of type "public"`);case"encrypt":throw new TypeError(`${Me(t)} instances for asymmetric algorithm encryption must be of type "public"`)}},Ja=(e,t,r)=>{e.startsWith("HS")||e==="dir"||e.startsWith("PBES2")||/^A(?:128|192|256)(?:GCM)?(?:KW)?$/.test(e)||/^A(?:128|192|256)CBC-HS(?:256|384|512)$/.test(e)?li(e,t,r):fi(e,t,r)},qa=(e,t)=>{const r=`SHA-${e.slice(-3)}`;switch(e){case"HS256":case"HS384":case"HS512":return{hash:r,name:"HMAC"};case"PS256":case"PS384":case"PS512":return{hash:r,name:"RSA-PSS",saltLength:parseInt(e.slice(-3),10)>>3};case"RS256":case"RS384":case"RS512":return{hash:r,name:"RSASSA-PKCS1-v1_5"};case"ES256":case"ES384":case"ES512":return{hash:r,name:"ECDSA",namedCurve:t.namedCurve};case"Ed25519":case"EdDSA":return{name:"Ed25519"};case"ML-DSA-44":case"ML-DSA-65":case"ML-DSA-87":return{name:e};default:throw new ce(`alg ${e} is not supported either by JOSE or your javascript runtime`)}},Va=async(e,t,r)=>{if(t instanceof Uint8Array){if(!e.startsWith("HS"))throw new TypeError(ri(t,"CryptoKey","KeyObject","JSON Web Key"));return crypto.subtle.importKey("raw",t,{hash:`SHA-${e.slice(-3)}`,name:"HMAC"},!1,[r])}return ti(t,e,r),t},ui=async(e,t,r,a)=>{const s=await Va(e,t,"verify");Xa(e,s);const n=qa(e,s.algorithm);try{return await crypto.subtle.verify(n,s,r,a)}catch{return!1}};async function xi(e,t,r){if(!rt(e))throw new S("Flattened JWS must be an object");if(e.protected===void 0&&e.header===void 0)throw new S('Flattened JWS must have either of the "protected" or "header" members');if(e.protected!==void 0&&typeof e.protected!="string")throw new S("JWS Protected Header incorrect type");if(e.payload===void 0)throw new S("JWS Payload missing");if(typeof e.signature!="string")throw new S("JWS Signature missing or incorrect type");if(e.header!==void 0&&!rt(e.header))throw new S("JWS Unprotected Header incorrect type");let a={};if(e.protected)try{const p=_t(e.protected);a=JSON.parse(we.decode(p))}catch{throw new S("JWS Protected Header is invalid")}if(!Ka(a,e.header))throw new S("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");const s={...a,...e.header},n=Wa(S,new Map([["b64",!0]]),r==null?void 0:r.crit,a,s);let c=!0;if(n.has("b64")&&(c=a.b64,typeof c!="boolean"))throw new S('The "b64" (base64url-encode payload) Header Parameter must be a boolean');const{alg:o}=s;if(typeof o!="string"||!o)throw new S('JWS "alg" (Algorithm) Header Parameter missing or invalid');if(c){if(typeof e.payload!="string")throw new S("JWS Payload must be a string")}else if(typeof e.payload!="string"&&!(e.payload instanceof Uint8Array))throw new S("JWS Payload must be a string or an Uint8Array instance");let d=!1;typeof t=="function"&&(t=await t(a,e),d=!0),Ja(o,t,"verify");const l=Fa(V.encode(e.protected??""),V.encode("."),typeof e.payload=="string"?V.encode(e.payload):e.payload);let f;try{f=_t(e.signature)}catch{throw new S("Failed to base64url decode the signature")}const x=await Ga(t,o);if(!await ui(o,x,f,l))throw new Pa;let h;if(c)try{h=_t(e.payload)}catch{throw new S("Failed to base64url decode the payload")}else typeof e.payload=="string"?h=V.encode(e.payload):h=e.payload;const b={payload:h};return e.protected!==void 0&&(b.protectedHeader=a),e.header!==void 0&&(b.unprotectedHeader=e.header),d?{...b,key:x}:b}async function mi(e,t,r){if(e instanceof Uint8Array&&(e=we.decode(e)),typeof e!="string")throw new S("Compact JWS must be a string or Uint8Array");const{0:a,1:s,2:n,length:c}=e.split(".");if(c!==3)throw new S("Invalid Compact JWS");const o=await xi({payload:s,protected:a,signature:n},t,r),d={payload:o.payload,protectedHeader:o.protectedHeader};return typeof t=="function"?{...d,key:o.key}:d}const ie=e=>Math.floor(e.getTime()/1e3),za=60,Ya=za*60,ur=Ya*24,pi=ur*7,hi=ur*365.25,bi=/^(\+|\-)? ?(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)(?: (ago|from now))?$/i,Ze=e=>{const t=bi.exec(e);if(!t||t[4]&&t[1])throw new TypeError("Invalid time period format");const r=parseFloat(t[2]),a=t[3].toLowerCase();let s;switch(a){case"sec":case"secs":case"second":case"seconds":case"s":s=Math.round(r);break;case"minute":case"minutes":case"min":case"mins":case"m":s=Math.round(r*za);break;case"hour":case"hours":case"hr":case"hrs":case"h":s=Math.round(r*Ya);break;case"day":case"days":case"d":s=Math.round(r*ur);break;case"week":case"weeks":case"w":s=Math.round(r*pi);break;default:s=Math.round(r*hi);break}return t[1]==="-"||t[4]==="ago"?-s:s};function be(e,t){if(!Number.isFinite(t))throw new TypeError(`Invalid ${e} input`);return t}const Fr=e=>e.includes("/")?e.toLowerCase():`application/${e.toLowerCase()}`,yi=(e,t)=>typeof e=="string"?t.includes(e):Array.isArray(e)?t.some(Set.prototype.has.bind(new Set(e))):!1;function gi(e,t,r={}){let a;try{a=JSON.parse(we.decode(t))}catch{}if(!rt(a))throw new It("JWT Claims Set must be a top-level JSON object");const{typ:s}=r;if(s&&(typeof e.typ!="string"||Fr(e.typ)!==Fr(s)))throw new H('unexpected "typ" JWT header value',a,"typ","check_failed");const{requiredClaims:n=[],issuer:c,subject:o,audience:d,maxTokenAge:l}=r,f=[...n];l!==void 0&&f.push("iat"),d!==void 0&&f.push("aud"),o!==void 0&&f.push("sub"),c!==void 0&&f.push("iss");for(const b of new Set(f.reverse()))if(!(b in a))throw new H(`missing required "${b}" claim`,a,b,"missing");if(c&&!(Array.isArray(c)?c:[c]).includes(a.iss))throw new H('unexpected "iss" claim value',a,"iss","check_failed");if(o&&a.sub!==o)throw new H('unexpected "sub" claim value',a,"sub","check_failed");if(d&&!yi(a.aud,typeof d=="string"?[d]:d))throw new H('unexpected "aud" claim value',a,"aud","check_failed");let x;switch(typeof r.clockTolerance){case"string":x=Ze(r.clockTolerance);break;case"number":x=r.clockTolerance;break;case"undefined":x=0;break;default:throw new TypeError("Invalid clockTolerance option type")}const{currentDate:m}=r,h=ie(m||new Date);if((a.iat!==void 0||l)&&typeof a.iat!="number")throw new H('"iat" claim must be a number',a,"iat","invalid");if(a.nbf!==void 0){if(typeof a.nbf!="number")throw new H('"nbf" claim must be a number',a,"nbf","invalid");if(a.nbf>h+x)throw new H('"nbf" claim timestamp check failed',a,"nbf","check_failed")}if(a.exp!==void 0){if(typeof a.exp!="number")throw new H('"exp" claim must be a number',a,"exp","invalid");if(a.exp<=h-x)throw new Qt('"exp" claim timestamp check failed',a,"exp","check_failed")}if(l){const b=h-a.iat,p=typeof l=="number"?l:Ze(l);if(b-x>p)throw new Qt('"iat" claim timestamp check failed (too far in the past)',a,"iat","check_failed");if(b<0-x)throw new H('"iat" claim timestamp check failed (it should be in the past)',a,"iat","check_failed")}return a}var C;class Ei{constructor(t){v(this,C);if(!rt(t))throw new TypeError("JWT Claims Set MUST be an object");g(this,C,structuredClone(t))}data(){return V.encode(JSON.stringify(u(this,C)))}get iss(){return u(this,C).iss}set iss(t){u(this,C).iss=t}get sub(){return u(this,C).sub}set sub(t){u(this,C).sub=t}get aud(){return u(this,C).aud}set aud(t){u(this,C).aud=t}set jti(t){u(this,C).jti=t}set nbf(t){typeof t=="number"?u(this,C).nbf=be("setNotBefore",t):t instanceof Date?u(this,C).nbf=be("setNotBefore",ie(t)):u(this,C).nbf=ie(new Date)+Ze(t)}set exp(t){typeof t=="number"?u(this,C).exp=be("setExpirationTime",t):t instanceof Date?u(this,C).exp=be("setExpirationTime",ie(t)):u(this,C).exp=ie(new Date)+Ze(t)}set iat(t){typeof t>"u"?u(this,C).iat=ie(new Date):t instanceof Date?u(this,C).iat=be("setIssuedAt",ie(t)):typeof t=="string"?u(this,C).iat=be("setIssuedAt",ie(new Date)+Ze(t)):u(this,C).iat=be("setIssuedAt",t)}}C=new WeakMap;async function vi(e,t,r){var c;const a=await mi(e,t,r);if((c=a.protectedHeader.crit)!=null&&c.includes("b64")&&a.protectedHeader.b64===!1)throw new It("JWTs MUST NOT use unencoded payload");const n={payload:gi(a.protectedHeader,a.payload,r),protectedHeader:a.protectedHeader};return typeof t=="function"?{...n,key:a.key}:n}const Ni=async(e,t,r)=>{const a=await Va(e,t,"sign");Xa(e,a);const s=await crypto.subtle.sign(qa(e,a.algorithm),a,r);return new Uint8Array(s)};var ft,P,q;class Ti{constructor(t){v(this,ft);v(this,P);v(this,q);if(!(t instanceof Uint8Array))throw new TypeError("payload must be an instance of Uint8Array");g(this,ft,t)}setProtectedHeader(t){if(u(this,P))throw new TypeError("setProtectedHeader can only be called once");return g(this,P,t),this}setUnprotectedHeader(t){if(u(this,q))throw new TypeError("setUnprotectedHeader can only be called once");return g(this,q,t),this}async sign(t,r){if(!u(this,P)&&!u(this,q))throw new S("either setProtectedHeader or setUnprotectedHeader must be called before #sign()");if(!Ka(u(this,P),u(this,q)))throw new S("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");const a={...u(this,P),...u(this,q)},s=Wa(S,new Map([["b64",!0]]),r==null?void 0:r.crit,u(this,P),a);let n=!0;if(s.has("b64")&&(n=u(this,P).b64,typeof n!="boolean"))throw new S('The "b64" (base64url-encode payload) Header Parameter must be a boolean');const{alg:c}=a;if(typeof c!="string"||!c)throw new S('JWS "alg" (Algorithm) Header Parameter missing or invalid');Ja(c,t,"sign");let o=u(this,ft);n&&(o=V.encode(Wt(o)));let d;u(this,P)?d=V.encode(Wt(JSON.stringify(u(this,P)))):d=V.encode("");const l=Fa(d,V.encode("."),o),f=await Ga(t,c),x=await Ni(c,f,l),m={signature:Wt(x),payload:""};return n&&(m.payload=we.decode(o)),u(this,q)&&(m.header=u(this,q)),u(this,P)&&(m.protected=we.decode(d)),m}}ft=new WeakMap,P=new WeakMap,q=new WeakMap;var Ke;class Ai{constructor(t){v(this,Ke);g(this,Ke,new Ti(t))}setProtectedHeader(t){return u(this,Ke).setProtectedHeader(t),this}async sign(t,r){const a=await u(this,Ke).sign(t,r);if(a.payload===void 0)throw new TypeError("use the flattened module for creating JWS with b64: false");return`${a.protected}.${a.payload}.${a.signature}`}}Ke=new WeakMap;var me,$;class Pr{constructor(t={}){v(this,me);v(this,$);g(this,$,new Ei(t))}setIssuer(t){return u(this,$).iss=t,this}setSubject(t){return u(this,$).sub=t,this}setAudience(t){return u(this,$).aud=t,this}setJti(t){return u(this,$).jti=t,this}setNotBefore(t){return u(this,$).nbf=t,this}setExpirationTime(t){return u(this,$).exp=t,this}setIssuedAt(t){return u(this,$).iat=t,this}setProtectedHeader(t){return g(this,me,t),this}async sign(t,r){var s;const a=new Ai(u(this,$).data());if(a.setProtectedHeader(u(this,me)),Array.isArray((s=u(this,me))==null?void 0:s.crit)&&u(this,me).crit.includes("b64")&&u(this,me).b64===!1)throw new It("JWTs MUST NOT use unencoded payload");return a.sign(t,r)}}me=new WeakMap,$=new WeakMap;var tr=null;function wi(e){try{return crypto.getRandomValues(new Uint8Array(e))}catch{}try{return ms.randomBytes(e)}catch{}if(!tr)throw Error("Neither WebCryptoAPI nor a crypto module is available. Use bcrypt.setRandomFallback to set an alternative");return tr(e)}function _i(e){tr=e}function xr(e,t){if(e=e||mr,typeof e!="number")throw Error("Illegal arguments: "+typeof e+", "+typeof t);e<4?e=4:e>31&&(e=31);var r=[];return r.push("$2b$"),e<10&&r.push("0"),r.push(e.toString()),r.push("$"),r.push(Ot(wi(at),at)),r.join("")}function Za(e,t,r){if(typeof t=="function"&&(r=t,t=void 0),typeof e=="function"&&(r=e,e=void 0),typeof e>"u")e=mr;else if(typeof e!="number")throw Error("illegal arguments: "+typeof e);function a(s){W(function(){try{s(null,xr(e))}catch(n){s(n)}})}if(r){if(typeof r!="function")throw Error("Illegal callback: "+typeof r);a(r)}else return new Promise(function(s,n){a(function(c,o){if(c){n(c);return}s(o)})})}function Qa(e,t){if(typeof t>"u"&&(t=mr),typeof t=="number"&&(t=xr(t)),typeof e!="string"||typeof t!="string")throw Error("Illegal arguments: "+typeof e+", "+typeof t);return rr(e,t)}function es(e,t,r,a){function s(n){typeof e=="string"&&typeof t=="number"?Za(t,function(c,o){rr(e,o,n,a)}):typeof e=="string"&&typeof t=="string"?rr(e,t,n,a):W(n.bind(this,Error("Illegal arguments: "+typeof e+", "+typeof t)))}if(r){if(typeof r!="function")throw Error("Illegal callback: "+typeof r);s(r)}else return new Promise(function(n,c){s(function(o,d){if(o){c(o);return}n(d)})})}function ts(e,t){for(var r=e.length^t.length,a=0;a<e.length;++a)r|=e.charCodeAt(a)^t.charCodeAt(a);return r===0}function Ri(e,t){if(typeof e!="string"||typeof t!="string")throw Error("Illegal arguments: "+typeof e+", "+typeof t);return t.length!==60?!1:ts(Qa(e,t.substring(0,t.length-31)),t)}function Si(e,t,r,a){function s(n){if(typeof e!="string"||typeof t!="string"){W(n.bind(this,Error("Illegal arguments: "+typeof e+", "+typeof t)));return}if(t.length!==60){W(n.bind(this,null,!1));return}es(e,t.substring(0,29),function(c,o){c?n(c):n(null,ts(o,t))},a)}if(r){if(typeof r!="function")throw Error("Illegal callback: "+typeof r);s(r)}else return new Promise(function(n,c){s(function(o,d){if(o){c(o);return}n(d)})})}function Ci(e){if(typeof e!="string")throw Error("Illegal arguments: "+typeof e);return parseInt(e.split("$")[2],10)}function Oi(e){if(typeof e!="string")throw Error("Illegal arguments: "+typeof e);if(e.length!==60)throw Error("Illegal hash length: "+e.length+" != 60");return e.substring(0,29)}function Di(e){if(typeof e!="string")throw Error("Illegal arguments: "+typeof e);return rs(e)>72}var W=typeof process<"u"&&process&&typeof process.nextTick=="function"?typeof setImmediate=="function"?setImmediate:process.nextTick:setTimeout;function rs(e){for(var t=0,r=0,a=0;a<e.length;++a)r=e.charCodeAt(a),r<128?t+=1:r<2048?t+=2:(r&64512)===55296&&(e.charCodeAt(a+1)&64512)===56320?(++a,t+=4):t+=3;return t}function Ii(e){for(var t=0,r,a,s=new Array(rs(e)),n=0,c=e.length;n<c;++n)r=e.charCodeAt(n),r<128?s[t++]=r:r<2048?(s[t++]=r>>6|192,s[t++]=r&63|128):(r&64512)===55296&&((a=e.charCodeAt(n+1))&64512)===56320?(r=65536+((r&1023)<<10)+(a&1023),++n,s[t++]=r>>18|240,s[t++]=r>>12&63|128,s[t++]=r>>6&63|128,s[t++]=r&63|128):(s[t++]=r>>12|224,s[t++]=r>>6&63|128,s[t++]=r&63|128);return s}var De="./ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".split(""),ne=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,54,55,56,57,58,59,60,61,62,63,-1,-1,-1,-1,-1,-1,-1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,-1,-1,-1,-1,-1,-1,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,-1,-1,-1,-1,-1];function Ot(e,t){var r=0,a=[],s,n;if(t<=0||t>e.length)throw Error("Illegal len: "+t);for(;r<t;){if(s=e[r++]&255,a.push(De[s>>2&63]),s=(s&3)<<4,r>=t){a.push(De[s&63]);break}if(n=e[r++]&255,s|=n>>4&15,a.push(De[s&63]),s=(n&15)<<2,r>=t){a.push(De[s&63]);break}n=e[r++]&255,s|=n>>6&3,a.push(De[s&63]),a.push(De[n&63])}return a.join("")}function as(e,t){var r=0,a=e.length,s=0,n=[],c,o,d,l,f,x;if(t<=0)throw Error("Illegal len: "+t);for(;r<a-1&&s<t&&(x=e.charCodeAt(r++),c=x<ne.length?ne[x]:-1,x=e.charCodeAt(r++),o=x<ne.length?ne[x]:-1,!(c==-1||o==-1||(f=c<<2>>>0,f|=(o&48)>>4,n.push(String.fromCharCode(f)),++s>=t||r>=a)||(x=e.charCodeAt(r++),d=x<ne.length?ne[x]:-1,d==-1)||(f=(o&15)<<4>>>0,f|=(d&60)>>2,n.push(String.fromCharCode(f)),++s>=t||r>=a)));)x=e.charCodeAt(r++),l=x<ne.length?ne[x]:-1,f=(d&3)<<6>>>0,f|=l,n.push(String.fromCharCode(f)),++s;var m=[];for(r=0;r<s;r++)m.push(n[r].charCodeAt(0));return m}var at=16,mr=10,Ui=16,Li=100,jr=[608135816,2242054355,320440878,57701188,2752067618,698298832,137296536,3964562569,1160258022,953160567,3193202383,887688300,3232508343,3380367581,1065670069,3041331479,2450970073,2306472731],$r=[3509652390,2564797868,805139163,3491422135,3101798381,1780907670,3128725573,4046225305,614570311,3012652279,134345442,2240740374,1667834072,1901547113,2757295779,4103290238,227898511,1921955416,1904987480,2182433518,2069144605,3260701109,2620446009,720527379,3318853667,677414384,3393288472,3101374703,2390351024,1614419982,1822297739,2954791486,3608508353,3174124327,2024746970,1432378464,3864339955,2857741204,1464375394,1676153920,1439316330,715854006,3033291828,289532110,2706671279,2087905683,3018724369,1668267050,732546397,1947742710,3462151702,2609353502,2950085171,1814351708,2050118529,680887927,999245976,1800124847,3300911131,1713906067,1641548236,4213287313,1216130144,1575780402,4018429277,3917837745,3693486850,3949271944,596196993,3549867205,258830323,2213823033,772490370,2760122372,1774776394,2652871518,566650946,4142492826,1728879713,2882767088,1783734482,3629395816,2517608232,2874225571,1861159788,326777828,3124490320,2130389656,2716951837,967770486,1724537150,2185432712,2364442137,1164943284,2105845187,998989502,3765401048,2244026483,1075463327,1455516326,1322494562,910128902,469688178,1117454909,936433444,3490320968,3675253459,1240580251,122909385,2157517691,634681816,4142456567,3825094682,3061402683,2540495037,79693498,3249098678,1084186820,1583128258,426386531,1761308591,1047286709,322548459,995290223,1845252383,2603652396,3431023940,2942221577,3202600964,3727903485,1712269319,422464435,3234572375,1170764815,3523960633,3117677531,1434042557,442511882,3600875718,1076654713,1738483198,4213154764,2393238008,3677496056,1014306527,4251020053,793779912,2902807211,842905082,4246964064,1395751752,1040244610,2656851899,3396308128,445077038,3742853595,3577915638,679411651,2892444358,2354009459,1767581616,3150600392,3791627101,3102740896,284835224,4246832056,1258075500,768725851,2589189241,3069724005,3532540348,1274779536,3789419226,2764799539,1660621633,3471099624,4011903706,913787905,3497959166,737222580,2514213453,2928710040,3937242737,1804850592,3499020752,2949064160,2386320175,2390070455,2415321851,4061277028,2290661394,2416832540,1336762016,1754252060,3520065937,3014181293,791618072,3188594551,3933548030,2332172193,3852520463,3043980520,413987798,3465142937,3030929376,4245938359,2093235073,3534596313,375366246,2157278981,2479649556,555357303,3870105701,2008414854,3344188149,4221384143,3956125452,2067696032,3594591187,2921233993,2428461,544322398,577241275,1471733935,610547355,4027169054,1432588573,1507829418,2025931657,3646575487,545086370,48609733,2200306550,1653985193,298326376,1316178497,3007786442,2064951626,458293330,2589141269,3591329599,3164325604,727753846,2179363840,146436021,1461446943,4069977195,705550613,3059967265,3887724982,4281599278,3313849956,1404054877,2845806497,146425753,1854211946,1266315497,3048417604,3681880366,3289982499,290971e4,1235738493,2632868024,2414719590,3970600049,1771706367,1449415276,3266420449,422970021,1963543593,2690192192,3826793022,1062508698,1531092325,1804592342,2583117782,2714934279,4024971509,1294809318,4028980673,1289560198,2221992742,1669523910,35572830,157838143,1052438473,1016535060,1802137761,1753167236,1386275462,3080475397,2857371447,1040679964,2145300060,2390574316,1461121720,2956646967,4031777805,4028374788,33600511,2920084762,1018524850,629373528,3691585981,3515945977,2091462646,2486323059,586499841,988145025,935516892,3367335476,2599673255,2839830854,265290510,3972581182,2759138881,3795373465,1005194799,847297441,406762289,1314163512,1332590856,1866599683,4127851711,750260880,613907577,1450815602,3165620655,3734664991,3650291728,3012275730,3704569646,1427272223,778793252,1343938022,2676280711,2052605720,1946737175,3164576444,3914038668,3967478842,3682934266,1661551462,3294938066,4011595847,840292616,3712170807,616741398,312560963,711312465,1351876610,322626781,1910503582,271666773,2175563734,1594956187,70604529,3617834859,1007753275,1495573769,4069517037,2549218298,2663038764,504708206,2263041392,3941167025,2249088522,1514023603,1998579484,1312622330,694541497,2582060303,2151582166,1382467621,776784248,2618340202,3323268794,2497899128,2784771155,503983604,4076293799,907881277,423175695,432175456,1378068232,4145222326,3954048622,3938656102,3820766613,2793130115,2977904593,26017576,3274890735,3194772133,1700274565,1756076034,4006520079,3677328699,720338349,1533947780,354530856,688349552,3973924725,1637815568,332179504,3949051286,53804574,2852348879,3044236432,1282449977,3583942155,3416972820,4006381244,1617046695,2628476075,3002303598,1686838959,431878346,2686675385,1700445008,1080580658,1009431731,832498133,3223435511,2605976345,2271191193,2516031870,1648197032,4164389018,2548247927,300782431,375919233,238389289,3353747414,2531188641,2019080857,1475708069,455242339,2609103871,448939670,3451063019,1395535956,2413381860,1841049896,1491858159,885456874,4264095073,4001119347,1565136089,3898914787,1108368660,540939232,1173283510,2745871338,3681308437,4207628240,3343053890,4016749493,1699691293,1103962373,3625875870,2256883143,3830138730,1031889488,3479347698,1535977030,4236805024,3251091107,2132092099,1774941330,1199868427,1452454533,157007616,2904115357,342012276,595725824,1480756522,206960106,497939518,591360097,863170706,2375253569,3596610801,1814182875,2094937945,3421402208,1082520231,3463918190,2785509508,435703966,3908032597,1641649973,2842273706,3305899714,1510255612,2148256476,2655287854,3276092548,4258621189,236887753,3681803219,274041037,1734335097,3815195456,3317970021,1899903192,1026095262,4050517792,356393447,2410691914,3873677099,3682840055,3913112168,2491498743,4132185628,2489919796,1091903735,1979897079,3170134830,3567386728,3557303409,857797738,1136121015,1342202287,507115054,2535736646,337727348,3213592640,1301675037,2528481711,1895095763,1721773893,3216771564,62756741,2142006736,835421444,2531993523,1442658625,3659876326,2882144922,676362277,1392781812,170690266,3921047035,1759253602,3611846912,1745797284,664899054,1329594018,3901205900,3045908486,2062866102,2865634940,3543621612,3464012697,1080764994,553557557,3656615353,3996768171,991055499,499776247,1265440854,648242737,3940784050,980351604,3713745714,1749149687,3396870395,4211799374,3640570775,1161844396,3125318951,1431517754,545492359,4268468663,3499529547,1437099964,2702547544,3433638243,2581715763,2787789398,1060185593,1593081372,2418618748,4260947970,69676912,2159744348,86519011,2512459080,3838209314,1220612927,3339683548,133810670,1090789135,1078426020,1569222167,845107691,3583754449,4072456591,1091646820,628848692,1613405280,3757631651,526609435,236106946,48312990,2942717905,3402727701,1797494240,859738849,992217954,4005476642,2243076622,3870952857,3732016268,765654824,3490871365,2511836413,1685915746,3888969200,1414112111,2273134842,3281911079,4080962846,172450625,2569994100,980381355,4109958455,2819808352,2716589560,2568741196,3681446669,3329971472,1835478071,660984891,3704678404,4045999559,3422617507,3040415634,1762651403,1719377915,3470491036,2693910283,3642056355,3138596744,1364962596,2073328063,1983633131,926494387,3423689081,2150032023,4096667949,1749200295,3328846651,309677260,2016342300,1779581495,3079819751,111262694,1274766160,443224088,298511866,1025883608,3806446537,1145181785,168956806,3641502830,3584813610,1689216846,3666258015,3200248200,1692713982,2646376535,4042768518,1618508792,1610833997,3523052358,4130873264,2001055236,3610705100,2202168115,4028541809,2961195399,1006657119,2006996926,3186142756,1430667929,3210227297,1314452623,4074634658,4101304120,2273951170,1399257539,3367210612,3027628629,1190975929,2062231137,2333990788,2221543033,2438960610,1181637006,548689776,2362791313,3372408396,3104550113,3145860560,296247880,1970579870,3078560182,3769228297,1714227617,3291629107,3898220290,166772364,1251581989,493813264,448347421,195405023,2709975567,677966185,3703036547,1463355134,2715995803,1338867538,1343315457,2802222074,2684532164,233230375,2599980071,2000651841,3277868038,1638401717,4028070440,3237316320,6314154,819756386,300326615,590932579,1405279636,3267499572,3150704214,2428286686,3959192993,3461946742,1862657033,1266418056,963775037,2089974820,2263052895,1917689273,448879540,3550394620,3981727096,150775221,3627908307,1303187396,508620638,2975983352,2726630617,1817252668,1876281319,1457606340,908771278,3720792119,3617206836,2455994898,1729034894,1080033504,976866871,3556439503,2881648439,1522871579,1555064734,1336096578,3548522304,2579274686,3574697629,3205460757,3593280638,3338716283,3079412587,564236357,2993598910,1781952180,1464380207,3163844217,3332601554,1699332808,1393555694,1183702653,3581086237,1288719814,691649499,2847557200,2895455976,3193889540,2717570544,1781354906,1676643554,2592534050,3230253752,1126444790,2770207658,2633158820,2210423226,2615765581,2414155088,3127139286,673620729,2805611233,1269405062,4015350505,3341807571,4149409754,1057255273,2012875353,2162469141,2276492801,2601117357,993977747,3918593370,2654263191,753973209,36408145,2530585658,25011837,3520020182,2088578344,530523599,2918365339,1524020338,1518925132,3760827505,3759777254,1202760957,3985898139,3906192525,674977740,4174734889,2031300136,2019492241,3983892565,4153806404,3822280332,352677332,2297720250,60907813,90501309,3286998549,1016092578,2535922412,2839152426,457141659,509813237,4120667899,652014361,1966332200,2975202805,55981186,2327461051,676427537,3255491064,2882294119,3433927263,1307055953,942726286,933058658,2468411793,3933900994,4215176142,1361170020,2001714738,2830558078,3274259782,1222529897,1679025792,2729314320,3714953764,1770335741,151462246,3013232138,1682292957,1483529935,471910574,1539241949,458788160,3436315007,1807016891,3718408830,978976581,1043663428,3165965781,1927990952,4200891579,2372276910,3208408903,3533431907,1412390302,2931980059,4132332400,1947078029,3881505623,4168226417,2941484381,1077988104,1320477388,886195818,18198404,3786409e3,2509781533,112762804,3463356488,1866414978,891333506,18488651,661792760,1628790961,3885187036,3141171499,876946877,2693282273,1372485963,791857591,2686433993,3759982718,3167212022,3472953795,2716379847,445679433,3561995674,3504004811,3574258232,54117162,3331405415,2381918588,3769707343,4154350007,1140177722,4074052095,668550556,3214352940,367459370,261225585,2610173221,4209349473,3468074219,3265815641,314222801,3066103646,3808782860,282218597,3406013506,3773591054,379116347,1285071038,846784868,2669647154,3771962079,3550491691,2305946142,453669953,1268987020,3317592352,3279303384,3744833421,2610507566,3859509063,266596637,3847019092,517658769,3462560207,3443424879,370717030,4247526661,2224018117,4143653529,4112773975,2788324899,2477274417,1456262402,2901442914,1517677493,1846949527,2295493580,3734397586,2176403920,1280348187,1908823572,3871786941,846861322,1172426758,3287448474,3383383037,1655181056,3139813346,901632758,1897031941,2986607138,3066810236,3447102507,1393639104,373351379,950779232,625454576,3124240540,4148612726,2007998917,544563296,2244738638,2330496472,2058025392,1291430526,424198748,50039436,29584100,3605783033,2429876329,2791104160,1057563949,3255363231,3075367218,3463963227,1469046755,985887462],ss=[1332899944,1700884034,1701343084,1684370003,1668446532,1869963892];function st(e,t,r,a){var s,n=e[t],c=e[t+1];return n^=r[0],s=a[n>>>24],s+=a[256|n>>16&255],s^=a[512|n>>8&255],s+=a[768|n&255],c^=s^r[1],s=a[c>>>24],s+=a[256|c>>16&255],s^=a[512|c>>8&255],s+=a[768|c&255],n^=s^r[2],s=a[n>>>24],s+=a[256|n>>16&255],s^=a[512|n>>8&255],s+=a[768|n&255],c^=s^r[3],s=a[c>>>24],s+=a[256|c>>16&255],s^=a[512|c>>8&255],s+=a[768|c&255],n^=s^r[4],s=a[n>>>24],s+=a[256|n>>16&255],s^=a[512|n>>8&255],s+=a[768|n&255],c^=s^r[5],s=a[c>>>24],s+=a[256|c>>16&255],s^=a[512|c>>8&255],s+=a[768|c&255],n^=s^r[6],s=a[n>>>24],s+=a[256|n>>16&255],s^=a[512|n>>8&255],s+=a[768|n&255],c^=s^r[7],s=a[c>>>24],s+=a[256|c>>16&255],s^=a[512|c>>8&255],s+=a[768|c&255],n^=s^r[8],s=a[n>>>24],s+=a[256|n>>16&255],s^=a[512|n>>8&255],s+=a[768|n&255],c^=s^r[9],s=a[c>>>24],s+=a[256|c>>16&255],s^=a[512|c>>8&255],s+=a[768|c&255],n^=s^r[10],s=a[n>>>24],s+=a[256|n>>16&255],s^=a[512|n>>8&255],s+=a[768|n&255],c^=s^r[11],s=a[c>>>24],s+=a[256|c>>16&255],s^=a[512|c>>8&255],s+=a[768|c&255],n^=s^r[12],s=a[n>>>24],s+=a[256|n>>16&255],s^=a[512|n>>8&255],s+=a[768|n&255],c^=s^r[13],s=a[c>>>24],s+=a[256|c>>16&255],s^=a[512|c>>8&255],s+=a[768|c&255],n^=s^r[14],s=a[n>>>24],s+=a[256|n>>16&255],s^=a[512|n>>8&255],s+=a[768|n&255],c^=s^r[15],s=a[c>>>24],s+=a[256|c>>16&255],s^=a[512|c>>8&255],s+=a[768|c&255],n^=s^r[16],e[t]=c^r[Ui+1],e[t+1]=n,e}function Fe(e,t){for(var r=0,a=0;r<4;++r)a=a<<8|e[t]&255,t=(t+1)%e.length;return{key:a,offp:t}}function Br(e,t,r){for(var a=0,s=[0,0],n=t.length,c=r.length,o,d=0;d<n;d++)o=Fe(e,a),a=o.offp,t[d]=t[d]^o.key;for(d=0;d<n;d+=2)s=st(s,0,t,r),t[d]=s[0],t[d+1]=s[1];for(d=0;d<c;d+=2)s=st(s,0,t,r),r[d]=s[0],r[d+1]=s[1]}function Mi(e,t,r,a){for(var s=0,n=[0,0],c=r.length,o=a.length,d,l=0;l<c;l++)d=Fe(t,s),s=d.offp,r[l]=r[l]^d.key;for(s=0,l=0;l<c;l+=2)d=Fe(e,s),s=d.offp,n[0]^=d.key,d=Fe(e,s),s=d.offp,n[1]^=d.key,n=st(n,0,r,a),r[l]=n[0],r[l+1]=n[1];for(l=0;l<o;l+=2)d=Fe(e,s),s=d.offp,n[0]^=d.key,d=Fe(e,s),s=d.offp,n[1]^=d.key,n=st(n,0,r,a),a[l]=n[0],a[l+1]=n[1]}function Hr(e,t,r,a,s){var n=ss.slice(),c=n.length,o;if(r<4||r>31)if(o=Error("Illegal number of rounds (4-31): "+r),a){W(a.bind(this,o));return}else throw o;if(t.length!==at)if(o=Error("Illegal salt length: "+t.length+" != "+at),a){W(a.bind(this,o));return}else throw o;r=1<<r>>>0;var d,l,f=0,x;typeof Int32Array=="function"?(d=new Int32Array(jr),l=new Int32Array($r)):(d=jr.slice(),l=$r.slice()),Mi(t,e,d,l);function m(){if(s&&s(f/r),f<r)for(var b=Date.now();f<r&&(f=f+1,Br(e,d,l),Br(t,d,l),!(Date.now()-b>Li)););else{for(f=0;f<64;f++)for(x=0;x<c>>1;x++)st(n,x<<1,d,l);var p=[];for(f=0;f<c;f++)p.push((n[f]>>24&255)>>>0),p.push((n[f]>>16&255)>>>0),p.push((n[f]>>8&255)>>>0),p.push((n[f]&255)>>>0);if(a){a(null,p);return}else return p}a&&W(m)}if(typeof a<"u")m();else for(var h;;)if(typeof(h=m())<"u")return h||[]}function rr(e,t,r,a){var s;if(typeof e!="string"||typeof t!="string")if(s=Error("Invalid string / salt: Not a string"),r){W(r.bind(this,s));return}else throw s;var n,c;if(t.charAt(0)!=="$"||t.charAt(1)!=="2")if(s=Error("Invalid salt version: "+t.substring(0,2)),r){W(r.bind(this,s));return}else throw s;if(t.charAt(2)==="$")n="\0",c=3;else{if(n=t.charAt(2),n!=="a"&&n!=="b"&&n!=="y"||t.charAt(3)!=="$")if(s=Error("Invalid salt revision: "+t.substring(2,4)),r){W(r.bind(this,s));return}else throw s;c=4}if(t.charAt(c+2)>"$")if(s=Error("Missing salt rounds"),r){W(r.bind(this,s));return}else throw s;var o=parseInt(t.substring(c,c+1),10)*10,d=parseInt(t.substring(c+1,c+2),10),l=o+d,f=t.substring(c+3,c+25);e+=n>="a"?"\0":"";var x=Ii(e),m=as(f,at);function h(b){var p=[];return p.push("$2"),n>="a"&&p.push(n),p.push("$"),l<10&&p.push("0"),p.push(l.toString()),p.push("$"),p.push(Ot(m,m.length)),p.push(Ot(b,ss.length*4-1)),p.join("")}if(typeof r>"u")return h(Hr(x,m,l));Hr(x,m,l,function(b,p){b?r(b,null):r(null,h(p))},a)}function Fi(e,t){return Ot(e,t)}function Pi(e,t){return as(e,t)}const ji={setRandomFallback:_i,genSaltSync:xr,genSalt:Za,hashSync:Qa,hash:es,compareSync:Ri,compare:Si,getRounds:Ci,getSalt:Oi,truncates:Di,encodeBase64:Fi,decodeBase64:Pi},w=new _a;w.use("*",xn());w.use("/api/*",cn());w.use(zn);w.use("/static/*",Tn({root:"./public"}));w.get("/api/health",async e=>{const{env:t}=e;try{const r=await t.DB.prepare("SELECT 1 as test").first();return e.json({status:"healthy",database:"connected",environment:t.ENVIRONMENT||"development",timestamp:new Date().toISOString()})}catch(r){return e.json({status:"unhealthy",database:"disconnected",error:r.message},500)}});w.post("/api/init-db",async e=>{const{env:t}=e;if(t.ENVIRONMENT==="production")return e.json({error:"Not available in production"},403);try{const r=[`CREATE TABLE IF NOT EXISTS companies (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL,
        country TEXT NOT NULL CHECK (country IN ('MX', 'ES')), 
        logo_url TEXT,
        primary_currency TEXT NOT NULL DEFAULT 'MXN' CHECK (primary_currency IN ('MXN', 'EUR', 'USD')),
        tax_id TEXT,
        address TEXT,
        active BOOLEAN NOT NULL DEFAULT TRUE,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
      )`,`CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        email TEXT UNIQUE NOT NULL,
        name TEXT NOT NULL,
        password_hash TEXT NOT NULL,
        role TEXT NOT NULL DEFAULT 'editor' CHECK (role IN ('viewer', 'editor', 'advanced', 'admin')),
        active BOOLEAN NOT NULL DEFAULT TRUE,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        last_login DATETIME
      )`,`CREATE TABLE IF NOT EXISTS user_companies (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER NOT NULL,
        company_id INTEGER NOT NULL,
        can_view BOOLEAN NOT NULL DEFAULT TRUE,
        can_edit BOOLEAN NOT NULL DEFAULT FALSE,
        can_admin BOOLEAN NOT NULL DEFAULT FALSE,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        UNIQUE(user_id, company_id)
      )`,`CREATE TABLE IF NOT EXISTS expense_types (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL,
        description TEXT,
        category TEXT NOT NULL DEFAULT 'general' CHECK (category IN ('travel', 'meals', 'transport', 'accommodation', 'supplies', 'services', 'general')),
        active BOOLEAN NOT NULL DEFAULT TRUE,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
      )`,`CREATE TABLE IF NOT EXISTS expenses (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        company_id INTEGER NOT NULL,
        user_id INTEGER NOT NULL,
        expense_type_id INTEGER NOT NULL,
        description TEXT NOT NULL,
        expense_date DATE NOT NULL,
        amount DECIMAL(12,2) NOT NULL,
        currency TEXT NOT NULL CHECK (currency IN ('MXN', 'EUR', 'USD')),
        exchange_rate DECIMAL(10,6) NOT NULL DEFAULT 1.0,
        amount_mxn DECIMAL(12,2) NOT NULL,
        payment_method TEXT CHECK (payment_method IN ('cash', 'credit_card', 'debit_card', 'bank_transfer', 'company_card', 'petty_cash')),
        vendor TEXT,
        invoice_number TEXT,
        status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected', 'reimbursed', 'invoiced')),
        approved_by INTEGER,
        approved_at DATETIME,
        notes TEXT,
        tags TEXT,
        is_billable BOOLEAN NOT NULL DEFAULT FALSE,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        created_by INTEGER NOT NULL,
        updated_by INTEGER
      )`,`CREATE TABLE IF NOT EXISTS attachments (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        expense_id INTEGER NOT NULL,
        file_name TEXT NOT NULL,
        file_type TEXT NOT NULL CHECK (file_type IN ('image', 'pdf', 'xml')),
        file_url TEXT NOT NULL,
        file_size INTEGER,
        mime_type TEXT,
        ocr_text TEXT,
        ocr_confidence DECIMAL(3,2),
        is_cfdi_valid BOOLEAN,
        cfdi_uuid TEXT,
        uploaded_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        uploaded_by INTEGER NOT NULL
      )`,`CREATE TABLE IF NOT EXISTS exchange_rates (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        from_currency TEXT NOT NULL CHECK (from_currency IN ('MXN', 'EUR', 'USD')),
        to_currency TEXT NOT NULL CHECK (to_currency IN ('MXN', 'EUR', 'USD')),
        rate DECIMAL(10,6) NOT NULL,
        rate_date DATE NOT NULL,
        source TEXT NOT NULL DEFAULT 'banxico',
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        UNIQUE(from_currency, to_currency, rate_date)
      )`,`CREATE TABLE IF NOT EXISTS cfdi_validations (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        company_id INTEGER NOT NULL,
        expense_id INTEGER,
        uuid TEXT NOT NULL,
        rfc_emisor TEXT NOT NULL,
        rfc_receptor TEXT NOT NULL,
        total DECIMAL(12,2) NOT NULL,
        fecha_emision DATETIME,
        serie TEXT,
        folio TEXT,
        is_valid BOOLEAN NOT NULL DEFAULT FALSE,
        validation_details TEXT,
        validation_source TEXT DEFAULT 'manual',
        validated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        validated_by INTEGER,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        UNIQUE(uuid, company_id)
      )`,`CREATE TABLE IF NOT EXISTS user_sessions (
        id TEXT PRIMARY KEY,
        user_id INTEGER NOT NULL,
        expires_at DATETIME NOT NULL,
        ip_address TEXT,
        user_agent TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
      )`];for(const a of r)await t.DB.prepare(a).run();return await t.DB.prepare(`
      INSERT OR IGNORE INTO companies (id, name, country, primary_currency, tax_id, active) VALUES 
        (1, 'TechMX Solutions', 'MX', 'MXN', 'TMX123456789', TRUE),
        (2, 'Innovación Digital MX', 'MX', 'MXN', 'IDM987654321', TRUE),
        (3, 'Consultoría Estratégica MX', 'MX', 'MXN', 'CEM555666777', TRUE),
        (4, 'TechES Barcelona', 'ES', 'EUR', 'B-12345678', TRUE),
        (5, 'Innovación Madrid SL', 'ES', 'EUR', 'B-87654321', TRUE),
        (6, 'Digital Valencia S.A.', 'ES', 'EUR', 'A-11223344', TRUE)
    `).run(),await t.DB.prepare(`
      INSERT OR IGNORE INTO expense_types (id, name, description, category, active) VALUES 
        (1, 'Comidas de Trabajo', 'Gastos en restaurantes por reuniones de trabajo', 'meals', TRUE),
        (2, 'Transporte Terrestre', 'Taxis, Uber, autobuses, metro', 'transport', TRUE),
        (3, 'Combustible', 'Gasolina y gastos de vehículos', 'transport', TRUE),
        (4, 'Hospedaje', 'Hoteles y alojamientos', 'accommodation', TRUE),
        (5, 'Vuelos', 'Boletos de avión nacionales e internacionales', 'travel', TRUE),
        (6, 'Material de Oficina', 'Papelería, suministros de oficina', 'supplies', TRUE),
        (7, 'Software y Licencias', 'Suscripciones y licencias de software', 'services', TRUE),
        (8, 'Capacitación', 'Cursos, conferencias, workshops', 'services', TRUE),
        (9, 'Marketing', 'Publicidad, eventos, promociones', 'services', TRUE),
        (10, 'Otros Gastos', 'Gastos diversos no categorizados', 'general', TRUE)
    `).run(),await t.DB.prepare(`
      INSERT OR IGNORE INTO users (id, email, name, password_hash, role, active) VALUES 
        (1, 'admin@techmx.com', 'Alejandro Rodríguez', '$2b$10$yvsqabOwKIXJf5cu2nCIq.LDZQAKQPusEN2pvncvnTgO9lHfgE1F6', 'admin', TRUE),
        (2, 'maria.lopez@techmx.com', 'María López', '$2b$10$E28fauI9DklVUyNGeGC6X.TP6wUw7PjE2d/anA3DhqXr3V64.3M7C', 'editor', TRUE),
        (3, 'carlos.martinez@innovacion.mx', 'Carlos Martínez', '$2b$10$E28fauI9DklVUyNGeGC6X.TP6wUw7PjE2d/anA3DhqXr3V64.3M7C', 'advanced', TRUE),
        (4, 'ana.garcia@consultoria.mx', 'Ana García', '$2b$10$E28fauI9DklVUyNGeGC6X.TP6wUw7PjE2d/anA3DhqXr3V64.3M7C', 'editor', TRUE),
        (5, 'pedro.sanchez@techespana.es', 'Pedro Sánchez', '$2b$10$E28fauI9DklVUyNGeGC6X.TP6wUw7PjE2d/anA3DhqXr3V64.3M7C', 'advanced', TRUE),
        (6, 'elena.torres@madrid.es', 'Elena Torres', '$2b$10$E28fauI9DklVUyNGeGC6X.TP6wUw7PjE2d/anA3DhqXr3V64.3M7C', 'editor', TRUE)
    `).run(),await t.DB.prepare(`
      INSERT OR IGNORE INTO user_companies (user_id, company_id, can_view, can_edit, can_admin) VALUES 
        (1, 1, TRUE, TRUE, TRUE), (1, 2, TRUE, TRUE, TRUE), (1, 3, TRUE, TRUE, TRUE),
        (1, 4, TRUE, TRUE, TRUE), (1, 5, TRUE, TRUE, TRUE), (1, 6, TRUE, TRUE, TRUE),
        (2, 1, TRUE, TRUE, FALSE), (3, 2, TRUE, TRUE, FALSE), (4, 3, TRUE, TRUE, FALSE),
        (5, 4, TRUE, TRUE, FALSE), (6, 5, TRUE, TRUE, FALSE)
    `).run(),await t.DB.prepare(`
      INSERT OR IGNORE INTO exchange_rates (from_currency, to_currency, rate, rate_date, source) VALUES 
        ('USD', 'MXN', 18.25, '2024-09-24', 'banxico'),
        ('EUR', 'MXN', 20.15, '2024-09-24', 'banxico'),
        ('EUR', 'USD', 1.10, '2024-09-24', 'ecb'),
        ('USD', 'EUR', 0.91, '2024-09-24', 'ecb'),
        ('MXN', 'USD', 0.055, '2024-09-24', 'banxico'),
        ('MXN', 'EUR', 0.050, '2024-09-24', 'banxico')
    `).run(),await t.DB.prepare(`
      INSERT OR IGNORE INTO expenses (
        id, company_id, user_id, expense_type_id, description, expense_date, 
        amount, currency, exchange_rate, amount_mxn, payment_method, vendor, 
        status, notes, is_billable, created_by
      ) VALUES 
        (1, 1, 2, 1, 'Comida con cliente - Proyecto Alpha', '2024-09-20', 850.00, 'MXN', 1.0, 850.00, 'company_card', 'Restaurante Pujol', 'approved', 'Reunión de cierre de proyecto', TRUE, 2),
        (2, 1, 2, 2, 'Taxi al aeropuerto', '2024-09-21', 320.50, 'MXN', 1.0, 320.50, 'cash', 'Uber', 'pending', NULL, FALSE, 2),
        (3, 2, 3, 7, 'Licencia Adobe Creative Suite', '2024-09-22', 2500.00, 'MXN', 1.0, 2500.00, 'credit_card', 'Adobe Inc', 'approved', 'Renovación anual', FALSE, 3),
        (4, 4, 5, 5, 'Vuelo Barcelona-Madrid', '2024-09-18', 120.00, 'EUR', 20.15, 2418.00, 'company_card', 'Iberia', 'reimbursed', 'Reunión con cliente en Madrid', TRUE, 5),
        (5, 5, 6, 4, 'Hotel NH Collection Madrid', '2024-09-19', 180.00, 'EUR', 20.15, 3627.00, 'credit_card', 'NH Hotels', 'approved', 'Estadía 2 noches', TRUE, 6),
        (6, 1, 1, 8, 'Conferencia AWS Re:Invent', '2024-09-15', 1500.00, 'USD', 18.25, 27375.00, 'company_card', 'Amazon Web Services', 'approved', 'Capacitación en cloud computing', FALSE, 1),
        (7, 3, 4, 6, 'Material de oficina importado', '2024-09-23', 250.00, 'USD', 18.25, 4562.50, 'bank_transfer', 'Office Depot USA', 'pending', 'Material especializado', FALSE, 4)
    `).run(),await t.DB.prepare(`
      INSERT OR IGNORE INTO cfdi_validations (
        company_id, expense_id, uuid, rfc_emisor, rfc_receptor, total, 
        fecha_emision, serie, folio, is_valid, validation_details, 
        validation_source, validated_by
      ) VALUES 
        (1, 1, '12345678-1234-1234-1234-123456789012', 'RPU123456789', 'TMX123456789', 850.00, 
         '2024-09-20T14:30:00', 'A', '001', TRUE, 'CFDI válido - Verificado en SAT', 'xml', 1),
        (2, 3, '87654321-4321-4321-4321-210987654321', 'ADO987654321', 'IDM987654321', 2500.00, 
         '2024-09-22T09:15:00', 'B', '002', TRUE, 'CFDI válido - Factura de software', 'pdf', 3),
        (3, 7, 'ABCDEFGH-1111-2222-3333-444455556666', 'ODP555666777', 'CEM555666777', 4562.50, 
         '2024-09-23T16:45:00', 'C', '003', FALSE, 'Error: Receptor no coincide', 'manual', 4)
    `).run(),e.json({success:!0,message:"Base de datos inicializada con datos de prueba (incluyendo CFDI validations)",timestamp:new Date().toISOString()})}catch(r){return e.json({error:"Failed to initialize database",details:r.message},500)}});w.get("/api/companies",async e=>{const{env:t}=e;try{const r=await t.DB.prepare(`
      SELECT id, name, country, primary_currency, logo_url, active, created_at
      FROM companies 
      WHERE active = TRUE
      ORDER BY country, name
    `).all();return e.json({companies:r.results})}catch{return e.json({error:"Failed to fetch companies"},500)}});w.get("/api/users",async e=>{const{env:t}=e;try{const r=await t.DB.prepare(`
      SELECT u.id, u.email, u.name, u.role, u.active, u.created_at,
             GROUP_CONCAT(c.name, '|') as companies
      FROM users u
      LEFT JOIN user_companies uc ON u.id = uc.user_id
      LEFT JOIN companies c ON uc.company_id = c.id
      WHERE u.active = TRUE
      GROUP BY u.id
      ORDER BY u.name
    `).all();return e.json({users:r.results})}catch{return e.json({error:"Failed to fetch users"},500)}});w.get("/api/expenses",async e=>{const{env:t}=e,r=e.req.query();let a=`
    SELECT e.*, c.name as company_name, u.name as user_name, et.name as expense_type_name,
           c.country, c.primary_currency as company_currency
    FROM expenses e
    JOIN companies c ON e.company_id = c.id
    JOIN users u ON e.user_id = u.id
    JOIN expense_types et ON e.expense_type_id = et.id
    WHERE 1=1
  `;const s=[];r.company_id&&(a+=" AND e.company_id = ?",s.push(r.company_id)),r.user_id&&(a+=" AND e.user_id = ?",s.push(r.user_id)),r.status&&(a+=" AND e.status = ?",s.push(r.status)),r.currency&&(a+=" AND e.currency = ?",s.push(r.currency)),r.date_from&&(a+=" AND e.expense_date >= ?",s.push(r.date_from)),r.date_to&&(a+=" AND e.expense_date <= ?",s.push(r.date_to)),a+=" ORDER BY e.expense_date DESC, e.created_at DESC",r.limit&&(a+=" LIMIT ?",s.push(parseInt(r.limit)||50));try{const c=await t.DB.prepare(a).bind(...s).all();return e.json({expenses:c.results,total:c.results.length})}catch{return e.json({error:"Failed to fetch expenses"},500)}});w.post("/api/expenses",async e=>{const{env:t}=e;try{const r=await e.req.json(),a=["company_id","expense_type_id","description","expense_date","amount","currency"];for(const o of a)if(!r[o])return e.json({error:`Missing required field: ${o}`},400);let s=r.amount,n=1;r.currency==="USD"?(n=18.25,s=r.amount*n):r.currency==="EUR"&&(n=20.15,s=r.amount*n);const c=await t.DB.prepare(`
      INSERT INTO expenses (
        company_id, user_id, expense_type_id, description, expense_date, 
        amount, currency, exchange_rate, amount_mxn, payment_method, 
        vendor, notes, status, created_by
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(r.company_id,r.user_id||1,r.expense_type_id,r.description,r.expense_date,r.amount,r.currency,n,s,r.payment_method||"cash",r.vendor||"",r.notes||"","pending",r.user_id||1).run();return e.json({success:!0,expense_id:c.meta.last_row_id,message:"Gasto creado exitosamente"})}catch(r){return e.json({error:"Failed to create expense",details:r.message},500)}});w.get("/api/dashboard/metrics",async e=>{const{env:t}=e;e.req.query();try{const r=await t.DB.prepare(`
      SELECT status, COUNT(*) as count, SUM(amount_mxn) as total_mxn
      FROM expenses
      GROUP BY status
    `).all(),a=await t.DB.prepare(`
      SELECT c.name as company, c.country, COUNT(*) as count, SUM(e.amount_mxn) as total_mxn
      FROM expenses e
      JOIN companies c ON e.company_id = c.id
      GROUP BY c.id, c.name, c.country
      ORDER BY total_mxn DESC
    `).all(),s=await t.DB.prepare(`
      SELECT currency, COUNT(*) as count, SUM(amount) as total_original, SUM(amount_mxn) as total_mxn
      FROM expenses
      GROUP BY currency
    `).all(),n=await t.DB.prepare(`
      SELECT e.*, c.name as company_name, u.name as user_name
      FROM expenses e
      JOIN companies c ON e.company_id = c.id
      JOIN users u ON e.user_id = u.id
      ORDER BY e.created_at DESC
      LIMIT 10
    `).all();return e.json({status_metrics:r.results,company_metrics:a.results,currency_metrics:s.results,recent_expenses:n.results})}catch{return e.json({error:"Failed to fetch dashboard metrics"},500)}});w.get("/api/expense-types",async e=>{const{env:t}=e;try{const r=await t.DB.prepare(`
      SELECT id, name, description, category, active
      FROM expense_types
      WHERE active = TRUE
      ORDER BY category, name
    `).all();return e.json({expense_types:r.results})}catch{return e.json({error:"Failed to fetch expense types"},500)}});w.get("/api/exchange-rates",async e=>{const{env:t}=e,r=e.req.query();try{const a=await t.DB.prepare(`
      SELECT from_currency, to_currency, rate, rate_date, source
      FROM exchange_rates
      WHERE rate_date = (
        SELECT MAX(rate_date) FROM exchange_rates
      )
      ORDER BY from_currency, to_currency
    `).all();if(r.from&&r.to){const s=a.results.find(n=>n.from_currency===r.from&&n.to_currency===r.to);if(s)return e.json({rate:s.rate,date:s.rate_date,source:s.source});{const n=a.results.find(c=>c.from_currency===r.to&&c.to_currency===r.from);if(n)return e.json({rate:(1/n.rate).toFixed(6),date:n.rate_date,source:n.source+" (inverse)"})}return e.json({error:"Exchange rate not found"},404)}return e.json({exchange_rates:a.results})}catch{return e.json({error:"Failed to fetch exchange rates"},500)}});w.post("/api/exchange-rates/update",async e=>{const{env:t}=e;try{const r=new Date().toISOString().split("T")[0],a=[{from:"USD",to:"MXN",rate:18.25,source:"banxico"},{from:"EUR",to:"MXN",rate:20.15,source:"banxico"},{from:"EUR",to:"USD",rate:1.1,source:"ecb"},{from:"USD",to:"EUR",rate:.91,source:"ecb"},{from:"MXN",to:"USD",rate:.055,source:"banxico"},{from:"MXN",to:"EUR",rate:.05,source:"banxico"}];for(const s of a)await t.DB.prepare(`
        INSERT OR REPLACE INTO exchange_rates 
        (from_currency, to_currency, rate, rate_date, source, created_at)
        VALUES (?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
      `).bind(s.from,s.to,s.rate,r,s.source).run();return e.json({success:!0,message:"Exchange rates updated successfully",date:r})}catch{return e.json({error:"Failed to update exchange rates"},500)}});w.post("/api/attachments",async e=>{const{env:t}=e;try{const r=await e.req.formData(),a=r.get("file"),s=r.get("expense_id"),n=r.get("process_ocr")==="true";if(!a||!s)return e.json({error:"File and expense_id are required"},400);const c=`/uploads/${Date.now()}-${a.name}`,o=a.type.startsWith("image/")?"image":a.type==="application/pdf"?"pdf":"xml";let d=null;n&&(o==="image"||o==="pdf")&&(d=await ns(a,o));const l=await t.DB.prepare(`
      INSERT INTO attachments (
        expense_id, file_name, file_type, file_url, file_size, 
        mime_type, ocr_text, ocr_confidence, uploaded_by, uploaded_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
    `).bind(s,a.name,o,c,a.size,a.type,(d==null?void 0:d.text)||null,(d==null?void 0:d.confidence)||null,1).run();return e.json({success:!0,attachment_id:l.meta.last_row_id,file_url:c,ocr_data:d,message:"File uploaded successfully"+(d?" with OCR processing":"")})}catch(r){return e.json({error:"Failed to upload attachment",details:r.message},500)}});w.post("/api/attachments/:id/ocr",async e=>{const{env:t}=e,r=e.req.param("id");try{const a=await t.DB.prepare(`
      SELECT * FROM attachments WHERE id = ?
    `).bind(r).first();if(!a)return e.json({error:"Attachment not found"},404);if(a.file_type!=="image"&&a.file_type!=="pdf")return e.json({error:"OCR only supported for images and PDFs"},400);const s=await ns(null,a.file_type,a.file_name);return await t.DB.prepare(`
      UPDATE attachments 
      SET ocr_text = ?, ocr_confidence = ?
      WHERE id = ?
    `).bind(s.text,s.confidence,r).run(),e.json({success:!0,ocr_data:s,message:"OCR processing completed"})}catch(a){return e.json({error:"Failed to process OCR",details:a.message},500)}});w.post("/api/ocr/extract-expense-data",async e=>{const{env:t}=e;try{const{ocr_text:r,attachment_id:a}=await e.req.json();if(!r)return e.json({error:"OCR text is required"},400);const s=await Hi(r);return e.json({success:!0,extracted_data:s,message:"Expense data extracted successfully"})}catch(r){return e.json({error:"Failed to extract expense data",details:r.message},500)}});async function ns(e,t,r=null){const a={ticket:{text:`RESTAURANTE PUJOL
Tennyson 133, Polanco
Ciudad de México
RFC: RPU890123ABC

FECHA: ${new Date().toLocaleDateString("es-MX")}
HORA: ${new Date().toLocaleTimeString("es-MX")}

MESA: 12
MESERO: Carlos Martinez

CONSUMO:
1x Menú Degustación     $1,200.00
2x Vino Tinto Casa      $400.00
1x Postre Especial      $250.00

SUBTOTAL:               $1,850.00
IVA (16%):              $296.00
PROPINA SUGERIDA:       $277.50

TOTAL:                  $2,146.00

FORMA DE PAGO: TARJETA ****1234
AUTORIZACIÓN: 123456

GRACIAS POR SU VISITA
www.pujol.com.mx`,confidence:.94},factura:{text:`FACTURA ELECTRÓNICA
Adobe Systems Incorporated
RFC: ASI123456789

LUGAR DE EXPEDICIÓN: 06600
FECHA: ${new Date().toLocaleDateString("es-MX")}
FOLIO FISCAL: 12345678-ABCD-1234-EFGH-123456789012

RECEPTOR:
TechMX Solutions S.A. de C.V.
RFC: TMX123456789
USO CFDI: G03 - Gastos en General

CONCEPTO:
Licencia Adobe Creative Suite Anual
Cantidad: 1
Precio Unitario: $2,500.00
Importe: $2,500.00

SUBTOTAL: $2,500.00
IVA (16%): $400.00
TOTAL: $2,900.00

MÉTODO DE PAGO: 04 - Tarjeta de Crédito
MONEDA: MXN

SELLO DIGITAL SAT: ABC123DEF456...`,confidence:.97},uber:{text:`Uber
VIAJE COMPLETADO

DOMINGO, ${new Date().toLocaleDateString("es-MX")}
${new Date().toLocaleTimeString("es-MX")}

DESDE: Torre Reforma
HASTA: Aeropuerto Internacional

CONDUCTOR: Miguel Hernández
AUTO: Nissan Versa Blanco
PLACAS: ABC-123-D

DISTANCIA: 32.5 km
DURACIÓN: 45 min

TARIFA BASE:     $45.00
TIEMPO Y DIST:   $235.50
PEAJE:          $40.00

SUBTOTAL:       $320.50
PROPINA:        $0.00
TOTAL:          $320.50

MÉTODO DE PAGO: Efectivo
ID VIAJE: 1234-5678-9012`,confidence:.89}};let s="ticket";return r&&(r.toLowerCase().includes("factura")||r.toLowerCase().includes("invoice")?s="factura":(r.toLowerCase().includes("uber")||r.toLowerCase().includes("taxi"))&&(s="uber")),await new Promise(n=>setTimeout(n,1500)),a[s]||a.ticket}w.post("/api/cfdi/validate",async e=>{const{env:t}=e;try{const r=await e.req.formData(),a=r.get("file"),s=r.get("expense_id");if(!a)return e.json({error:"XML or PDF file is required for CFDI validation"},400);let n=null;if(a.type==="application/xml"||a.type==="text/xml")n=await $i(a);else if(a.type==="application/pdf")n=await Bi(a);else return e.json({error:"Only XML and PDF files are supported for CFDI validation"},400);const c=await is(n);return s&&n.uuid&&await t.DB.prepare(`
        UPDATE attachments 
        SET is_cfdi_valid = ?, cfdi_uuid = ?
        WHERE expense_id = ? AND id = (
          SELECT id FROM attachments WHERE expense_id = ? ORDER BY uploaded_at DESC LIMIT 1
        )
      `).bind(c.valid,n.uuid,s,s).run(),e.json({success:!0,cfdi_data:n,sat_validation:c,message:c.valid?"CFDI válido":"CFDI inválido o con errores"})}catch(r){return e.json({error:"Failed to validate CFDI",details:r.message},500)}});w.post("/api/cfdi/validate-data",async e=>{const{env:t}=e;try{const r=await e.req.json(),{company_id:a,rfc_emisor:s,rfc_receptor:n,uuid:c,total:o}=r;if(!a||!s||!n||!c)return e.json({error:"company_id, rfc_emisor, rfc_receptor, and uuid are required"},400);if(!await t.DB.prepare("SELECT * FROM companies WHERE id = ? AND country = ?").bind(a,"MX").first())return e.json({error:"Company not found or not a Mexican company"},400);if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(c))return e.json({error:"Invalid UUID format"},400);const f={rfc_emisor:s,rfc_receptor:n,uuid:c,total:parseFloat(o)||0,fecha_emision:new Date().toISOString(),serie:"A",folio:"001"},x=await is(f),m=await t.DB.prepare(`
      INSERT INTO cfdi_validations (
        company_id, uuid, rfc_emisor, rfc_receptor, total, 
        is_valid, validation_details
      ) VALUES (?, ?, ?, ?, ?, ?, ?)
    `).bind(a,c,s,n,o||0,x.valid?1:0,x.mensaje).run();return e.json({success:!0,validation_id:m.meta.last_row_id,cfdi_data:f,sat_valid:x.valid,validation_details:x.mensaje,message:x.valid?"CFDI validado exitosamente":"CFDI con errores de validación"})}catch(r){return e.json({error:"Failed to validate CFDI data",details:r.message},500)}});w.get("/api/expenses/:id/cfdi-status",async e=>{const{env:t}=e,r=e.req.param("id");try{const a=await t.DB.prepare(`
      SELECT id, file_name, is_cfdi_valid, cfdi_uuid, uploaded_at
      FROM attachments
      WHERE expense_id = ? AND (file_type = 'xml' OR file_type = 'pdf')
      ORDER BY uploaded_at DESC
    `).bind(r).all();return e.json({success:!0,cfdi_attachments:a.results,has_valid_cfdi:a.results.some(s=>s.is_cfdi_valid===1)})}catch{return e.json({error:"Failed to get CFDI status"},500)}});async function $i(e){return{version:"4.0",uuid:cs(),rfc_emisor:"ABC123456789",razon_social_emisor:"Empresa Emisora S.A. de C.V.",rfc_receptor:"XYZ987654321",razon_social_receptor:"TechMX Solutions S.A. de C.V.",fecha:new Date().toISOString(),folio:"A001-"+Math.floor(Math.random()*1e5),serie:"A",forma_pago:"04",metodo_pago:"PUE",uso_cfdi:"G03",lugar_expedicion:"06600",moneda:"MXN",tipo_cambio:"1.000000",conceptos:[{clave_prod_serv:"84111506",no_identificacion:null,cantidad:"1.000000",clave_unidad:"ACT",unidad:"Actividad",descripcion:"Servicios de consultoría",valor_unitario:"2500.00",importe:"2500.00"}],subtotal:"2500.00",iva:"400.00",total:"2900.00",sello_digital:"ABC123DEF456GHI789JKL012MNO345PQR678STU901VWX234YZ...",certificado_sat:"DEF456GHI789JKL012MNO345PQR678STU901VWX234YZ567ABC...",fecha_timbrado:new Date().toISOString(),no_certificado_sat:"30001000000400002495"}}async function Bi(e){return{version:"4.0",uuid:cs(),rfc_emisor:"PDF123456789",razon_social_emisor:"Empresa PDF S.A. de C.V.",rfc_receptor:"TMX123456789",razon_social_receptor:"TechMX Solutions S.A. de C.V.",fecha:new Date().toISOString(),folio:"P001-"+Math.floor(Math.random()*1e5),serie:"P",forma_pago:"01",metodo_pago:"PUE",uso_cfdi:"G01",lugar_expedicion:"06600",moneda:"MXN",subtotal:"850.00",iva:"136.00",total:"986.00",extracted_from:"PDF",confidence:.85}}async function is(e){await new Promise(a=>setTimeout(a,1500));const t={uuid_format:/^[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}$/.test(e.uuid),rfc_format:/^[A-Z]{3,4}\d{6}[A-Z0-9]{3}$/.test(e.rfc_emisor),date_valid:e.fecha_emision?new Date(e.fecha_emision)<=new Date:!0,amounts_valid:parseFloat(e.total)>0,version_supported:e.version?["3.3","4.0"].includes(e.version):!0},r=Object.values(t).every(a=>a);return{valid:r,timestamp:new Date().toISOString(),checks:t,sat_status:r?"VIGENTE":"INVALIDO",cancelable:r,estado_sat:r?"Activo":"Cancelado",mensaje:r?"CFDI válido y vigente en el SAT":"CFDI inválido o con errores en la estructura"}}function cs(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=Math.random()*16|0;return(e=="x"?t:t&3|8).toString(16)})}async function Hi(e){const t={amount:null,currency:"MXN",date:null,vendor:null,description:null,tax_amount:null,payment_method:null,invoice_number:null,confidence_score:.85,is_cfdi:!1,cfdi_uuid:null,rfc_emisor:null};if(e.includes("CFDI")||e.includes("UUID")||e.includes("FOLIO FISCAL")){t.is_cfdi=!0,t.confidence_score+=.1;const d=e.match(/UUID[\s:]*([a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12})/i);d&&(t.cfdi_uuid=d[1]);const l=e.match(/FOLIO FISCAL[\s:]*([a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12})/i);l&&(t.cfdi_uuid=l[1])}const r=e.match(/(?:TOTAL|Total|total)[\s:]*\$?([\d,]+\.?\d*)/i);r&&(t.amount=parseFloat(r[1].replace(",","")),t.confidence_score+=.1);const a=e.match(/(?:FECHA|Fecha|fecha)[\s:]*(\d{1,2}\/\d{1,2}\/\d{2,4})/i);a&&(t.date=a[1],t.confidence_score+=.05);const s=e.split(`
`);if(s.length>0){const d=s.find(l=>l.trim()&&!l.includes("TICKET")&&!l.includes("FACTURA"));d&&(t.vendor=d.trim(),t.description=`Gasto en ${d.trim()}`)}const n=e.match(/RFC[\s:]*([A-Z]{3,4}\d{6}[A-Z0-9]{3})/i);n&&(t.rfc_emisor=n[1],t.confidence_score+=.05),e.toLowerCase().includes("efectivo")||e.toLowerCase().includes("cash")?t.payment_method="cash":(e.toLowerCase().includes("tarjeta")||e.toLowerCase().includes("card"))&&(t.payment_method="credit_card");const c=e.match(/(?:FOLIO|Folio|folio)[\s:]*([A-Z0-9\-]+)/i);c&&(t.invoice_number=c[1]);const o=e.match(/(?:IVA|iva)[\s:]*\$?([\d,]+\.?\d*)/i);return o&&(t.tax_amount=parseFloat(o[1].replace(",",""))),t}w.get("/api/expenses/:id/attachments",async e=>{const{env:t}=e,r=e.req.param("id");try{const a=await t.DB.prepare(`
      SELECT id, file_name, file_type, file_url, file_size, 
             mime_type, ocr_text, uploaded_at
      FROM attachments
      WHERE expense_id = ?
      ORDER BY uploaded_at ASC
    `).bind(r).all();return e.json({attachments:a.results})}catch{return e.json({error:"Failed to fetch attachments"},500)}});w.post("/api/reports/pdf",async e=>{const{env:t}=e;try{const r=await e.req.json(),{company_id:a,date_from:s,date_to:n,status:c,currency:o,user_id:d,expense_type_id:l,format:f="detailed"}=r;let x=`
      SELECT e.*, c.name as company_name, c.country, c.logo_url, c.primary_currency,
             u.name as user_name, et.name as expense_type_name, et.category,
             COUNT(a.id) as attachments_count
      FROM expenses e
      JOIN companies c ON e.company_id = c.id
      JOIN users u ON e.user_id = u.id
      JOIN expense_types et ON e.expense_type_id = et.id
      LEFT JOIN attachments a ON e.id = a.expense_id
      WHERE 1=1
    `;const m=[];a&&(x+=" AND e.company_id = ?",m.push(a)),s&&(x+=" AND e.expense_date >= ?",m.push(s)),n&&(x+=" AND e.expense_date <= ?",m.push(n)),c&&(x+=" AND e.status = ?",m.push(c)),o&&(x+=" AND e.currency = ?",m.push(o)),d&&(x+=" AND e.user_id = ?",m.push(d)),l&&(x+=" AND e.expense_type_id = ?",m.push(l)),x+=" GROUP BY e.id ORDER BY e.expense_date DESC, e.created_at DESC";const h=await t.DB.prepare(x).bind(...m).all();let b=null;a&&(b=await t.DB.prepare("SELECT * FROM companies WHERE id = ?").bind(a).first());const p=ki(h.results,b,f,{date_from:s,date_to:n,status:c,currency:o});return e.json({success:!0,html_content:p,total_expenses:h.results.length,total_amount:h.results.reduce((E,N)=>E+parseFloat(N.amount_mxn||0),0),filters:{company_id:a,date_from:s,date_to:n,status:c,currency:o,user_id:d,expense_type_id:l},message:"PDF content generated successfully"})}catch(r){return e.json({error:"Failed to generate PDF report",details:r.message},500)}});w.post("/api/reports/excel",async e=>{const{env:t}=e;try{const a=await e.req.json();let s=`
      SELECT e.id, e.description, e.expense_date, e.amount, e.currency, e.exchange_rate, 
             e.amount_mxn, e.payment_method, e.vendor, e.invoice_number, e.status, e.notes,
             e.is_billable, e.created_at,
             c.name as company_name, c.country, c.primary_currency,
             u.name as user_name, u.email as user_email,
             et.name as expense_type_name, et.category
      FROM expenses e
      JOIN companies c ON e.company_id = c.id
      JOIN users u ON e.user_id = u.id
      JOIN expense_types et ON e.expense_type_id = et.id
      WHERE 1=1
    `;const n=[];a.company_id&&(s+=" AND e.company_id = ?",n.push(a.company_id)),a.date_from&&(s+=" AND e.expense_date >= ?",n.push(a.date_from)),a.date_to&&(s+=" AND e.expense_date <= ?",n.push(a.date_to)),a.status&&(s+=" AND e.status = ?",n.push(a.status)),s+=" ORDER BY e.expense_date DESC";const c=await t.DB.prepare(s).bind(...n).all();return e.json({success:!0,data:c.results,total_records:c.results.length,total_amount_mxn:c.results.reduce((o,d)=>o+parseFloat(d.amount_mxn||0),0),export_date:new Date().toISOString(),filters:a})}catch(r){return e.json({error:"Failed to generate Excel export",details:r.message},500)}});w.post("/api/import/excel",async e=>{const{env:t}=e;try{const r=await e.req.json(),{data:a,mappings:s,company_id:n,user_id:c=1}=r;if(!a||!Array.isArray(a)||!s)return e.json({error:"Data and column mappings are required"},400);const o={total:a.length,imported:0,errors:[],skipped:0};for(let d=0;d<a.length;d++){const l=a[d];try{const f={company_id:n||Y(l,s.company_id),expense_type_id:Y(l,s.expense_type_id)||10,description:Y(l,s.description)||"Importado desde Excel",expense_date:Y(l,s.expense_date)||new Date().toISOString().split("T")[0],amount:parseFloat(Y(l,s.amount))||0,currency:Y(l,s.currency)||"MXN",payment_method:Y(l,s.payment_method)||"cash",vendor:Y(l,s.vendor)||"",notes:Y(l,s.notes)||"Importado desde Excel",status:"pending",user_id:c,created_by:c};let x=1,m=f.amount;f.currency==="USD"?(x=18.25,m=f.amount*x):f.currency==="EUR"&&(x=20.15,m=f.amount*x);const h=await t.DB.prepare(`
          INSERT INTO expenses (
            company_id, user_id, expense_type_id, description, expense_date, 
            amount, currency, exchange_rate, amount_mxn, payment_method, 
            vendor, notes, status, created_by, created_at
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
        `).bind(f.company_id,f.user_id,f.expense_type_id,f.description,f.expense_date,f.amount,f.currency,x,m,f.payment_method,f.vendor,f.notes,f.status,f.created_by).run();o.imported++}catch(f){o.errors.push({row:d+1,error:f.message,data:l})}}return e.json({success:!0,results:o,message:`Importación completada: ${o.imported} gastos importados, ${o.errors.length} errores`})}catch(r){return e.json({error:"Failed to import Excel data",details:r.message},500)}});function Y(e,t){return t&&e[t]||null}function ki(e,t,r,a){const s=new Date().toLocaleDateString("es-MX"),n=(t==null?void 0:t.name)||"Consolidado",c=(t==null?void 0:t.country)==="MX"?"🇲🇽":(t==null?void 0:t.country)==="ES"?"🇪🇸":"🌍";let o=`
    <!DOCTYPE html>
    <html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Reporte de Gastos - ${n}</title>
        <style>
            body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
            .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
            .logo { width: 80px; height: 80px; margin: 0 auto 10px; background: #3B82F6; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold; }
            .company-info { margin: 10px 0; }
            .filters { background: #F3F4F6; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
            .summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
            .summary-card { background: #F9FAFB; padding: 15px; border-radius: 5px; text-align: center; border: 1px solid #E5E7EB; }
            .summary-number { font-size: 24px; font-weight: bold; color: #1F2937; }
            .summary-label { font-size: 12px; color: #6B7280; margin-top: 5px; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
            th, td { padding: 10px; text-align: left; border-bottom: 1px solid #E5E7EB; }
            th { background: #F9FAFB; font-weight: bold; }
            .currency-mxn { color: #059669; }
            .currency-usd { color: #3B82F6; }
            .currency-eur { color: #8B5CF6; }
            .status-pending { background: #FEF3C7; color: #92400E; padding: 2px 6px; border-radius: 12px; font-size: 11px; }
            .status-approved { background: #D1FAE5; color: #065F46; padding: 2px 6px; border-radius: 12px; font-size: 11px; }
            .status-rejected { background: #FEE2E2; color: #991B1B; padding: 2px 6px; border-radius: 12px; font-size: 11px; }
            .status-reimbursed { background: #DBEAFE; color: #1E40AF; padding: 2px 6px; border-radius: 12px; font-size: 11px; }
            .footer { text-align: center; margin-top: 40px; font-size: 12px; color: #6B7280; border-top: 1px solid #E5E7EB; padding-top: 20px; }
            @media print { body { margin: 0; } }
        </style>
    </head>
    <body>
        <div class="header">
            <div class="logo">${n.substring(0,2).toUpperCase()}</div>
            <h1>${c} ${n}</h1>
            <h2>Reporte de Gastos y Viáticos</h2>
            <p class="company-info">Sistema Lyra Expenses • Modelo 4-D</p>
        </div>
        
        <div class="filters">
            <h3>Filtros Aplicados:</h3>
            <p><strong>Período:</strong> ${a.date_from||"Inicio"} - ${a.date_to||"Actual"}</p>
            ${a.status?`<p><strong>Estado:</strong> ${a.status}</p>`:""}
            ${a.currency?`<p><strong>Moneda:</strong> ${a.currency}</p>`:""}
            <p><strong>Fecha de generación:</strong> ${s}</p>
        </div>
  `;const d=e.reduce((m,h)=>m+parseFloat(h.amount_mxn||0),0),l=e.length,f=e.filter(m=>m.status==="pending").length,x=e.reduce((m,h)=>(m[h.currency]=(m[h.currency]||0)+parseFloat(h.amount||0),m),{});return o+=`
    <div class="summary">
        <div class="summary-card">
            <div class="summary-number">${l}</div>
            <div class="summary-label">Total Gastos</div>
        </div>
        <div class="summary-card">
            <div class="summary-number">$${d.toLocaleString("es-MX",{minimumFractionDigits:2})}</div>
            <div class="summary-label">Total MXN</div>
        </div>
        <div class="summary-card">
            <div class="summary-number">${f}</div>
            <div class="summary-label">Pendientes</div>
        </div>
        <div class="summary-card">
            <div class="summary-number">${Object.keys(x).length}</div>
            <div class="summary-label">Monedas</div>
        </div>
    </div>
  `,o+=`
    <table>
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Descripción</th>
                <th>Usuario</th>
                <th>Tipo</th>
                <th>Monto Original</th>
                <th>Monto MXN</th>
                <th>Estado</th>
                <th>Método Pago</th>
            </tr>
        </thead>
        <tbody>
  `,e.forEach(m=>{o+=`
      <tr>
          <td>${new Date(m.expense_date).toLocaleDateString("es-MX")}</td>
          <td>${m.description}</td>
          <td>${m.user_name}</td>
          <td>${m.expense_type_name}</td>
          <td class="currency-${m.currency.toLowerCase()}">${m.currency} $${parseFloat(m.amount).toLocaleString("es-MX",{minimumFractionDigits:2})}</td>
          <td class="currency-mxn">MXN $${parseFloat(m.amount_mxn).toLocaleString("es-MX",{minimumFractionDigits:2})}</td>
          <td><span class="status-${m.status}">${Ki(m.status)}</span></td>
          <td>${Xi(m.payment_method)}</td>
      </tr>
    `}),o+=`
        </tbody>
    </table>
    
    <div class="footer">
        <p>Lyra Expenses - Sistema de Gestión de Gastos y Viáticos</p>
        <p>Modelo 4-D: Dinero • Decisión • Dirección • Disciplina</p>
        <p>Generado el ${s} • Total de registros: ${l}</p>
    </div>
    </body>
    </html>
  `,o}function Ki(e){return{pending:"Pendiente",approved:"Aprobado",rejected:"Rechazado",reimbursed:"Reembolsado",invoiced:"Facturado"}[e]||e}function Xi(e){return{cash:"Efectivo",credit_card:"Tarjeta de Crédito",debit_card:"Tarjeta de Débito",bank_transfer:"Transferencia",company_card:"Tarjeta Empresarial",petty_cash:"Caja Chica"}[e]||e}w.get("/",e=>e.render(i("div",{className:"min-h-screen",style:"background: linear-gradient(135deg, #0a0b0d 0%, #12141a 50%, #1a1d25 100%);",children:[i("nav",{className:"nav-premium border-b",style:"border-color: rgba(255, 255, 255, 0.1);",children:i("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:i("div",{className:"flex justify-between items-center py-6",children:[i("div",{className:"flex items-center space-x-6",children:[i("div",{className:"flex items-center space-x-3",children:[i("div",{className:"relative",children:[i("i",{className:"fas fa-gem text-3xl text-gold animate-pulse-gold"}),i("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full animate-ping"})]}),i("div",{children:[i("h1",{className:"nav-logo text-3xl",children:"Lyra Expenses"}),i("p",{className:"text-xs text-secondary opacity-75 font-medium",children:"Executive Financial Management"})]})]}),i("span",{className:"nav-badge",children:"Sistema 4-D Premium"})]}),i("div",{className:"flex items-center space-x-4",children:[i("div",{id:"auth-indicator",className:"mr-4"}),i("select",{id:"currency-selector",className:"form-input-premium bg-glass border-0 text-sm min-w-[140px]",children:[i("option",{value:"MXN",children:"💎 MXN (Peso)"}),i("option",{value:"USD",children:"🔹 USD (Dólar)"}),i("option",{value:"EUR",children:"🔸 EUR (Euro)"})]}),i("button",{onclick:"showExpenseForm()",className:"btn-premium btn-emerald",children:[i("i",{className:"fas fa-plus mr-2"}),"Nuevo Gasto"]}),i("a",{href:"/expenses",className:"btn-premium btn-sapphire",children:[i("i",{className:"fas fa-chart-line mr-2"}),"Analytics"]}),i("button",{id:"login-btn",onclick:"showLoginModal()",className:"btn-premium btn-gold",style:"display: none;",children:[i("i",{className:"fas fa-crown mr-2"}),"Acceso Premium"]}),i("button",{id:"logout-btn",onclick:"logout()",className:"btn-premium btn-ruby",style:"display: none;",children:[i("i",{className:"fas fa-sign-out-alt mr-2"}),"Salir"]})]})]})})}),i("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12",children:i("div",{id:"app",className:"animate-fade-scale",children:[i("div",{className:"text-center mb-12",children:[i("h2",{className:"text-4xl font-bold gradient-text-gold mb-3",children:"Dashboard Ejecutivo"}),i("p",{className:"text-secondary text-lg",children:"Visión completa de tus operaciones financieras corporativas"}),i("div",{className:"flex justify-center mt-4",children:i("div",{className:"flex items-center space-x-6 text-sm text-tertiary",children:[i("span",{className:"flex items-center",children:[i("div",{className:"w-2 h-2 bg-emerald rounded-full mr-2 animate-pulse"}),"Sistema en línea"]}),i("span",{className:"flex items-center",children:[i("div",{className:"w-2 h-2 bg-gold rounded-full mr-2 animate-pulse"}),"Datos en tiempo real"]}),i("span",{className:"flex items-center",children:[i("div",{className:"w-2 h-2 bg-sapphire rounded-full mr-2 animate-pulse"}),"Multimoneda activa"]})]})})]}),i("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-12",children:[i("div",{className:"metric-card-premium animate-slide-up",style:"animation-delay: 0.1s",children:[i("div",{className:"flex items-center justify-between mb-4",children:[i("div",{className:"flex items-center space-x-3",children:[i("div",{className:"p-3 rounded-xl bg-glass",children:i("i",{className:"fas fa-chart-line text-emerald text-xl"})}),i("div",{children:[i("p",{className:"metric-label text-emerald",children:"Total Gastos"}),i("p",{className:"text-xs text-tertiary",children:"Este mes"})]})]}),i("div",{className:"text-right",children:i("div",{className:"status-badge-premium status-approved-premium",children:[i("i",{className:"fas fa-trending-up mr-1"}),"+12.5%"]})})]}),i("div",{className:"metric-value text-emerald",id:"total-expenses",children:"$0"}),i("div",{className:"text-xs text-tertiary mt-2",id:"total-expenses-period",children:"Actualizado hace 2 min"})]}),i("div",{className:"metric-card-premium animate-slide-up",style:"animation-delay: 0.2s",children:[i("div",{className:"flex items-center justify-between mb-4",children:[i("div",{className:"flex items-center space-x-3",children:[i("div",{className:"p-3 rounded-xl bg-glass",children:i("i",{className:"fas fa-hourglass-half text-gold text-xl animate-pulse"})}),i("div",{children:[i("p",{className:"metric-label text-gold",children:"Pendientes"}),i("p",{className:"text-xs text-tertiary",children:"Por aprobar"})]})]}),i("div",{className:"text-right",children:i("div",{className:"status-badge-premium status-pending-premium",children:[i("i",{className:"fas fa-clock mr-1"}),"Urgente"]})})]}),i("div",{className:"metric-value text-gold",id:"pending-expenses",children:"0"}),i("div",{className:"text-xs text-tertiary mt-2",children:"Revisión requerida"})]}),i("div",{className:"metric-card-premium animate-slide-up",style:"animation-delay: 0.3s",children:[i("div",{className:"flex items-center justify-between mb-4",children:[i("div",{className:"flex items-center space-x-3",children:[i("div",{className:"p-3 rounded-xl bg-glass",children:i("i",{className:"fas fa-building text-sapphire text-xl"})}),i("div",{children:[i("p",{className:"metric-label text-sapphire",children:"Empresas"}),i("p",{className:"text-xs text-tertiary",children:"MX + ES activas"})]})]}),i("div",{className:"text-right",children:i("div",{className:"flex space-x-1",children:[i("span",{className:"text-lg",children:"🇲🇽"}),i("span",{className:"text-lg",children:"🇪🇸"})]})})]}),i("div",{className:"metric-value text-sapphire",id:"companies-count",children:"0"}),i("div",{className:"text-xs text-tertiary mt-2",children:"Operaciones globales"})]}),i("div",{className:"metric-card-premium animate-slide-up",style:"animation-delay: 0.4s",children:[i("div",{className:"flex items-center justify-between mb-4",children:[i("div",{className:"flex items-center space-x-3",children:[i("div",{className:"p-3 rounded-xl bg-glass",children:i("i",{className:"fas fa-users-crown text-ruby text-xl"})}),i("div",{children:[i("p",{className:"metric-label text-ruby",children:"Usuarios"}),i("p",{className:"text-xs text-tertiary",children:"Multirol premium"})]})]}),i("div",{className:"text-right",children:i("div",{className:"flex space-x-1 text-xs text-tertiary",children:[i("span",{title:"Administradores",children:"👑"}),i("span",{title:"Editores",children:"✏️"}),i("span",{title:"Visualizadores",children:"👁️"})]})})]}),i("div",{className:"metric-value text-ruby",id:"users-count",children:"0"}),i("div",{className:"text-xs text-tertiary mt-2",children:"Accesos controlados"})]})]}),i("div",{className:"mb-12 animate-slide-up",style:"animation-delay: 0.5s",children:i("div",{className:"glass-panel p-8",children:[i("div",{className:"flex justify-between items-center mb-6",children:[i("div",{className:"flex items-center space-x-4",children:[i("div",{className:"p-3 rounded-xl bg-glass",children:i("i",{className:"fas fa-coins text-gold text-2xl"})}),i("div",{children:[i("h2",{className:"text-2xl font-bold gradient-text-gold",children:"Mercados Financieros"}),i("p",{className:"text-secondary text-sm",children:"Tipos de cambio en tiempo real"})]})]}),i("div",{className:"flex items-center space-x-4",children:[i("span",{className:"text-xs text-tertiary",id:"exchange-rates-updated",children:[i("i",{className:"fas fa-clock mr-1 text-gold"}),"Actualizado: --"]}),i("button",{onclick:"refreshExchangeRates()",className:"btn-premium btn-gold text-sm",children:[i("i",{className:"fas fa-sync-alt mr-2"}),"Actualizar Tasas"]})]})]}),i("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",id:"exchange-rates-container",children:[i("div",{className:"exchange-rate-card-premium group",children:[i("div",{className:"flex items-center justify-between mb-4",children:[i("div",{className:"flex items-center space-x-3",children:[i("div",{className:"currency-flag text-3xl",children:"🇺🇸"}),i("div",{children:[i("p",{className:"text-emerald font-semibold",children:"USD → MXN"}),i("p",{className:"text-xs text-tertiary",children:"Dólar Americano"})]})]}),i("div",{className:"p-2 rounded-lg bg-glass group-hover:bg-glass-hover transition-all",children:i("i",{className:"fas fa-arrow-trend-up text-emerald"})})]}),i("div",{className:"text-right",children:[i("div",{className:"exchange-rate-value text-emerald text-2xl mb-1",id:"rate-usd-mxn",children:"$18.25"}),i("div",{className:"metric-change rate-positive text-xs",id:"change-usd-mxn",children:"+0.15 (0.8%)"})]}),i("div",{className:"mt-4 pt-4 border-t border-glass-border",children:i("div",{className:"flex justify-between text-xs text-tertiary",children:[i("span",{children:"24h Vol: $2.1M"}),i("span",{children:"Volatilidad: Baja"})]})})]}),i("div",{className:"exchange-rate-card-premium group",children:[i("div",{className:"flex items-center justify-between mb-4",children:[i("div",{className:"flex items-center space-x-3",children:[i("div",{className:"currency-flag text-3xl",children:"🇪🇺"}),i("div",{children:[i("p",{className:"text-sapphire font-semibold",children:"EUR → MXN"}),i("p",{className:"text-xs text-tertiary",children:"Euro Europeo"})]})]}),i("div",{className:"p-2 rounded-lg bg-glass group-hover:bg-glass-hover transition-all",children:i("i",{className:"fas fa-arrow-trend-down text-ruby"})})]}),i("div",{className:"text-right",children:[i("div",{className:"exchange-rate-value text-sapphire text-2xl mb-1",id:"rate-eur-mxn",children:"$20.15"}),i("div",{className:"metric-change rate-negative text-xs",id:"change-eur-mxn",children:"-0.25 (1.2%)"})]}),i("div",{className:"mt-4 pt-4 border-t border-glass-border",children:i("div",{className:"flex justify-between text-xs text-tertiary",children:[i("span",{children:"24h Vol: $1.8M"}),i("span",{children:"Volatilidad: Media"})]})})]}),i("div",{className:"exchange-rate-card-premium group",children:[i("div",{className:"flex items-center justify-between mb-4",children:[i("div",{className:"flex items-center space-x-3",children:[i("div",{className:"currency-flag text-3xl",children:"💎"}),i("div",{children:[i("p",{className:"text-gold font-semibold",children:"USD → EUR"}),i("p",{className:"text-xs text-tertiary",children:"Par Cruzado"})]})]}),i("div",{className:"p-2 rounded-lg bg-glass group-hover:bg-glass-hover transition-all",children:i("i",{className:"fas fa-arrow-trend-up text-emerald"})})]}),i("div",{className:"text-right",children:[i("div",{className:"exchange-rate-value text-gold text-2xl mb-1",id:"rate-usd-eur",children:"€0.91"}),i("div",{className:"metric-change rate-positive text-xs",id:"change-usd-eur",children:"+0.02 (2.1%)"})]}),i("div",{className:"mt-4 pt-4 border-t border-glass-border",children:i("div",{className:"flex justify-between text-xs text-tertiary",children:[i("span",{children:"24h Vol: $3.2M"}),i("span",{children:"Volatilidad: Alta"})]})})]})]}),i("div",{className:"mt-8 pt-6 border-t border-glass-border",children:i("div",{className:"flex items-center justify-between",children:[i("div",{className:"flex items-center space-x-6 text-sm text-tertiary",children:[i("span",{className:"flex items-center",children:[i("i",{className:"fas fa-shield-check mr-2 text-emerald"}),"Datos certificados Banxico / BCE"]}),i("span",{className:"flex items-center",children:[i("i",{className:"fas fa-clock mr-2 text-gold"}),"Actualización cada 30 segundos"]}),i("span",{className:"flex items-center",children:[i("i",{className:"fas fa-globe mr-2 text-sapphire"}),"Mercados globales 24/7"]})]}),i("div",{className:"flex items-center space-x-3",children:[i("div",{className:"status-badge-premium status-approved-premium",children:[i("i",{className:"fas fa-wifi mr-1"}),"Conectado"]}),i("div",{className:"flex items-center text-xs text-emerald",children:[i("div",{className:"w-2 h-2 bg-emerald rounded-full mr-2 animate-pulse"}),"Mercados abiertos"]})]})]})})]})}),i("div",{className:"mb-12 animate-slide-up",style:"animation-delay: 0.6s",children:[i("div",{className:"flex justify-between items-center mb-8",children:[i("div",{className:"flex items-center space-x-4",children:[i("div",{className:"p-3 rounded-xl bg-glass",children:i("i",{className:"fas fa-building-columns text-sapphire text-2xl"})}),i("div",{children:[i("h2",{className:"text-2xl font-bold gradient-text-gold",children:"Portfolio Corporativo"}),i("p",{className:"text-secondary text-sm",children:"Gestión multiempresa internacional"})]})]}),i("button",{onclick:"toggleCompanyView()",className:"btn-premium btn-sapphire text-sm",children:[i("i",{className:"fas fa-expand mr-2"}),"Vista Analítica"]})]}),i("div",{id:"companies-mosaic",className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"})]}),i("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12 animate-slide-up",style:"animation-delay: 0.7s",children:[i("div",{className:"glass-panel p-8",children:[i("div",{className:"flex justify-between items-center mb-6",children:[i("div",{className:"flex items-center space-x-3",children:[i("div",{className:"p-2 rounded-lg bg-glass",children:i("i",{className:"fas fa-chart-pie text-emerald text-xl"})}),i("div",{children:[i("h3",{className:"text-xl font-bold text-primary",children:"Performance Empresarial"}),i("p",{className:"text-xs text-tertiary",children:"Análisis comparativo de gastos"})]})]}),i("select",{id:"period-selector",className:"form-input-premium text-sm bg-glass border-0 min-w-[120px]",children:[i("option",{value:"month",children:"Este Mes"}),i("option",{value:"quarter",children:"Trimestre"}),i("option",{value:"year",children:"Este Año"})]})]}),i("div",{id:"company-chart",className:"h-64 rounded-lg bg-glass p-4"}),i("div",{className:"mt-4 flex items-center justify-between text-xs text-tertiary",children:[i("span",{className:"flex items-center",children:[i("div",{className:"w-2 h-2 bg-emerald rounded-full mr-2"}),"Datos actualizados"]}),i("span",{children:"Período fiscal 2024"})]})]}),i("div",{className:"glass-panel p-8",children:[i("div",{className:"flex justify-between items-center mb-6",children:[i("div",{className:"flex items-center space-x-3",children:[i("div",{className:"p-2 rounded-lg bg-glass",children:i("i",{className:"fas fa-globe-americas text-gold text-xl"})}),i("div",{children:[i("h3",{className:"text-xl font-bold text-primary",children:"Exposición Multimoneda"}),i("p",{className:"text-xs text-tertiary",children:"Distribución por divisa en tiempo real"})]})]}),i("div",{className:"flex items-center space-x-2 text-xs text-tertiary",children:[i("div",{className:"w-2 h-2 bg-gold rounded-full animate-pulse"}),i("span",{children:"Tasas live"})]})]}),i("div",{id:"currency-chart",className:"h-64 rounded-lg bg-glass p-4"}),i("div",{className:"mt-4 flex items-center justify-between text-xs text-tertiary",children:[i("div",{className:"flex items-center space-x-4",children:[i("span",{className:"flex items-center",children:[i("span",{className:"text-emerald mr-1",children:"🇲🇽"})," MXN"]}),i("span",{className:"flex items-center",children:[i("span",{className:"text-sapphire mr-1",children:"🇺🇸"})," USD"]}),i("span",{className:"flex items-center",children:[i("span",{className:"text-gold mr-1",children:"🇪🇺"})," EUR"]})]}),i("span",{children:"Conversión automática"})]})]})]}),i("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8",children:[i("div",{className:"bg-white rounded-lg shadow-sm border",children:[i("div",{className:"px-6 py-4 border-b",children:i("h3",{className:"text-lg font-semibold text-gray-900",children:[i("i",{className:"fas fa-receipt mr-2 text-orange-600"}),"Actividad Reciente"]})}),i("div",{className:"p-6",children:i("div",{id:"recent-activity",className:"space-y-4"})})]}),i("div",{className:"bg-white rounded-lg shadow-sm border",children:[i("div",{className:"px-6 py-4 border-b",children:i("h3",{className:"text-lg font-semibold text-gray-900",children:[i("i",{className:"fas fa-exclamation-triangle mr-2 text-yellow-600"}),"Acciones Requeridas"]})}),i("div",{className:"p-6",children:i("div",{id:"pending-actions",className:"space-y-4"})})]})]}),i("div",{className:"bg-white rounded-lg shadow-sm border",children:[i("div",{className:"px-6 py-4 border-b",children:i("div",{className:"flex justify-between items-center",children:[i("h3",{className:"text-lg font-semibold text-gray-900",children:[i("i",{className:"fas fa-table mr-2 text-gray-600"}),"Últimos Gastos Registrados"]}),i("a",{href:"/expenses",className:"text-blue-600 hover:text-blue-800 text-sm",children:"Ver todos los gastos →"})]})}),i("div",{className:"overflow-x-auto",children:i("table",{className:"min-w-full divide-y divide-gray-200",children:[i("thead",{className:"bg-gray-50",children:i("tr",{children:[i("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Descripción"}),i("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Empresa"}),i("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Usuario"}),i("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Monto"}),i("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Estado"}),i("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Fecha"}),i("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Adjuntos"})]})}),i("tbody",{id:"recent-expenses-table",className:"bg-white divide-y divide-gray-200",children:i("tr",{children:i("td",{colspan:"7",className:"px-6 py-4 text-center text-gray-500",children:[i("i",{className:"fas fa-spinner fa-spin mr-2"}),"Cargando gastos recientes..."]})})})]})})]})]})})]})));w.get("/expenses",e=>e.render(i("div",{className:"min-h-screen bg-gray-100",children:[i("div",{className:"bg-white shadow-sm border-b",children:i("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:i("div",{className:"flex justify-between items-center py-6",children:[i("div",{className:"flex items-center space-x-4",children:[i("a",{href:"/",className:"text-blue-600 hover:text-blue-700",children:i("i",{className:"fas fa-arrow-left"})}),i("h1",{className:"text-2xl font-bold text-gray-900",children:"Gestión de Gastos"})]}),i("div",{className:"flex items-center space-x-4",children:[i("button",{className:"bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700",onclick:"showExpenseForm()",children:[i("i",{className:"fas fa-plus mr-2"}),"Registrar Gasto"]}),i("button",{className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700",onclick:"showImportExcel()",children:[i("i",{className:"fas fa-file-excel mr-2"}),"Importar Excel"]})]})]})})}),i("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[i("div",{className:"bg-white p-6 rounded-lg shadow-sm border mb-6",children:[i("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Filtros Avanzados"}),i("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[i("div",{children:[i("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Empresa"}),i("select",{id:"filter-company",className:"w-full border border-gray-300 rounded-lg px-3 py-2",children:i("option",{value:"",children:"Todas las empresas"})})]}),i("div",{children:[i("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Usuario"}),i("select",{id:"filter-user",className:"w-full border border-gray-300 rounded-lg px-3 py-2",children:i("option",{value:"",children:"Todos los usuarios"})})]}),i("div",{children:[i("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Estado"}),i("select",{id:"filter-status",className:"w-full border border-gray-300 rounded-lg px-3 py-2",children:[i("option",{value:"",children:"Todos los estados"}),i("option",{value:"pending",children:"Pendiente"}),i("option",{value:"approved",children:"Aprobado"}),i("option",{value:"rejected",children:"Rechazado"}),i("option",{value:"reimbursed",children:"Reembolsado"}),i("option",{value:"invoiced",children:"Facturado"})]})]}),i("div",{children:[i("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Moneda"}),i("select",{id:"filter-currency",className:"w-full border border-gray-300 rounded-lg px-3 py-2",children:[i("option",{value:"",children:"Todas las monedas"}),i("option",{value:"MXN",children:"🇲🇽 MXN"}),i("option",{value:"USD",children:"🇺🇸 USD"}),i("option",{value:"EUR",children:"🇪🇺 EUR"})]})]}),i("div",{children:[i("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Tipo de Gasto"}),i("select",{id:"filter-expense-type",className:"w-full border border-gray-300 rounded-lg px-3 py-2",children:i("option",{value:"",children:"Todos los tipos"})})]}),i("div",{children:[i("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Fecha Desde"}),i("input",{type:"date",id:"filter-date-from",className:"w-full border border-gray-300 rounded-lg px-3 py-2"})]}),i("div",{children:[i("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Fecha Hasta"}),i("input",{type:"date",id:"filter-date-to",className:"w-full border border-gray-300 rounded-lg px-3 py-2"})]}),i("div",{children:[i("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Método de Pago"}),i("select",{id:"filter-payment-method",className:"w-full border border-gray-300 rounded-lg px-3 py-2",children:[i("option",{value:"",children:"Todos los métodos"}),i("option",{value:"cash",children:"Efectivo"}),i("option",{value:"credit_card",children:"Tarjeta de Crédito"}),i("option",{value:"debit_card",children:"Tarjeta de Débito"}),i("option",{value:"bank_transfer",children:"Transferencia"}),i("option",{value:"company_card",children:"Tarjeta Empresarial"}),i("option",{value:"petty_cash",children:"Caja Chica"})]})]})]}),i("div",{className:"flex space-x-4 mt-4",children:[i("button",{onclick:"applyFilters()",className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700",children:[i("i",{className:"fas fa-search mr-2"}),"Aplicar Filtros"]}),i("button",{onclick:"clearFilters()",className:"bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700",children:[i("i",{className:"fas fa-times mr-2"}),"Limpiar"]}),i("button",{onclick:"exportFiltered('pdf')",className:"bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700",children:[i("i",{className:"fas fa-file-pdf mr-2"}),"Exportar PDF"]}),i("button",{onclick:"exportFiltered('excel')",className:"bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700",children:[i("i",{className:"fas fa-file-excel mr-2"}),"Exportar Excel"]})]})]}),i("div",{className:"bg-white rounded-lg shadow-sm border",children:[i("div",{className:"px-6 py-4 border-b",children:i("div",{className:"flex justify-between items-center",children:[i("h3",{className:"text-lg font-semibold text-gray-900",children:"Lista de Gastos y Viáticos"}),i("div",{className:"flex space-x-2",children:[i("span",{id:"expenses-count",className:"text-sm text-gray-500",children:"0 gastos"}),i("span",{id:"expenses-total",className:"text-sm font-semibold text-gray-900",children:"$0.00"})]})]})}),i("div",{className:"overflow-x-auto",children:i("table",{className:"min-w-full divide-y divide-gray-200",children:[i("thead",{className:"bg-gray-50",children:i("tr",{children:[i("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:[i("input",{type:"checkbox",id:"select-all",className:"mr-2",onclick:"toggleSelectAll()"}),"ID"]}),i("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Descripción"}),i("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Empresa"}),i("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Usuario"}),i("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Monto Original"}),i("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Monto MXN"}),i("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Estado"}),i("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Fecha"}),i("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Adjuntos"}),i("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Acciones"})]})}),i("tbody",{id:"expenses-table",className:"bg-white divide-y divide-gray-200",children:i("tr",{children:i("td",{colspan:"10",className:"px-6 py-4 text-center text-gray-500",children:"Cargando gastos..."})})})]})})]})]}),i("div",{id:"expense-modal",className:"fixed inset-0 z-50 hidden",children:[i("div",{className:"fixed inset-0 bg-black bg-opacity-50",onclick:"closeExpenseForm()"}),i("div",{className:"fixed inset-0 overflow-y-auto",children:i("div",{className:"flex min-h-full items-center justify-center p-4",children:i("div",{className:"bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:[i("div",{className:"px-6 py-4 border-b border-gray-200",children:[i("div",{className:"flex items-center justify-between",children:[i("h3",{className:"text-lg font-semibold text-gray-900",children:[i("i",{className:"fas fa-plus-circle mr-2 text-green-600"}),"Registrar Nuevo Gasto o Viático"]}),i("button",{onclick:"closeExpenseForm()",className:"text-gray-400 hover:text-gray-600",children:i("i",{className:"fas fa-times text-xl"})})]}),i("p",{className:"text-sm text-gray-500 mt-1",children:"Complete todos los campos requeridos. Los campos marcados con * son obligatorios."})]}),i("form",{id:"expense-form",className:"px-6 py-4",children:[i("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[i("div",{className:"space-y-4",children:[i("h4",{className:"font-semibold text-gray-900 border-b pb-2",children:"📋 Información Básica"}),i("div",{children:[i("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Empresa * ",i("i",{className:"fas fa-building ml-1 text-blue-500"})]}),i("select",{id:"form-company",required:!0,className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:i("option",{value:"",children:"Seleccione una empresa..."})})]}),i("div",{children:[i("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Tipo de Gasto * ",i("i",{className:"fas fa-tags ml-1 text-purple-500"})]}),i("select",{id:"form-expense-type",required:!0,className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:i("option",{value:"",children:"Seleccione tipo de gasto..."})})]}),i("div",{children:[i("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Descripción * ",i("i",{className:"fas fa-edit ml-1 text-green-500"})]}),i("textarea",{id:"form-description",required:!0,rows:"3",placeholder:"Ej: Comida con cliente - Proyecto Alpha",className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),i("div",{children:[i("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Fecha del Gasto * ",i("i",{className:"fas fa-calendar ml-1 text-red-500"})]}),i("input",{type:"date",id:"form-expense-date",required:!0,className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),i("div",{children:[i("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Responsable ",i("i",{className:"fas fa-user ml-1 text-indigo-500"})]}),i("select",{id:"form-responsible",className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:i("option",{value:"",children:"Yo (usuario actual)"})})]}),i("div",{children:[i("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Integrantes ",i("i",{className:"fas fa-users ml-1 text-orange-500"})]}),i("textarea",{id:"form-attendees",rows:"2",placeholder:"Ej: María López, Carlos Martínez (opcional)",className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]})]}),i("div",{className:"space-y-4",children:[i("h4",{className:"font-semibold text-gray-900 border-b pb-2",children:"💰 Información Financiera"}),i("div",{className:"grid grid-cols-2 gap-3",children:[i("div",{children:[i("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Monto * ",i("i",{className:"fas fa-dollar-sign ml-1 text-green-600"})]}),i("input",{type:"number",step:"0.01",id:"form-amount",required:!0,placeholder:"0.00",className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),i("div",{children:[i("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Moneda * ",i("i",{className:"fas fa-coins ml-1 text-yellow-600"})]}),i("select",{id:"form-currency",required:!0,className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500",onchange:"updateExchangeRate()",children:[i("option",{value:"",children:"Seleccionar..."}),i("option",{value:"MXN",children:"🇲🇽 MXN"}),i("option",{value:"USD",children:"🇺🇸 USD"}),i("option",{value:"EUR",children:"🇪🇺 EUR"})]})]})]}),i("div",{id:"exchange-rate-section",className:"hidden",children:[i("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Tipo de Cambio ",i("i",{className:"fas fa-exchange-alt ml-1 text-blue-600"})]}),i("div",{className:"flex items-center space-x-2",children:[i("input",{type:"number",step:"0.000001",id:"form-exchange-rate",readonly:!0,className:"flex-1 border border-gray-300 rounded-lg px-3 py-2 bg-gray-50"}),i("button",{type:"button",onclick:"refreshExchangeRate()",className:"px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:i("i",{className:"fas fa-sync-alt"})})]}),i("p",{id:"exchange-rate-info",className:"text-xs text-gray-500 mt-1"})]}),i("div",{children:[i("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Método de Pago * ",i("i",{className:"fas fa-credit-card ml-1 text-purple-600"})]}),i("select",{id:"form-payment-method",required:!0,className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[i("option",{value:"",children:"Seleccione método..."}),i("option",{value:"cash",children:"💵 Efectivo"}),i("option",{value:"credit_card",children:"💳 Tarjeta de Crédito"}),i("option",{value:"debit_card",children:"💳 Tarjeta de Débito"}),i("option",{value:"bank_transfer",children:"🏦 Transferencia Bancaria"}),i("option",{value:"company_card",children:"🏢 Tarjeta Empresarial"}),i("option",{value:"petty_cash",children:"🪙 Caja Chica"})]})]}),i("div",{children:[i("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Proveedor/Establecimiento ",i("i",{className:"fas fa-store ml-1 text-teal-500"})]}),i("input",{type:"text",id:"form-vendor",placeholder:"Ej: Restaurante Pujol, Uber, Adobe Inc",className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),i("div",{children:[i("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Número de Factura/Folio ",i("i",{className:"fas fa-receipt ml-1 text-gray-600"})]}),i("input",{type:"text",id:"form-invoice-number",placeholder:"Ej: A123456789",className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),i("div",{children:[i("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Estado Inicial ",i("i",{className:"fas fa-flag ml-1 text-yellow-500"})]}),i("select",{id:"form-status",className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[i("option",{value:"pending",children:"⏳ Pendiente"}),i("option",{value:"approved",children:"✅ Aprobado"})]})]}),i("div",{className:"flex items-center space-x-2",children:[i("input",{type:"checkbox",id:"form-billable",className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),i("label",{for:"form-billable",className:"text-sm font-medium text-gray-700",children:[i("i",{className:"fas fa-file-invoice-dollar mr-1 text-green-600"}),"Gasto Facturable al Cliente"]})]})]})]}),i("div",{className:"mt-6",children:[i("h4",{className:"font-semibold text-gray-900 border-b pb-2 mb-4",children:"📝 Información Adicional"}),i("div",{children:[i("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Notas y Comentarios ",i("i",{className:"fas fa-sticky-note ml-1 text-yellow-500"})]}),i("textarea",{id:"form-notes",rows:"3",placeholder:"Información adicional, contexto del gasto, observaciones...",className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]})]}),i("div",{className:"mt-6",children:[i("h4",{className:"font-semibold text-gray-900 border-b pb-2 mb-4",children:"📎 Archivos Adjuntos con OCR Inteligente"}),i("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4",children:[i("div",{className:"flex items-center space-x-3",children:[i("input",{type:"checkbox",id:"enable-ocr",checked:!0,className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),i("label",{for:"enable-ocr",className:"text-sm font-medium text-blue-900",children:[i("i",{className:"fas fa-robot mr-1"}),"Activar OCR - Extracción Automática de Datos"]})]}),i("p",{className:"text-xs text-blue-700 mt-1 ml-6",children:"El sistema extraerá automáticamente: monto, fecha, proveedor, y método de pago desde tickets y facturas"})]}),i("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors",ondrop:"handleFileDrop(event)",ondragover:"handleDragOver(event)",ondragleave:"handleDragLeave(event)",children:[i("i",{className:"fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"}),i("p",{className:"text-gray-600 mb-2",children:[i("strong",{children:"Arrastra archivos aquí"})," o haz clic para seleccionar"]}),i("p",{className:"text-sm text-gray-500 mb-3",children:"📸 Tickets • 📄 Facturas PDF/XML • 🖼️ Fotografías (Max: 10MB por archivo)"}),i("div",{className:"flex justify-center space-x-3",children:[i("input",{type:"file",id:"form-attachments",multiple:!0,accept:".pdf,.xml,.jpg,.jpeg,.png,.gif",className:"hidden",onchange:"handleFileSelect(event)"}),i("button",{type:"button",onclick:"document.getElementById('form-attachments').click()",className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:[i("i",{className:"fas fa-paperclip mr-2"}),"Seleccionar Archivos"]}),i("button",{type:"button",onclick:"captureFromCamera()",className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 md:hidden min-h-12",children:[i("i",{className:"fas fa-camera mr-2"}),"📸 Tomar Foto"]}),i("button",{type:"button",onclick:"captureLocationForExpense()",className:"px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 md:hidden min-h-12",children:[i("i",{className:"fas fa-map-marker-alt mr-2"}),"📍 Ubicación"]})]}),i("input",{type:"file",id:"camera-capture",accept:"image/*",capture:"environment",className:"hidden",onchange:"handleCameraCapture(event)"})]}),i("div",{id:"ocr-status",className:"mt-3 hidden",children:i("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:i("div",{className:"flex items-center",children:[i("i",{className:"fas fa-cog fa-spin text-yellow-600 mr-2"}),i("span",{class:"text-yellow-800",children:"Procesando OCR..."})]})})}),i("div",{id:"attachments-preview",className:"mt-4 hidden",children:[i("h5",{className:"font-medium text-gray-900 mb-2",children:"Archivos y Datos Extraídos:"}),i("div",{id:"attachments-list",className:"space-y-2"})]}),i("div",{id:"ocr-results",className:"mt-4 hidden",children:[i("h5",{className:"font-medium text-gray-900 mb-2",children:[i("i",{className:"fas fa-magic mr-1 text-purple-600"}),"Datos Extraídos Automáticamente:"]}),i("div",{id:"ocr-data-preview",className:"bg-green-50 border border-green-200 rounded-lg p-4"}),i("div",{className:"flex space-x-2 mt-2",children:[i("button",{type:"button",onclick:"applyOcrData()",className:"text-sm px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700",children:[i("i",{className:"fas fa-check mr-1"}),"Aplicar Datos"]}),i("button",{type:"button",onclick:"clearOcrData()",className:"text-sm px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700",children:[i("i",{className:"fas fa-times mr-1"}),"Descartar"]})]})]})]}),i("div",{className:"mt-8 flex justify-end space-x-4 pt-6 border-t border-gray-200",children:[i("button",{type:"button",onclick:"closeExpenseForm()",className:"px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50",children:[i("i",{className:"fas fa-times mr-2"}),"Cancelar"]}),i("button",{type:"button",onclick:"saveDraft()",className:"px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700",children:[i("i",{className:"fas fa-save mr-2"}),"Guardar Borrador"]}),i("button",{type:"submit",className:"px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700",children:[i("i",{className:"fas fa-check mr-2"}),"Registrar Gasto"]})]})]})]})})})]})]})));w.get("/api/dashboard-metrics",Ut,async e=>{const{env:t}=e;try{const r=e.get("userId"),a=e.get("userRole");let s="";a!=="admin"&&(s=`
        AND e.company_id IN (
          SELECT company_id FROM user_companies WHERE user_id = ${r}
        )
      `);const n=await t.DB.prepare(`
      SELECT COUNT(*) as count, COALESCE(SUM(amount_mxn), 0) as total
      FROM expenses e
      WHERE strftime('%Y-%m', e.expense_date) = strftime('%Y-%m', 'now')
      ${s}
    `).first(),c=await t.DB.prepare(`
      SELECT COUNT(*) as count
      FROM expenses e
      WHERE e.status = 'pending'
      ${s}
    `).first(),o=await t.DB.prepare(`
      SELECT c.name as company, COUNT(e.id) as count, 
             COALESCE(SUM(e.amount_mxn), 0) as total_mxn
      FROM companies c
      LEFT JOIN expenses e ON c.id = e.company_id
      WHERE c.active = TRUE
      ${a!=="admin"?`AND c.id IN (SELECT company_id FROM user_companies WHERE user_id = ${r})`:""}
      GROUP BY c.id, c.name
      ORDER BY total_mxn DESC
    `).all(),d=await t.DB.prepare(`
      SELECT currency, COUNT(*) as count, SUM(amount) as total_original, SUM(amount_mxn) as total_mxn
      FROM expenses e
      WHERE strftime('%Y-%m', e.expense_date) = strftime('%Y-%m', 'now')
      ${s}
      GROUP BY currency
      ORDER BY total_mxn DESC
    `).all(),l=await t.DB.prepare(`
      SELECT status, COUNT(*) as count
      FROM expenses e
      WHERE 1=1 ${s}
      GROUP BY status
    `).all(),f=await t.DB.prepare(`
      SELECT e.*, c.name as company_name, u.name as user_name
      FROM expenses e
      JOIN companies c ON e.company_id = c.id
      JOIN users u ON e.user_id = u.id
      WHERE 1=1 ${s}
      ORDER BY e.created_at DESC
      LIMIT 10
    `).all();return e.json({success:!0,total_expenses:n,pending_expenses:c,company_metrics:o.results||[],currency_metrics:d.results||[],status_metrics:l.results||[],recent_expenses:f.results||[]})}catch(r){return e.json({error:"Failed to load dashboard metrics",details:r.message},500)}});const ar=new TextEncoder().encode("lyra-expenses-jwt-secret-2024-very-secure-key-change-in-production");async function os(e,t){const r=Math.floor(Date.now()/1e3),a=await new Pr({sub:e.toString(),role:t,type:"access"}).setProtectedHeader({alg:"HS256"}).setIssuedAt(r).setExpirationTime(r+900).sign(ar),s=await new Pr({sub:e.toString(),role:t,type:"refresh"}).setProtectedHeader({alg:"HS256"}).setIssuedAt(r).setExpirationTime(r+10080*60).sign(ar);return{accessToken:a,refreshToken:s}}async function ds(e,t="access"){try{const{payload:r}=await vi(e,ar);if(r.type!==t)throw new Error("Invalid token type");return r}catch{return null}}async function Ut(e,t){const r=e.req.header("Authorization");if(!r||!r.startsWith("Bearer "))return e.json({error:"Authentication required"},401);const a=r.split(" ")[1],s=await ds(a,"access");if(!s)return e.json({error:"Invalid or expired token"},401);e.set("userId",parseInt(s.sub)),e.set("userRole",s.role),await t()}w.post("/api/auth/login",async e=>{const{env:t}=e;try{const{email:r,password:a}=await e.req.json();if(!r||!a)return e.json({error:"Email and password are required"},400);const s=await t.DB.prepare("SELECT * FROM users WHERE email = ? AND active = TRUE").bind(r.toLowerCase()).first();if(!s)return e.json({error:"Invalid credentials"},401);if(!await ji.compare(a,s.password_hash))return e.json({error:"Invalid credentials"},401);const c=await os(s.id,s.role);await t.DB.prepare("UPDATE users SET last_login = CURRENT_TIMESTAMP WHERE id = ?").bind(s.id).run();const o=crypto.randomUUID();return await t.DB.prepare(`
      INSERT INTO user_sessions (id, user_id, expires_at, ip_address, user_agent) 
      VALUES (?, ?, datetime('now', '+7 days'), ?, ?)
    `).bind(o,s.id,e.req.header("CF-Connecting-IP")||e.req.header("X-Forwarded-For")||"unknown",e.req.header("User-Agent")||"unknown").run(),e.json({success:!0,user:{id:s.id,email:s.email,name:s.name,role:s.role},tokens:c,session_id:o})}catch(r){return e.json({error:"Login failed",details:r.message},500)}});w.post("/api/auth/refresh",async e=>{const{env:t}=e;try{const{refresh_token:r}=await e.req.json();if(!r)return e.json({error:"Refresh token is required"},400);const a=await ds(r,"refresh");if(!a)return e.json({error:"Invalid or expired refresh token"},401);const s=parseInt(a.sub),n=await t.DB.prepare("SELECT * FROM users WHERE id = ? AND active = TRUE").bind(s).first();if(!n)return e.json({error:"User not found or inactive"},401);const c=await os(n.id,n.role);return e.json({success:!0,tokens:c})}catch(r){return e.json({error:"Token refresh failed",details:r.message},500)}});w.post("/api/auth/logout",Ut,async e=>{const{env:t}=e;try{const{session_id:r}=await e.req.json(),a=e.get("userId");return r?await t.DB.prepare("DELETE FROM user_sessions WHERE id = ? AND user_id = ?").bind(r,a).run():await t.DB.prepare("DELETE FROM user_sessions WHERE user_id = ?").bind(a).run(),e.json({success:!0,message:"Logged out successfully"})}catch(r){return e.json({error:"Logout failed",details:r.message},500)}});w.get("/api/auth/profile",Ut,async e=>{const{env:t}=e;try{const r=e.get("userId"),a=await t.DB.prepare(`
      SELECT u.*, 
             GROUP_CONCAT(DISTINCT c.id || ':' || c.name) as companies
      FROM users u
      LEFT JOIN user_companies uc ON u.id = uc.user_id
      LEFT JOIN companies c ON uc.company_id = c.id
      WHERE u.id = ? AND u.active = TRUE
      GROUP BY u.id
    `).bind(r).first();if(!a)return e.json({error:"User not found"},404);const s=a.companies?a.companies.split(",").map(n=>{const[c,o]=n.split(":");return{id:parseInt(c),name:o}}):[];return e.json({success:!0,user:{id:a.id,email:a.email,name:a.name,role:a.role,companies:s,last_login:a.last_login,created_at:a.created_at}})}catch(r){return e.json({error:"Failed to get profile",details:r.message},500)}});w.get("/api/auth/companies",Ut,async e=>{const{env:t}=e;try{const r=e.get("userId"),a=e.get("userRole");let s;return a==="admin"?s=await t.DB.prepare("SELECT * FROM companies WHERE active = TRUE").all():s=await t.DB.prepare(`
        SELECT c.* 
        FROM companies c
        JOIN user_companies uc ON c.id = uc.company_id
        WHERE uc.user_id = ? AND c.active = TRUE
      `).bind(r).all(),e.json({success:!0,companies:s.results})}catch(r){return e.json({error:"Failed to get companies",details:r.message},500)}});const kr=new _a,Wi=Object.assign({"/src/index.tsx":w});let ls=!1;for(const[,e]of Object.entries(Wi))e&&(kr.all("*",t=>{let r;try{r=t.executionCtx}catch{}return e.fetch(t.req.raw,t.env,r)}),kr.notFound(t=>{let r;try{r=t.executionCtx}catch{}return e.fetch(t.req.raw,t.env,r)}),ls=!0);if(!ls)throw new Error("Can't import modules from ['/src/index.ts','/src/index.tsx','/app/server.ts']");export{kr as default};
