<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NUCLEAR Expenses - 100% Functional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #0a0b0d; color: white; }
        .card { background: rgba(26, 29, 37, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; }
        .btn { padding: 10px 20px; border-radius: 8px; cursor: pointer; border: none; font-weight: 500; }
        .btn-blue { background: #3b82f6; color: white; }
        .btn-green { background: #10b981; color: white; }
        .btn-red { background: #ef4444; color: white; }
        .btn-gray { background: #6b7280; color: white; }
        .btn-gold { background: #f59e0b; color: white; }
        select, input { background: white !important; color: black !important; border: 2px solid #3b82f6; padding: 8px; border-radius: 6px; }
        table { background: rgba(26, 29, 37, 0.6); border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid rgba(255, 255, 255, 0.1); padding: 12px; text-align: left; }
        th { background: rgba(59, 130, 246, 0.2); color: #f59e0b; font-weight: 600; }
        tr:hover { background: rgba(255, 255, 255, 0.05); }
        .gold { color: #f59e0b; }
        .green { color: #10b981; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; }
        .modal-content { background: #1a1d25; border-radius: 12px; padding: 30px; margin: 50px auto; max-width: 600px; border: 2px solid #f59e0b; }
    </style>
</head>
<body>
    <div class="container mx-auto p-6">
        <!-- HEADER -->
        <div class="card mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold gold">
                        <i class="fas fa-receipt mr-3"></i>
                        NUCLEAR Gestión de Gastos
                    </h1>
                    <p class="text-gray-400 mt-2">Sistema 100% funcional sin dependencias complejas</p>
                </div>
                <div class="flex gap-4">
                    <button onclick="showAddExpenseModal()" class="btn btn-green">
                        <i class="fas fa-plus mr-2"></i>
                        AGREGAR GASTO
                    </button>
                    <a href="/" class="btn btn-gray">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Dashboard
                    </a>
                </div>
            </div>
        </div>

        <!-- FILTROS BRUTALES -->
        <div class="card mb-6">
            <h3 class="text-xl font-bold gold mb-4">
                <i class="fas fa-filter mr-2"></i>
                Filtros Directos
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block mb-2 gold">🏢 Empresa</label>
                    <select id="filter-company" onchange="applyFilters()">
                        <option value="">Todas</option>
                        <option value="1">🇲🇽 TechMX Solutions</option>
                        <option value="2">🇲🇽 Innovación Digital MX</option>
                        <option value="3">🇲🇽 Consultoría Estratégica MX</option>
                        <option value="4">🇪🇸 TechES Barcelona</option>
                        <option value="5">🇪🇸 Innovación Madrid SL</option>
                        <option value="6">🇪🇸 Digital Valencia S.A.</option>
                    </select>
                </div>
                <div>
                    <label class="block mb-2 gold">👤 Usuario</label>
                    <select id="filter-user" onchange="applyFilters()">
                        <option value="">Todos</option>
                        <option value="1">👑 Alejandro (Admin)</option>
                        <option value="2">✏️ María López</option>
                        <option value="3">⭐ Carlos Martínez</option>
                        <option value="4">✏️ Ana García</option>
                        <option value="5">⭐ Pedro Sánchez</option>
                        <option value="6">✏️ Elena Torres</option>
                    </select>
                </div>
                <div>
                    <label class="block mb-2 gold">📊 Estado</label>
                    <select id="filter-status" onchange="applyFilters()">
                        <option value="">Todos</option>
                        <option value="pending">⏳ Pendiente</option>
                        <option value="approved">✅ Aprobado</option>
                        <option value="rejected">❌ Rechazado</option>
                        <option value="reimbursed">💰 Reembolsado</option>
                        <option value="invoiced">📄 Facturado</option>
                    </select>
                </div>
                <div>
                    <label class="block mb-2 gold">💰 Moneda</label>
                    <select id="filter-currency" onchange="applyFilters()">
                        <option value="">Todas</option>
                        <option value="MXN">🇲🇽 MXN</option>
                        <option value="USD">🇺🇸 USD</option>
                        <option value="EUR">🇪🇺 EUR</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="quickFilterMaria()" class="btn btn-green">
                    <i class="fas fa-user mr-2"></i>MARÍA
                </button>
                <button onclick="quickFilterPending()" class="btn btn-gold">
                    <i class="fas fa-clock mr-2"></i>PENDIENTES
                </button>
                <button onclick="clearAllFilters()" class="btn btn-red">
                    <i class="fas fa-eraser mr-2"></i>LIMPIAR
                </button>
            </div>
        </div>

        <!-- TABLA DE GASTOS -->
        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold gold">
                    <i class="fas fa-list mr-2"></i>
                    Gastos Registrados
                </h3>
                <div class="flex gap-6">
                    <div class="text-center">
                        <div id="total-count" class="text-2xl font-bold green">0</div>
                        <div class="text-sm text-gray-400">Total gastos</div>
                    </div>
                    <div class="text-center">
                        <div id="total-amount" class="text-2xl font-bold gold">$0</div>
                        <div class="text-sm text-gray-400">Monto total</div>
                    </div>
                </div>
            </div>
            
            <div style="overflow-x: auto;">
                <table id="expenses-table">
                    <thead>
                        <tr>
                            <th><i class="fas fa-hashtag gold"></i> ID</th>
                            <th><i class="fas fa-calendar gold"></i> Fecha</th>
                            <th><i class="fas fa-file-text gold"></i> Descripción</th>
                            <th><i class="fas fa-building gold"></i> Empresa</th>
                            <th><i class="fas fa-user gold"></i> Usuario</th>
                            <th><i class="fas fa-money-bill gold"></i> Monto</th>
                            <th><i class="fas fa-flag gold"></i> Estado</th>
                            <th><i class="fas fa-cogs gold"></i> Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="expenses-tbody">
                        <tr>
                            <td colspan="8" class="text-center py-8">
                                <i class="fas fa-spinner fa-spin text-2xl gold mb-2"></i><br>
                                Cargando gastos...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL AGREGAR GASTO -->
    <div id="add-expense-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold gold">
                    <i class="fas fa-plus-circle mr-2"></i>
                    Agregar Nuevo Gasto
                </h2>
                <button onclick="closeAddExpenseModal()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <form id="expense-form" onsubmit="submitExpense(event)">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block mb-2 gold">🏢 Empresa *</label>
                        <select id="new-company" required>
                            <option value="">Seleccionar...</option>
                            <option value="1">🇲🇽 TechMX Solutions</option>
                            <option value="2">🇲🇽 Innovación Digital MX</option>
                            <option value="3">🇲🇽 Consultoría Estratégica MX</option>
                            <option value="4">🇪🇸 TechES Barcelona</option>
                            <option value="5">🇪🇸 Innovación Madrid SL</option>
                            <option value="6">🇪🇸 Digital Valencia S.A.</option>
                        </select>
                    </div>
                    <div>
                        <label class="block mb-2 gold">👤 Usuario *</label>
                        <select id="new-user" required>
                            <option value="">Seleccionar...</option>
                            <option value="1">👑 Alejandro Rodríguez</option>
                            <option value="2">✏️ María López</option>
                            <option value="3">⭐ Carlos Martínez</option>
                            <option value="4">✏️ Ana García</option>
                            <option value="5">⭐ Pedro Sánchez</option>
                            <option value="6">✏️ Elena Torres</option>
                        </select>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block mb-2 gold">📝 Descripción *</label>
                    <input type="text" id="new-description" required placeholder="Ej: Comida de trabajo con cliente">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block mb-2 gold">💰 Monto *</label>
                        <input type="number" step="0.01" id="new-amount" required placeholder="0.00">
                    </div>
                    <div>
                        <label class="block mb-2 gold">💱 Moneda *</label>
                        <select id="new-currency" required>
                            <option value="">Seleccionar...</option>
                            <option value="MXN">🇲🇽 MXN</option>
                            <option value="USD">🇺🇸 USD</option>
                            <option value="EUR">🇪🇺 EUR</option>
                        </select>
                    </div>
                    <div>
                        <label class="block mb-2 gold">📅 Fecha *</label>
                        <input type="date" id="new-date" required>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button type="button" onclick="closeAddExpenseModal()" class="btn btn-gray flex-1">
                        <i class="fas fa-times mr-2"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-green flex-1">
                        <i class="fas fa-save mr-2"></i>GUARDAR GASTO
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // VARIABLES GLOBALES
        let allExpenses = [];
        let currentFilters = {};

        // CARGAR GASTOS AL INICIAR
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 NUCLEAR Expenses loaded');
            loadExpenses();
            
            // Set today's date as default
            document.getElementById('new-date').value = new Date().toISOString().split('T')[0];
        });

        // FUNCIÓN NUCLEAR PARA CARGAR GASTOS
        async function loadExpenses() {
            try {
                console.log('📊 Loading expenses...');
                const response = await fetch('/api/expenses');
                const data = await response.json();
                
                allExpenses = data.expenses || [];
                console.log(`✅ Loaded ${allExpenses.length} expenses`);
                
                renderExpenses(allExpenses);
                updateCounters(allExpenses);
                
            } catch (error) {
                console.error('❌ Error loading expenses:', error);
                document.getElementById('expenses-tbody').innerHTML = `
                    <tr><td colspan="8" class="text-center text-red-500 py-8">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Error al cargar gastos: ${error.message}
                    </td></tr>
                `;
            }
        }

        // RENDERIZAR TABLA
        function renderExpenses(expenses) {
            const tbody = document.getElementById('expenses-tbody');
            
            if (!expenses || expenses.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="8" class="text-center py-8 text-gray-400">
                        <i class="fas fa-inbox mr-2"></i>
                        No hay gastos para mostrar
                    </td></tr>
                `;
                return;
            }

            const rows = expenses.map(expense => {
                const statusColors = {
                    'pending': '⏳ <span style="color: #f59e0b;">Pendiente</span>',
                    'approved': '✅ <span style="color: #10b981;">Aprobado</span>',
                    'rejected': '❌ <span style="color: #ef4444;">Rechazado</span>',
                    'reimbursed': '💰 <span style="color: #3b82f6;">Reembolsado</span>',
                    'invoiced': '📄 <span style="color: #8b5cf6;">Facturado</span>'
                };

                return `
                    <tr>
                        <td><strong>#${expense.id}</strong></td>
                        <td>${expense.expense_date}</td>
                        <td>${expense.description}</td>
                        <td>${expense.company_name || 'N/A'}</td>
                        <td>${expense.user_name || 'N/A'}</td>
                        <td><strong>${expense.currency} $${parseFloat(expense.amount || 0).toLocaleString()}</strong></td>
                        <td>${statusColors[expense.status] || expense.status}</td>
                        <td>
                            <button onclick="editExpense(${expense.id})" class="btn-blue" style="padding: 4px 8px; margin-right: 4px;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteExpense(${expense.id})" class="btn-red" style="padding: 4px 8px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = rows;
        }

        // ACTUALIZAR CONTADORES
        function updateCounters(expenses) {
            const count = expenses.length;
            const total = expenses.reduce((sum, e) => sum + parseFloat(e.amount_mxn || 0), 0);
            
            document.getElementById('total-count').textContent = count;
            document.getElementById('total-amount').textContent = '$' + total.toLocaleString('es-MX');
        }

        // APLICAR FILTROS
        function applyFilters() {
            const company = document.getElementById('filter-company').value;
            const user = document.getElementById('filter-user').value;
            const status = document.getElementById('filter-status').value;
            const currency = document.getElementById('filter-currency').value;

            let filtered = allExpenses;

            if (company) filtered = filtered.filter(e => e.company_id == company);
            if (user) filtered = filtered.filter(e => e.user_id == user);
            if (status) filtered = filtered.filter(e => e.status === status);
            if (currency) filtered = filtered.filter(e => e.currency === currency);

            console.log(`🎯 Filtered: ${filtered.length} of ${allExpenses.length} expenses`);
            
            renderExpenses(filtered);
            updateCounters(filtered);
        }

        // FILTROS RÁPIDOS
        function quickFilterMaria() {
            document.getElementById('filter-user').value = '2';
            applyFilters();
        }

        function quickFilterPending() {
            document.getElementById('filter-status').value = 'pending';
            applyFilters();
        }

        function clearAllFilters() {
            document.getElementById('filter-company').value = '';
            document.getElementById('filter-user').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-currency').value = '';
            renderExpenses(allExpenses);
            updateCounters(allExpenses);
        }

        // MODAL FUNCTIONS
        function showAddExpenseModal() {
            document.getElementById('add-expense-modal').style.display = 'block';
        }

        function closeAddExpenseModal() {
            document.getElementById('add-expense-modal').style.display = 'none';
            document.getElementById('expense-form').reset();
        }

        // SUBMIT EXPENSE
        async function submitExpense(event) {
            event.preventDefault();
            
            const formData = {
                company_id: document.getElementById('new-company').value,
                user_id: document.getElementById('new-user').value,
                expense_type_id: 1, // Default to first type
                description: document.getElementById('new-description').value,
                amount: parseFloat(document.getElementById('new-amount').value),
                currency: document.getElementById('new-currency').value,
                expense_date: document.getElementById('new-date').value,
                payment_method: 'cash', // Default
                status: 'pending'
            };

            try {
                console.log('💾 Submitting expense:', formData);
                
                const response = await fetch('/api/expenses', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    console.log('✅ Expense created successfully');
                    closeAddExpenseModal();
                    loadExpenses(); // Reload to show new expense
                    alert('✅ Gasto agregado exitosamente!');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
            } catch (error) {
                console.error('❌ Error creating expense:', error);
                alert('❌ Error al crear gasto: ' + error.message);
            }
        }

        // PLACEHOLDER FUNCTIONS
        function editExpense(id) {
            alert(`Editar gasto #${id} - Función en desarrollo`);
        }

        function deleteExpense(id) {
            if (confirm(`¿Eliminar gasto #${id}?`)) {
                alert(`Eliminando gasto #${id} - Función en desarrollo`);
            }
        }

        console.log('🚀 NUCLEAR Expenses System Loaded - All functions active!');
    </script>
</body>
</html>